<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollectIQ - Smart Sports Card Collection Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --cupboard-black: #0a0e27;
            --cupboard-dark: #141b3d;
            --cupboard-blue: #1e90ff;
            --cupboard-gold: #ffd700;
            --cupboard-silver: #c0c0c0;
            --cupboard-bronze: #cd7f32;
            --cupboard-green: #00ff88;
            --cupboard-red: #ff3366;
            --cupboard-purple: #9333ea;
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--cupboard-black);
            color: #fff;
            min-height: 100vh;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(30, 144, 255, 0.03) 2px, rgba(30, 144, 255, 0.03) 4px),
                radial-gradient(circle at 20% 50%, rgba(30, 144, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(147, 51, 234, 0.1) 0%, transparent 50%);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--cupboard-dark) 0%, var(--cupboard-black) 100%);
            padding: 1.5rem 2rem;
            border-bottom: 3px solid var(--cupboard-blue);
            box-shadow: 0 4px 20px rgba(30, 144, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 0 10px var(--cupboard-blue));
        }

        .logo-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--cupboard-green);
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(30, 144, 255, 0.2);
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 1px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--cupboard-blue);
        }

        .nav-tab.active {
            color: var(--cupboard-blue);
            border-bottom-color: var(--cupboard-blue);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--cupboard-blue);
            box-shadow: 0 0 10px var(--cupboard-blue);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 25px rgba(255, 0, 255, 0.8), 0 0 35px rgba(0, 255, 255, 0.6);
            }
        }

        @keyframes sparkle {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(138, 43, 226, 0.6);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 40px rgba(138, 43, 226, 0.8), 0 0 50px rgba(255, 215, 0, 0.6);
                transform: scale(1.05);
            }
        }

        /* Refresh Button Hover */
        #refreshBtn:hover {
            background: rgba(0, 255, 136, 0.2) !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        }

        #refreshBtn:active {
            transform: scale(0.95);
        }

        /* Add Card Form */
        .add-card-section {
            background: var(--cupboard-dark);
            border: 2px solid rgba(30, 144, 255, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 1.5rem;
            color: var(--cupboard-gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.7);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem 1rem;
            background: rgba(30, 144, 255, 0.1);
            border: 2px solid rgba(30, 144, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group select option {
            background: var(--cupboard-dark);
            color: #fff;
            padding: 0.5rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--cupboard-blue);
            box-shadow: 0 0 15px rgba(30, 144, 255, 0.3);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple));
            border: none;
            border-radius: 6px;
            color: #fff;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 144, 255, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(30, 144, 255, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed rgba(30, 144, 255, 0.3);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload:hover {
            border-color: var(--cupboard-blue);
            background: rgba(30, 144, 255, 0.05);
        }

        .image-upload input {
            display: none;
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
        }

        /* Collection Grid */
        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .card-item {
            background: var(--cupboard-dark);
            border: 2px solid rgba(30, 144, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .card-item:hover {
            transform: translateY(-5px);
            border-color: var(--cupboard-blue);
            box-shadow: 0 10px 40px rgba(30, 144, 255, 0.4);
        }

        .delete-card-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--cupboard-red);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 10;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 51, 102, 0.5);
        }

        .card-item:hover .delete-card-btn {
            opacity: 1;
        }

        .delete-card-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .card-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(147, 51, 234, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-grade-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--cupboard-gold);
            color: var(--cupboard-black);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
        }

        .card-details {
            padding: 1.5rem;
        }

        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            color: var(--cupboard-blue);
        }

        .card-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .card-meta-row {
            display: flex;
            justify-content: space-between;
        }

        .card-price {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.6rem;
            color: var(--cupboard-green);
            margin-top: 0.5rem;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        /* Sales Feed */
        .sales-feed {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .sale-item {
            background: var(--cupboard-dark);
            border: 2px solid rgba(30, 144, 255, 0.2);
            border-left: 4px solid var(--cupboard-green);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .sale-item:hover {
            border-color: var(--cupboard-blue);
            transform: translateX(5px);
        }

        .sale-item:hover .delete-card-btn {
            opacity: 1;
        }

        .sale-info {
            flex: 1;
        }

        .sale-card-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .sale-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .sale-price {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--cupboard-green);
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .sale-platform {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(30, 144, 255, 0.2);
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Leaderboard Styles */
        .leaderboard-item {
            background: var(--cupboard-dark);
            border: 2px solid rgba(30, 144, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            border-color: var(--cupboard-blue);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.3);
        }

        .leaderboard-rank {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            min-width: 60px;
            text-align: center;
            color: var(--cupboard-gold);
        }

        .leaderboard-rank.top1 { color: #ffd700; text-shadow: 0 0 20px #ffd700; }
        .leaderboard-rank.top2 { color: #c0c0c0; text-shadow: 0 0 20px #c0c0c0; }
        .leaderboard-rank.top3 { color: #cd7f32; text-shadow: 0 0 20px #cd7f32; }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 1px;
            color: var(--cupboard-blue);
            margin-bottom: 0.5rem;
        }

        .leaderboard-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .leaderboard-stat {
            display: flex;
            flex-direction: column;
        }

        .leaderboard-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--cupboard-green);
        }

        .leaderboard-stat-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Fireworks Animation for KABOOM cards */
        .firework {
            position: fixed;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y));
                opacity: 0;
            }
        }

        .firework-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: explode 1s ease-out forwards;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 1.2rem;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(30, 144, 255, 0.2);
            border-top-color: var(--cupboard-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--cupboard-dark);
            border: 2px solid var(--cupboard-blue);
            border-radius: 12px;
            padding: 2rem;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 2px;
            color: var(--cupboard-gold);
        }

        .close-modal {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            color: var(--cupboard-red);
            transform: rotate(90deg);
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .edit-btn {
            background: linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple));
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(30, 144, 255, 0.4);
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid var(--cupboard-green);
            color: var(--cupboard-green);
        }

        .alert-error {
            background: rgba(255, 51, 102, 0.2);
            border: 2px solid var(--cupboard-red);
            color: var(--cupboard-red);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .collection-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: 0.3s;
            border-radius: 26px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--cupboard-green), #00D084);
            border-color: var(--cupboard-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-slider:hover {
            box-shadow: 0 0 10px rgba(30, 144, 255, 0.5);
        }

        /* Toast Animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Achievement Notification */
        .achievement-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 10000;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.98), rgba(40, 20, 60, 0.98));
            border: 3px solid var(--cupboard-gold);
            border-radius: 20px;
            padding: 3rem;
            min-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 100px rgba(255, 215, 0, 0.3);
            animation: achievementPopIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            text-align: center;
        }

        .achievement-notification.closing {
            animation: achievementPopOut 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
        }

        @keyframes achievementPopIn {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1) rotate(10deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes achievementPopOut {
            0% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0) rotate(180deg);
                opacity: 0;
            }
        }

        .achievement-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3), transparent);
            border-radius: 50%;
            animation: glowPulse 2s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes glowPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.5;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0.8;
            }
        }

        .achievement-icon {
            font-size: 6rem;
            margin-bottom: 1rem;
            animation: iconBounce 1s ease-in-out infinite;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
        }

        @keyframes iconBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .achievement-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--cupboard-gold);
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .achievement-unlocked {
            font-size: 1rem;
            color: var(--cupboard-green);
            font-weight: bold;
            letter-spacing: 3px;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .achievement-description {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .achievement-close {
            background: linear-gradient(135deg, var(--cupboard-gold), #FFA500);
            border: none;
            padding: 1rem 3rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            pointer-events: auto;
            position: relative;
            z-index: 10001;
        }

        .achievement-close:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        .achievement-close:active {
            transform: scale(0.95);
        }

        .achievement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            animation: fadeIn 0.3s forwards;
        }

        .achievement-overlay.closing {
            animation: fadeOut 0.3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" onclick="switchTab('dashboard'); return false;" style="text-decoration: none; cursor: pointer;">
                <div class="logo" style="display: flex; align-items: center; gap: 0.75rem;">
                    <img src="https://quinnk5.github.io/collectiq/CollectIQLogo.png" alt="CollectIQ Logo" style="height: 80px; width: auto; filter: drop-shadow(0 4px 12px rgba(138, 43, 226, 0.6)); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.08)'; this.style.filter='drop-shadow(0 6px 16px rgba(138, 43, 226, 0.8))'" onmouseout="this.style.transform='scale(1)'; this.style.filter='drop-shadow(0 4px 12px rgba(138, 43, 226, 0.6))'">
                </div>
            </a>
            <div class="header-stats" style="display: flex; align-items: center; gap: 1rem; flex: 1; justify-content: flex-end;">
                <!-- Quick Search -->
                <div style="position: relative; flex: 0 1 350px;">
                    <input type="text" id="globalSearch" placeholder="Search cards, players, sets..." 
                           style="width: 100%; padding: 0.65rem 1rem; background: rgba(255,255,255,0.05); border: 2px solid rgba(30, 144, 255, 0.3); border-radius: 25px; color: #fff; font-family: 'Outfit', sans-serif; font-size: 0.9rem; transition: all 0.3s;"
                           onfocus="this.style.background='rgba(30, 144, 255, 0.1)'; this.style.borderColor='var(--cupboard-blue)'"
                           onblur="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(30, 144, 255, 0.3)'"
                           oninput="globalSearchCards(this.value)">
                    <div id="searchResults" style="position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.5rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 12px; max-height: 400px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5);"></div>
                </div>

                <!-- Refresh Button -->
                <button id="refreshBtn" onclick="refreshCurrentView()" class="btn" title="Refresh" style="padding: 0; background: rgba(0, 255, 136, 0.1); border: 2px solid var(--cupboard-green); font-size: 1.1rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 50%;">
                    üîÑ
                </button>

                <!-- Add Card Button -->
                <button onclick="switchTab('add')" class="btn" style="padding: 0.65rem 1.25rem; background: linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple)); font-size: 0.9rem; white-space: nowrap; font-weight: 600;">
                    ‚ûï Add Card
                </button>

                <!-- User Profile Dropdown -->
                <div style="position: relative;">
                    <button id="userMenuBtn" onclick="toggleUserMenu()" class="btn" style="padding: 0.65rem 1rem; background: rgba(255,255,255,0.1); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span id="headerUsername">üë§ User</span>
                        <span style="font-size: 0.7rem;">‚ñº</span>
                    </button>
                    <div id="userMenu" style="position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 12px; min-width: 200px; display: none; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                        <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-weight: bold; color: var(--cupboard-gold);" id="menuUsername">User</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5);" id="menuEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dcb9b1bdb5b09cb9a4bdb1acb0b9f2bfb3b1">[email&#160;protected]</a></div>
                        </div>
                        <div style="padding: 0.5rem;">
                            <button onclick="switchTab('dashboard'); toggleUserMenu();" style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; border: none; color: #fff; cursor: pointer; border-radius: 6px; font-family: 'Outfit', sans-serif; transition: background 0.2s;" onmouseover="this.style.background='rgba(30, 144, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                                üìä Dashboard
                            </button>
                            <button onclick="switchTab('collection'); toggleUserMenu();" style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; border: none; color: #fff; cursor: pointer; border-radius: 6px; font-family: 'Outfit', sans-serif; transition: background 0.2s;" onmouseover="this.style.background='rgba(30, 144, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                                üì¶ My Collection
                            </button>
                            <button onclick="switchTab('scores'); toggleUserMenu();" style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; border: none; color: #fff; cursor: pointer; border-radius: 6px; font-family: 'Outfit', sans-serif; transition: background 0.2s;" onmouseover="this.style.background='rgba(30, 144, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                                ‚≠ê Collector Score
                            </button>
                            <button onclick="switchTab('leaderboard'); toggleUserMenu();" style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; border: none; color: #fff; cursor: pointer; border-radius: 6px; font-family: 'Outfit', sans-serif; transition: background 0.2s;" onmouseover="this.style.background='rgba(30, 144, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                                üèÜ Leaderboard
                            </button>
                            <button onclick="switchTab('settings'); toggleUserMenu();" style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; border: none; color: #fff; cursor: pointer; border-radius: 6px; font-family: 'Outfit', sans-serif; transition: background 0.2s;" onmouseover="this.style.background='rgba(30, 144, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                                ‚öôÔ∏è Settings
                            </button>
                        </div>
                        <div style="padding: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <button onclick="logout()" style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; border: none; color: #ff4444; cursor: pointer; border-radius: 6px; font-family: 'Outfit', sans-serif; transition: background 0.2s;" onmouseover="this.style.background='rgba(255, 68, 68, 0.2)'" onmouseout="this.style.background='transparent'">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('collection')">üì¶ My Collection</button>
            <button class="nav-tab" onclick="switchTab('scores')">‚≠ê My Collector Score</button>
            <button class="nav-tab" onclick="switchTab('sales')">üí∞ My Sales</button>
            <button class="nav-tab" onclick="switchTab('leaderboard')">üèÜ Leaderboard</button>
            <button class="nav-tab" onclick="switchTab('achievements')">üéñÔ∏è Achievements</button>
            <button class="nav-tab" onclick="switchTab('shop')">üõí Shop</button>
            <button class="nav-tab" onclick="switchTab('customize')">üé® Customize Profile</button>
            <button class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è Account Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <div class="add-card-section">
                <h2 class="section-title">üìä Collection Dashboard</h2>
                <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Your complete collection overview at a glance</p>

                <div id="dashboardLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                </div>

                <!-- Key Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Total Value -->
                    <div style="background: linear-gradient(135deg, rgba(0, 255, 127, 0.2), rgba(34, 139, 34, 0.2)); border: 2px solid rgba(0, 255, 127, 0.4); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">PORTFOLIO VALUE</div>
                        <div id="dashTotalValue" style="font-size: 3rem; color: #00FF7F; font-weight: bold; font-family: 'Bebas Neue', sans-serif;">$0</div>
                        <div id="dashValueChange" style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 0.5rem;">Total investment value</div>
                    </div>

                    <!-- Collector Score -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.2)); border: 2px solid var(--cupboard-gold); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">COLLECTOR SCORE</div>
                        <div id="dashCollectorScore" style="font-size: 3rem; color: var(--cupboard-gold); font-weight: bold; font-family: 'Bebas Neue', sans-serif;">0</div>
                        <div id="dashScoreRank" style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 0.5rem;">Global ranking</div>
                    </div>

                    <!-- Total Cards -->
                    <div style="background: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(65, 105, 225, 0.2)); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">TOTAL CARDS</div>
                        <div id="dashTotalCards" style="font-size: 3rem; color: var(--cupboard-blue); font-weight: bold; font-family: 'Bebas Neue', sans-serif;">0</div>
                        <div id="dashGradedPercent" style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 0.5rem;">0% graded</div>
                    </div>

                    <!-- Average Card Value -->
                    <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(147, 51, 234, 0.2)); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">AVG CARD VALUE</div>
                        <div id="dashAvgValue" style="font-size: 3rem; color: var(--cupboard-purple); font-weight: bold; font-family: 'Bebas Neue', sans-serif;">$0</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 0.5rem;">Per card average</div>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Top Players -->
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); margin-bottom: 1rem; letter-spacing: 1px;">üë• TOP 5 PLAYERS IN COLLECTION</h3>
                        <div id="dashTopPlayers" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Top Sets -->
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); margin-bottom: 1rem; letter-spacing: 1px;">üì¶ TOP 5 SETS IN COLLECTION</h3>
                        <div id="dashTopSets" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>

                <!-- Collection Growth Timeline -->
                <div style="background: rgba(0,0,0,0.3); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); margin-bottom: 1rem; letter-spacing: 1px;">üìà COLLECTION GROWTH TIMELINE</h3>
                    <div id="growthTimeline" style="min-height: 300px; position: relative;">
                        <!-- Timeline will be populated here -->
                    </div>
                </div>

                <!-- Collection Breakdown -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Grading Breakdown -->
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid var(--cupboard-gold); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); margin-bottom: 1rem; letter-spacing: 1px;">üèÜ GRADING BREAKDOWN</h3>
                        <div id="dashGradingBreakdown" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Card Types -->
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); margin-bottom: 1rem; letter-spacing: 1px;">‚≠ê CARD TYPES</h3>
                        <div id="dashCardTypes" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>

                <!-- Most Valuable Cards -->
                <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(0, 255, 127, 0.4); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: #00FF7F; margin-bottom: 1rem; letter-spacing: 1px;">üíé TOP 5 MOST VALUABLE CARDS</h3>
                    <div id="dashTopCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- My Collection Tab -->
        <div id="collectionTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <h2 class="section-title" style="margin: 0;">My Collection</h2>
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <!-- Archive Toggle Button -->
                    <button id="archiveToggleBtn" onclick="toggleArchive()" class="btn" style="padding: 0.6rem 1rem; background: linear-gradient(135deg, rgba(138, 43, 226, 0.3), rgba(147, 51, 234, 0.3)); border: 2px solid var(--cupboard-purple); font-size: 0.9rem; white-space: nowrap;">
                        üì¶ Archive (0)
                    </button>
                    
                    <!-- Manage Folders Button -->
                    <button onclick="showFolderManager()" class="btn" style="padding: 0.6rem 1rem; background: linear-gradient(135deg, var(--cupboard-purple), #9333ea); font-size: 0.9rem; white-space: nowrap;">
                        üìÅ Manage Folders
                    </button>
                    
                    <!-- Folder Filter -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Folder:</label>
                        <select id="folderFilter" onchange="loadCollection()" style="padding: 0.5rem 1rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-purple); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; cursor: pointer; min-width: 150px;">
                            <option value="all">All Cards</option>
                            <option value="none">üìÇ No Folder</option>
                            <!-- Folders will be populated here -->
                        </select>
                    </div>
                    
                    <!-- Search Bar -->
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="collectionSearch" 
                            placeholder="Search players..." 
                            oninput="searchCollection()"
                            style="padding: 0.6rem 1rem; padding-left: 2.5rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 250px; font-size: 0.95rem;"
                        >
                        <span style="position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; opacity: 0.5;">üîç</span>
                    </div>
                    <!-- Sort Dropdown -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Sort by:</label>
                        <select id="collectionSort" onchange="loadCollection()" style="padding: 0.5rem 1rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; cursor: pointer;">
                            <option value="score_desc">Collector Score (High to Low)</option>
                            <option value="score_asc">Collector Score (Low to High)</option>
                            <option value="date_desc">Date Added (Newest)</option>
                            <option value="date_asc">Date Added (Oldest)</option>
                            <option value="price_desc">Price (High to Low)</option>
                            <option value="price_asc">Price (Low to High)</option>
                            <option value="player_asc">Player Name (A-Z)</option>
                            <option value="player_desc">Player Name (Z-A)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="loading" id="collectionLoading">
                <div class="spinner"></div>
            </div>
            <div id="collectionGrid" class="collection-grid"></div>
        </div>

        <!-- My Collector Score Tab -->
        <div id="scoresTab" class="tab-content">
            <div class="add-card-section">
                <h2 class="section-title">‚≠ê My Collector Score Breakdown</h2>
                
                <!-- Summary Stats Card -->
                <div id="scoresSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.2)); border: 2px solid var(--cupboard-gold); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">TOTAL COLLECTOR SCORE</div>
                        <div id="totalCollectorScore" style="font-size: 3rem; color: var(--cupboard-gold); font-weight: bold; font-family: 'Bebas Neue', sans-serif;">0</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">pts</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(138, 43, 226, 0.2)); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">AVERAGE PER CARD</div>
                        <div id="avgCollectorScore" style="font-size: 3rem; color: var(--cupboard-blue); font-weight: bold; font-family: 'Bebas Neue', sans-serif;">0</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">pts</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(255, 105, 180, 0.2)); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">BEST CARD</div>
                        <div id="bestCardScore" style="font-size: 3rem; color: var(--cupboard-purple); font-weight: bold; font-family: 'Bebas Neue', sans-serif;">0</div>
                        <div id="bestCardName" style="font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">-</div>
                    </div>
                </div>

                <div id="scoresLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                </div>

                <div id="scoresContent" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple));">
                                <th style="padding: 1rem; text-align: left; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;">RANK</th>
                                <th style="padding: 1rem; text-align: left; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;">PLAYER</th>
                                <th style="padding: 1rem; text-align: left; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;">SET</th>
                                <th style="padding: 1rem; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;">RARITY</th>
                                <th style="padding: 1rem; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;">GRADE</th>
                                <th style="padding: 1rem; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;">SCORE</th>
                                <th style="padding: 1rem; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;">DETAILS</th>
                            </tr>
                        </thead>
                        <tbody id="scoresTableBody">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Card Tab -->
        <div id="addTab" class="tab-content">
            <div class="add-card-section">
                <h2 class="section-title">Add New Card to Collection</h2>

                <div id="addAlert"></div>
                <form id="addCardForm">
                    <!-- Image Upload -->
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label>Card Image *</label>
                        <div class="image-upload" id="imageUploadArea">
                            <div style="font-size: 3rem;">üì∏</div>
                            <div class="upload-text">Click to upload card image</div>
                            <div id="imagePreview" style="display: none; margin-top: 1rem;">
                                <img id="previewImg" style="max-width: 200px; border-radius: 8px;" />
                                <div style="margin-top: 0.5rem; color: var(--cupboard-green);">‚úì Image ready to upload</div>
                            </div>
                            <input type="file" id="cardImage" accept="image/*" style="display: none;" required>
                        </div>
                    </div>

                    <!-- Player & Card Info -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Sport *</label>
                            <select id="sportSelect" required>
                                <option value="">Select Sport</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Player First Name *</label>
                            <input type="text" id="playerFirstName" placeholder="e.g., Luka" required>
                        </div>
                        <div class="form-group">
                            <label>Player Last Name *</label>
                            <input type="text" id="playerLastName" placeholder="e.g., Doncic" required>
                        </div>
                    </div>

                    <!-- Set Info -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Manufacturer *</label>
                            <select id="manufacturerSelect" required>
                                <option value="">Select Manufacturer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Set Name *</label>
                            <input type="text" id="setName" placeholder="e.g., Prizm" required>
                        </div>
                        <div class="form-group">
                            <label>Year *</label>
                            <input type="number" id="setYear" placeholder="e.g., 2018" min="1900" max="2025" required>
                        </div>
                    </div>

                    <!-- Card Details -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Rarity</label>
                            <input type="text" id="cardNumber" placeholder="e.g., /10, /25, Case Hit">
                        </div>
                        <div class="form-group">
                            <label>Variant</label>
                            <input type="text" id="cardVariant" placeholder="e.g., Silver Prizm, Base">
                        </div>
                        <div class="form-group">
                            <label>Rookie Card?</label>
                            <select id="isRookie">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Autograph?</label>
                            <select id="isAutograph">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>

                    <!-- Condition & Grading -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Raw Condition</label>
                            <select id="condition">
                                <option value="">Select Condition</option>
                                <option value="Mint">Mint</option>
                                <option value="Near Mint">Near Mint</option>
                                <option value="Great">Great</option>
                                <option value="Good">Good</option>
                                <option value="Poor">Poor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Grading Company</label>
                            <select id="gradingCompany">
                                <option value="">Not Graded</option>
                                <option value="PSA">PSA</option>
                                <option value="BGS">BGS/Beckett</option>
                                <option value="SGC">SGC</option>
                                <option value="CGC">CGC</option>
                                <option value="TAG">TAG</option>
                                <option value="MGC">MGC</option>
                                <option value="ACE">ACE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Card Grade</label>
                            <input type="number" id="grade" placeholder="e.g., 9.5" step="0.5" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>‚úçÔ∏è Auto Grade (if applicable)</label>
                            <input type="number" id="autoGrade" placeholder="e.g., 10" step="0.5" min="1" max="10">
                            <small style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">For cards with separate autograph grades</small>
                        </div>
                        <div class="form-group">
                            <label>Cert Number</label>
                            <input type="text" id="certNumber" placeholder="Certification #">
                        </div>
                    </div>

                    <!-- Purchase Info -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Purchase Price *</label>
                            <input type="number" id="purchasePrice" placeholder="$0.00" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Purchase Date</label>
                            <input type="date" id="purchaseDate">
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="quantity" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>üìÅ Folder (Optional)</label>
                            <select id="cardFolder" style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-purple); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%;">
                                <option value="">No Folder</option>
                                <!-- Folders will be populated here -->
                            </select>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" placeholder="Any additional notes about this card..."></textarea>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn" onclick="clearAddCardForm()" style="min-width: 200px; font-size: 1.1rem; padding: 1rem 2rem; background: linear-gradient(135deg, #6b7280, #4b5563); border: 2px solid #9ca3af;">
                            üóëÔ∏è Clear Form
                        </button>
                        <button type="submit" class="btn" style="min-width: 300px; font-size: 1.1rem; padding: 1rem 2rem;">üíé Add to Collection</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- My Sales History Tab -->
        <div id="salesTab" class="tab-content">
            <div class="add-card-section">
                <!-- Header with Stats -->
                <div style="margin-bottom: 2rem;">
                    <h2 class="section-title" style="margin-bottom: 0.5rem;">üí∞ My Sales History</h2>
                    <p style="color: rgba(255,255,255,0.6);">Track all your card sales and analyze your performance</p>
                </div>

                <!-- Lifetime Stats Cards -->
                <div id="salesStatsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Stats will be populated here -->
                </div>

                <!-- Filters and Search -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: center;">
                    <div style="position: relative; flex: 1; min-width: 250px;">
                        <input 
                            type="text" 
                            id="salesSearch" 
                            placeholder="Search sales..." 
                            oninput="filterSales()"
                            style="width: 100%; padding: 0.6rem 1rem; padding-left: 2.5rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; font-size: 0.95rem;"
                        >
                        <span style="position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; opacity: 0.5;">üîç</span>
                    </div>
                    <select id="salesPlatformFilter" onchange="filterSales()" style="padding: 0.6rem 1rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; cursor: pointer;">
                        <option value="">All Platforms</option>
                        <option value="eBay">eBay</option>
                        <option value="PWCC">PWCC</option>
                        <option value="Goldin">Goldin</option>
                        <option value="Private Sale">Private Sale</option>
                        <option value="Card Show">Card Show</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="salesProfitFilter" onchange="filterSales()" style="padding: 0.6rem 1rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; cursor: pointer;">
                        <option value="">All Sales</option>
                        <option value="profit">Profitable Only</option>
                        <option value="loss">Losses Only</option>
                        <option value="breakeven">Break Even</option>
                    </select>
                    <button class="btn" onclick="showRecordSaleModal()" style="padding: 0.6rem 1.5rem; white-space: nowrap;">
                        üí∞ Record Sale
                    </button>
                </div>

                <!-- Sales List -->
                <div id="salesLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                </div>
                
                <div id="salesList" style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Sales will be populated here -->
                </div>

                <!-- Empty State -->
                <div id="salesEmptyState" style="display: none; text-align: center; padding: 4rem 2rem; color: rgba(255,255,255,0.5);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No sales recorded yet</div>
                    <div style="font-size: 0.9rem; margin-bottom: 2rem;">Start tracking your sales to see detailed analytics and profit/loss</div>
                    <button class="btn" onclick="showRecordSaleModal()">üí∞ Record Your First Sale</button>
                </div>
            </div>
        </div>

        <!-- Record Sale Modal -->
        <div id="recordSaleModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">üí∞ Record Sale</h3>
                    <div class="modal-actions">
                        <button class="close-modal" onclick="closeRecordSaleModal()">√ó</button>
                    </div>
                </div>
                <div id="recordSaleBody" style="padding: 1.5rem;">
                    <div id="recordSaleAlert"></div>
                    <form id="recordSaleForm">
                        <!-- Card Selection -->
                        <div class="form-group">
                            <label>Select Card from Your Collection *</label>
                            <select id="saleCardSelect" required style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%;">
                                <option value="">Choose a card...</option>
                            </select>
                        </div>

                        <!-- Sale Details -->
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label>Sale Price * üíµ</label>
                                <input type="number" id="salePrice" placeholder="0.00" step="0.01" min="0" required oninput="calculateProfit()" style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-green); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%; font-size: 1.2rem; font-weight: bold;">
                            </div>
                            <div class="form-group">
                                <label>Sale Date *</label>
                                <input type="date" id="saleDate" required style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%;">
                            </div>
                        </div>

                        <!-- Platform & Buyer -->
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label>Platform</label>
                                <select id="salePlatform" style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%;">
                                    <option value="">Select platform...</option>
                                    <option value="eBay">eBay</option>
                                    <option value="PWCC">PWCC</option>
                                    <option value="Goldin">Goldin</option>
                                    <option value="Heritage">Heritage</option>
                                    <option value="Private Sale">Private Sale</option>
                                    <option value="Card Show">Card Show</option>
                                    <option value="Instagram">Instagram</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Buyer Username (optional)</label>
                                <input type="text" id="buyerUsername" placeholder="e.g., card_king23" style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%;">
                            </div>
                        </div>

                        <!-- Costs -->
                        <div style="background: rgba(255, 107, 107, 0.1); border: 2px solid rgba(255, 107, 107, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-weight: bold; margin-bottom: 0.75rem; color: rgba(255, 107, 107, 0.9);">üí∏ Costs & Fees</div>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Shipping Cost</label>
                                    <input type="number" id="shippingCost" placeholder="0.00" step="0.01" min="0" value="0" oninput="calculateProfit()" style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid rgba(255, 107, 107, 0.3); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Fees/Commission</label>
                                    <input type="number" id="feesCommission" placeholder="0.00" step="0.01" min="0" value="0" oninput="calculateProfit()" style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid rgba(255, 107, 107, 0.3); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%;">
                                </div>
                            </div>
                        </div>

                        <!-- Profit Calculator -->
                        <div id="profitCalculator" style="background: rgba(30, 144, 255, 0.1); border: 2px solid var(--cupboard-blue); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; display: none;">
                            <div style="font-weight: bold; margin-bottom: 0.75rem; color: var(--cupboard-blue);">üìä Profit/Loss Calculation</div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.95rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.7);">Purchase Price:</span>
                                    <span id="calcPurchasePrice">$0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.7);">Sale Price:</span>
                                    <span id="calcSalePrice" style="color: var(--cupboard-green);">$0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.7);">Fees:</span>
                                    <span id="calcFees" style="color: rgba(255, 107, 107, 0.9);">-$0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.7);">Shipping:</span>
                                    <span id="calcShipping" style="color: rgba(255, 107, 107, 0.9);">-$0.00</span>
                                </div>
                                <div style="border-top: 2px solid rgba(255,255,255,0.2); margin: 0.5rem 0; padding-top: 0.5rem;"></div>
                                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold;">
                                    <span>NET PROFIT:</span>
                                    <span id="calcNetProfit" style="color: var(--cupboard-gold);">$0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                    <span style="color: rgba(255,255,255,0.7);">ROI:</span>
                                    <span id="calcROI">0%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                    <span style="color: rgba(255,255,255,0.7);">Hold Time:</span>
                                    <span id="calcHoldDays">0 days</span>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <textarea id="saleNotes" placeholder="Add any notes about this sale..." style="padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; width: 100%; min-height: 80px; resize: vertical;"></textarea>
                        </div>

                        <!-- Remove from Collection Option -->
                        <div style="background: rgba(138, 43, 226, 0.1); border: 2px solid rgba(138, 43, 226, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                <input type="checkbox" id="removeFromCollection" checked style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--cupboard-purple);">
                                <div>
                                    <div style="font-weight: bold; color: var(--cupboard-purple);">üì¶ Archive card (move to Archive tab)</div>
                                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">Card will be moved to Archive. You can restore it anytime by undoing the sale.</div>
                                </div>
                            </label>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button type="submit" class="btn" style="flex: 1;">üíæ Record Sale</button>
                            <button type="button" class="btn" onclick="closeRecordSaleModal()" style="background: rgba(255,255,255,0.1); flex: 1;">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sale Detail Modal -->
        <div id="saleDetailModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 class="modal-title">üí∞ Sale Details</h3>
                    <div class="modal-actions">
                        <button class="close-modal" onclick="closeSaleDetailModal()">√ó</button>
                    </div>
                </div>
                <div id="saleDetailBody" style="padding: 1.5rem;">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievementsTab" class="tab-content">
            <div class="add-card-section">
                <h2 class="section-title">üéñÔ∏è Achievements</h2>
                <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Track your milestones and unlock prestigious badges!</p>

                <!-- Achievement Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(212, 175, 55, 0.15)); border: 2px solid var(--cupboard-gold); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üèÜ</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-gold);" id="unlockedCount">0</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">Achievements Unlocked</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(30, 144, 255, 0.15), rgba(30, 144, 255, 0.1)); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéØ</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-blue);" id="lockedCount">0</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">Still Locked</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), rgba(147, 51, 234, 0.1)); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìä</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-purple);" id="completionRate">0%</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">Completion Rate</div>
                    </div>
                </div>

                <!-- Achievements List -->
                <div id="achievementsList" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Achievements will be populated here -->
                </div>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboardTab" class="tab-content">
            <div class="add-card-section">
                <h2 class="section-title">üèÜ Top Collectors</h2>
                <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">See how you rank against other CollectIQ users!</p>

                <!-- Join Leaderboard Banner -->
                <div id="joinLeaderboardBanner" style="display: none; background: linear-gradient(135deg, rgba(30, 144, 255, 0.15), rgba(147, 51, 234, 0.15)); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); font-size: 1.8rem; letter-spacing: 1px; margin-bottom: 1rem;">JOIN THE LEADERBOARD</h3>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 1.5rem; font-size: 1.1rem;">Compete with other collectors! Share your stats to appear on the leaderboard and showcase your collection.</p>
                    <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                        <button onclick="enableStatsSharing()" class="btn" style="background: linear-gradient(135deg, var(--cupboard-green), #00D084); font-size: 1.1rem; padding: 1rem 2rem; font-weight: bold;">
                            üöÄ JOIN LEADERBOARD
                        </button>
                        <span style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">‚ú® Show off your collection to the community!</span>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div id="leaderboardLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                </div>
                <div id="leaderboardList"></div>
            </div>
        </div>

        <!-- Shop Tab -->
        <div id="shopTab" class="tab-content">
            <div class="add-card-section">
                <h2 class="section-title">üõí Badge Shop</h2>
                <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Stand out with exclusive badges! Show them on the leaderboard and your profile.</p>

                <!-- Shop Grid -->
                <div id="shopGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                    <!-- Shop items will be loaded here -->
                </div>

                <!-- Banner Shop Section -->
                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid rgba(255,255,255,0.1);">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); font-size: 2rem; letter-spacing: 1px; margin-bottom: 1rem;">üé® PREMIUM BANNERS</h3>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Transform your profile with stunning premium banners! These appear behind your stats on the leaderboard.</p>
                    <div id="shopBannerGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                        <!-- Premium banners will be loaded here -->
                    </div>
                </div>

                <!-- Mascots Shop Section -->
                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid rgba(255,255,255,0.1);">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-purple); font-size: 2rem; letter-spacing: 1px; margin-bottom: 1rem;">üé≠ MASCOTS</h3>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Add personality to your profile! Mascots appear between your name and stats on the leaderboard.</p>
                    <div id="shopMascotGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                        <!-- Mascots will be loaded here -->
                    </div>
                </div>

                <!-- Info Note -->
                <div style="margin-top: 3rem; padding: 1.5rem; background: rgba(30, 144, 255, 0.1); border: 2px solid var(--cupboard-blue); border-radius: 12px; text-align: center;">
                    <div style="font-size: 1.1rem; color: var(--cupboard-blue); font-weight: bold; margin-bottom: 0.5rem;">üí° Manage Your Purchases</div>
                    <div style="color: rgba(255,255,255,0.7);">Head to the <span style="color: var(--cupboard-gold); font-weight: bold;">üé® Customize Profile</span> tab to toggle badges, activate banners, and equip mascots!</div>
                </div>
            </div>
        </div>

        <!-- Customize Profile Tab -->
        <div id="customizeTab" class="tab-content">
            <div class="add-card-section">
                <h2 class="section-title">üé® Customize Your Profile</h2>
                <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Make your profile stand out! Manage your badges and choose a profile banner.</p>

                <!-- Profile Preview -->
                <div style="background: linear-gradient(135deg, rgba(30, 144, 255, 0.1), rgba(147, 51, 234, 0.1)); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 2rem; margin-bottom: 3rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); font-size: 1.8rem; letter-spacing: 1px; margin-bottom: 1.5rem;">üëÅÔ∏è PROFILE PREVIEW</h3>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem;">This is how your profile will appear to others on the leaderboard.</p>
                    
                    <div id="profilePreview" style="background: var(--cupboard-dark); border: 2px solid var(--cupboard-gold); border-radius: 12px; padding: 1.5rem; position: relative;">
                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 1.5rem; align-items: center; width: 100%;">
                            <!-- Rank Badge -->
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <div class="leaderboard-rank top1" style="margin: 0;">
                                    ü•á
                                </div>
                            </div>
                            
                            <!-- Main Content Grid -->
                            <div style="display: grid; grid-template-columns: 1fr auto 2fr; gap: 1.5rem; align-items: center; position: relative;">
                                <!-- Banner Background (starts between user info and stats, with gradient fade) -->
                                <div id="previewBanner" style="position: absolute; top: -1.5rem; right: -1.5rem; bottom: -1.5rem; left: calc(33.333% + 0.75rem); background: linear-gradient(135deg, rgba(30, 144, 255, 0.3), rgba(147, 51, 234, 0.3)); z-index: 0; border-radius: 0 12px 12px 0; mask-image: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.3) 5%, rgba(0,0,0,1) 15%); -webkit-mask-image: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.3) 5%, rgba(0,0,0,1) 15%);"></div>
                                
                                <!-- Left: User Info -->
                                <div style="position: relative; z-index: 1;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--cupboard-blue); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                        <span id="previewUsername">Your Username</span>
                                        <div id="previewBadges" style="display: contents;">
                                            <!-- Badges will appear here -->
                                        </div>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-bottom: 0.5rem;">
                                        üëÅÔ∏è Click to view collection
                                    </div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">
                                        üèÜ Best: <span id="previewBestCard">Lionel Messi</span>
                                    </div>
                                    <div style="color: var(--cupboard-gold); font-size: 0.9rem; font-weight: bold;">
                                        <span id="previewBestScore">12,600</span> pts
                                    </div>
                                </div>

                                <!-- Center: Mascot -->
                                <div id="previewMascot" style="position: relative; z-index: 1; display: none;">
                                    <!-- Mascot will appear here -->
                                </div>
                                
                                <!-- Right: Stats Grid -->
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; position: relative; z-index: 1;">
                                    <div style="text-align: center; padding: 0.75rem; background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(212, 175, 55, 0.15)); border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.3);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-gold);" id="previewTotalScore">109,056</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">SCORE</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(30, 144, 255, 0.1); border-radius: 8px; border: 1px solid rgba(30, 144, 255, 0.3);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-blue);" id="previewTotalCards">30</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">CARDS</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(138, 43, 226, 0.1); border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.3);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-purple);" id="previewAvgScore">3,635</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">AVG/CARD</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(255, 215, 0, 0.08); border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.2);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 215, 0, 0.9);" id="previewRookies">5</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">‚≠ê ROOKIES</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(138, 43, 226, 0.08); border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.2);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: rgba(138, 43, 226, 0.9);" id="previewAutos">16</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">‚úçÔ∏è AUTOS</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Badge Display Manager -->
                <div style="margin-bottom: 3rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-purple); font-size: 1.8rem; letter-spacing: 1px; margin-bottom: 1rem;">üè∑Ô∏è BADGE DISPLAY SETTINGS</h3>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem;">Toggle which badges appear on your profile. You can enable/disable badges at any time.</p>
                    <div id="customizeBadgeManager" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Badge toggle controls will appear here -->
                    </div>
                </div>

                <!-- Profile Banners -->
                <div style="margin-top: 3rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); font-size: 1.8rem; letter-spacing: 1px; margin-bottom: 1rem;">üñºÔ∏è PROFILE BANNERS</h3>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem;">Choose a banner for your leaderboard profile. Banners appear behind your stats.</p>
                    
                    <div id="bannerGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">
                        <!-- Banner options will be loaded here -->
                    </div>
                </div>

                <!-- Mascots Manager -->
                <div style="margin-top: 3rem; padding-top: 3rem; border-top: 2px solid rgba(255,255,255,0.1);">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-purple); font-size: 1.8rem; letter-spacing: 1px; margin-bottom: 1rem;">üé≠ MY MASCOTS</h3>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem;">Equip a mascot to display between your name and stats on the leaderboard.</p>
                    
                    <div id="mascotManager" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                        <!-- Mascot options will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="add-card-section">
                <h2 class="section-title">‚öôÔ∏è Account Settings</h2>
                <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Manage your account preferences and data</p>

                <!-- Profile Settings -->
                <div style="background: rgba(30, 144, 255, 0.1); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); margin-bottom: 1rem;">üë§ Profile Information</h3>
                    <div id="settingsProfileAlert"></div>
                    <form id="settingsProfileForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Username *</label>
                                <input type="text" id="settingsUsername" placeholder="your_username" required maxlength="50">
                                <small style="color: rgba(255,255,255,0.5);">Letters, numbers, underscores, hyphens only (e.g., Broke_Bum)</small>
                            </div>
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" id="settingsDisplayName" placeholder="Your Display Name" maxlength="100">
                                <small style="color: rgba(255,255,255,0.5);">Can include spaces and special characters (e.g., Broke Bum)</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="settingsEmail" disabled style="opacity: 0.6; cursor: not-allowed;">
                            <small style="color: rgba(255,255,255,0.5);">Email cannot be changed</small>
                        </div>
                        <button type="submit" class="btn">üíæ Update Profile</button>
                    </form>
                </div>

                <!-- Privacy Settings -->
                <div style="background: rgba(138, 43, 226, 0.1); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-purple); margin-bottom: 1rem;">üîí Privacy Settings</h3>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="settingsShareStats" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Share my collection on the leaderboard</span>
                        </label>
                        <small style="color: rgba(255,255,255,0.5); display: block; margin-top: 0.5rem;">
                            When enabled, your username, card count, and total collection value appear on the leaderboard. Your actual cards remain private.
                        </small>
                    </div>
                    <button type="button" class="btn" onclick="savePrivacySettings()" style="margin-top: 1rem;">üíæ Save Privacy Settings</button>
                </div>

                <!-- Account Actions -->
                <div style="background: rgba(255, 69, 0, 0.1); border: 2px solid #ff4500; border-radius: 12px; padding: 2rem;">
                    <h3 style="font-family: 'Bebas Neue', sans-serif; color: #ff4500; margin-bottom: 1rem;">‚ö†Ô∏è Danger Zone</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 0.5rem;">Sign out of your account</p>
                            <button type="button" class="btn" onclick="logout()" style="background: linear-gradient(135deg, #666, #444);">üö™ Logout</button>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 0.5rem;">Delete all your data (This cannot be undone!)</p>
                            <button type="button" class="btn" onclick="confirmDeleteAccount()" style="background: linear-gradient(135deg, #ff4500, #cc0000);">üóëÔ∏è Delete Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="authModal" class="modal" style="display: flex;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2.8rem; background: linear-gradient(135deg, #1E90FF, #FFD700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 2px;">CollectIQ</h2>
                <p style="color: rgba(255,255,255,0.6); font-size: 0.95rem; margin-top: 0.5rem;">Smart Sports Card Collection Tracker</p>
            </div>
            
            <div id="authAlert"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-blue); margin-bottom: 1.5rem;">Login</h3>
                <form id="loginFormElement">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Password *</span>
                            <a href="#" onclick="showForgotPasswordForm(); return false;" style="color: var(--cupboard-blue); font-size: 0.85rem; font-weight: normal;">Forgot password?</a>
                        </label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">üîì Login</button>
                </form>
                <p style="text-align: center; margin-top: 1.5rem; color: rgba(255,255,255,0.7);">
                    Don't have an account? <a href="#" onclick="showSignupForm(); return false;" style="color: var(--cupboard-blue);">Sign up</a>
                </p>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" style="display: none;">
                <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-blue); margin-bottom: 1.5rem;">Reset Password</h3>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">Enter your email address and we'll send you a link to reset your password.</p>
                <div id="forgotPasswordAlert"></div>
                <form id="forgotPasswordFormElement">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="forgotPasswordEmail" placeholder="your@email.com" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">üìß Send Reset Link</button>
                </form>
                <p style="text-align: center; margin-top: 1.5rem; color: rgba(255,255,255,0.7);">
                    Remember your password? <a href="#" onclick="showLoginForm(); return false;" style="color: var(--cupboard-blue);">Back to login</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-blue); margin-bottom: 1.5rem;">Create Account</h3>
                <form id="signupFormElement">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                        <small style="color: rgba(255,255,255,0.5);">At least 6 characters</small>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" id="signupConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                        <small style="color: rgba(255,255,255,0.5);">Re-enter your password</small>
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="signupUsername" placeholder="your_username" required maxlength="50">
                        <small style="color: rgba(255,255,255,0.5);">Letters, numbers, underscores, hyphens only</small>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">üéâ Create Account</button>
                </form>
                <p style="text-align: center; margin-top: 1.5rem; color: rgba(255,255,255,0.7);">
                    Already have an account? <a href="#" onclick="showLoginForm(); return false;" style="color: var(--cupboard-blue);">Login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Score Breakdown Modal -->
    <div id="scoreBreakdownModal" class="modal" style="z-index: 3500;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="scoreBreakdownTitle" style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-gold); font-size: 2rem; letter-spacing: 2px;">üìä Score Breakdown</h2>
                <button class="close-modal" onclick="closeScoreBreakdownModal()">√ó</button>
            </div>
            <div id="scoreBreakdownBody" class="modal-body">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Folder Manager Modal -->
    <div id="folderManagerModal" class="modal" style="z-index: 3500;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 style="font-family: 'Bebas Neue', sans-serif; color: var(--cupboard-purple); font-size: 2rem; letter-spacing: 2px;">üìÅ Manage Folders</h2>
                <button class="close-modal" onclick="closeFolderManager()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="folderAlert"></div>
                
                <!-- Add New Folder -->
                <div style="background: rgba(138, 43, 226, 0.1); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: var(--cupboard-gold); margin-bottom: 1rem;">‚ûï Create New Folder</h3>
                    <div style="display: flex; gap: 1rem;">
                        <input 
                            type="text" 
                            id="newFolderName" 
                            placeholder="Folder name (e.g., Messi Collection)"
                            maxlength="50"
                            style="flex: 1; padding: 0.75rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-purple); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif;"
                        >
                        <button onclick="createFolder()" class="btn" style="padding: 0.75rem 1.5rem; white-space: nowrap;">
                            Create Folder
                        </button>
                    </div>
                </div>
                
                <!-- Existing Folders -->
                <div>
                    <h3 style="color: var(--cupboard-gold); margin-bottom: 1rem;">Your Folders</h3>
                    <div id="folderList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Folders will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div id="cardModal" class="modal" style="z-index: 3000;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Card Details</h3>
                <div class="modal-actions">
                    <button class="edit-btn" id="editCardBtn" onclick="editCard()">‚úèÔ∏è Edit</button>
                    <button class="close-modal" onclick="closeCardModal()">√ó</button>
                </div>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- User Collection Modal -->
    <div id="userCollectionModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="position: sticky; top: 0; background: var(--cupboard-darker); z-index: 10; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
                    <h3 class="modal-title" id="userModalTitle" style="margin: 0;">User Collection</h3>
                    <div class="search-container" style="flex: 1; max-width: 400px;">
                        <input type="text" id="userCollectionSearch" placeholder="Search players..." 
                               oninput="searchUserCollection()"
                               style="width: 100%; padding: 0.6rem 1rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif; font-size: 0.95rem;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Sort:</label>
                        <select id="userCollectionSort" onchange="sortUserCollection()" style="padding: 0.4rem 0.8rem; background: var(--cupboard-dark); border: 2px solid var(--cupboard-blue); border-radius: 6px; color: #fff; font-family: 'Outfit', sans-serif; cursor: pointer; font-size: 0.9rem;">
                            <option value="score_desc">Score ‚Üì</option>
                            <option value="score_asc">Score ‚Üë</option>
                            <option value="date_desc">Newest</option>
                            <option value="date_asc">Oldest</option>
                            <option value="price_desc">Price ‚Üì</option>
                            <option value="price_asc">Price ‚Üë</option>
                            <option value="player_asc">A-Z</option>
                            <option value="player_desc">Z-A</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="close-modal" onclick="closeUserCollectionModal()">√ó</button>
                </div>
            </div>
            <div id="userCollectionLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div id="userCollectionGrid" class="collection-grid" style="padding: 1rem;"></div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="imageZoomModal" class="modal" style="z-index: 4000;" onclick="closeImageZoom()">
        <div style="position: relative; max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;">
            <button class="close-modal" onclick="closeImageZoom()" style="position: absolute; top: -50px; right: 0; z-index: 10;">√ó</button>
            <img id="zoomedImage" src="" alt="Card Image" style="max-width: 100%; max-height: 90vh; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.8); cursor: zoom-out;">
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://mcshltycyjlcxegahuva.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jc2hsdHljeWpsY3hlZ2FodXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjkxNTQsImV4cCI6MjA4NTE0NTE1NH0.rZrDvONbNXiK-Idzop_9PWekLT6GojKt1T3gXhpEWUQ';
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51QcbEfF3ZLq5bMj6PsRuktcC2QjLJEhSzmHnoZiAgEqMv7shigEV6ekRkhwAtF7Fejj9QhIbWe7UuywsSXUYsRwc00Az9xqiKA';
        
        console.log('Initializing Supabase...');
        
        // Check if supabase already exists
        if (typeof supabase === 'undefined') {
            var supabase;
        }
        
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('Supabase client created successfully');
        } catch (err) {
            console.error('Error creating Supabase client:', err);
            alert('Error connecting to Supabase: ' + err.message);
        }

        // Global variable to store current card being viewed/edited
        let currentCardItem = null;

        // Profanity Filter
        const forbiddenWords = [
            // Common profanity
            'fuck', 'shit', 'bitch', 'ass', 'asshole', 'bastard', 'damn', 'hell',
            'crap', 'piss', 'dick', 'cock', 'pussy', 'cunt', 'whore', 'slut',
            // Slurs and offensive terms (partial list)
            'nigger', 'nigga', 'fag', 'faggot', 'retard', 'retarded',
            // Variations with numbers/symbols
            'f*ck', 'sh*t', 'b*tch', 'a$$', 'fuk', 'fck', 'sht', 'btch',
            // Inappropriate content
            'nazi', 'hitler', 'kkk', 'terrorist',
            // Sexual content
            'porn', 'sex', 'nude', 'xxx', 'penis', 'vagina', 'anal',
            // Drugs
            'cocaine', 'heroin', 'meth', 'weed',
            // Spam/scam indicators
            'admin', 'moderator', 'official', 'support', 'staff'
        ];

        function containsProfanity(text) {
            if (!text) return false;
            
            const lowerText = text.toLowerCase().trim();
            
            // Check for exact matches and partial matches
            for (const word of forbiddenWords) {
                // Check if forbidden word exists as a standalone word or part of username
                const regex = new RegExp(`\\b${word}\\b|${word}`, 'i');
                if (regex.test(lowerText)) {
                    return true;
                }
            }
            
            // Check for leetspeak variations (1 = i/l, 3 = e, 4 = a, 5 = s, 0 = o, 7 = t)
            const leetText = lowerText
                .replace(/1/g, 'i')
                .replace(/3/g, 'e')
                .replace(/4/g, 'a')
                .replace(/5/g, 's')
                .replace(/0/g, 'o')
                .replace(/7/g, 't');
            
            for (const word of forbiddenWords) {
                if (leetText.includes(word)) {
                    return true;
                }
            }
            
            return false;
        }

        // Global variable to store current user
        let currentUser = null;

        // Global variable to track if we're in edit mode
        let isEditMode = false;
        let editingCollectionId = null;

        // Global variable to track archive view
        let isViewingArchive = false;

        // Global variable to store current viewed user collection
        let currentUserCollectionData = null;
        let currentUserCollectionOwner = null;

        // Global variable to store current user's collection data for searching
        let myCollectionData = null;

        // Logout
        async function logout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            await supabase.auth.signOut();
            currentUser = null;
            document.getElementById('authModal').style.display = 'flex';
            document.querySelector('.container').style.display = 'none';
        }

        // Show login form
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('authAlert').innerHTML = '';
        }

        // Show signup form
        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('authAlert').innerHTML = '';
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('authAlert').innerHTML = '';
        }

        function showForgotPasswordForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
            document.getElementById('authAlert').innerHTML = '';
            document.getElementById('forgotPasswordAlert').innerHTML = '';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, checking auth...');
            
            // Setup login form handler
            console.log('Setting up login form handler...');
            const loginForm = document.getElementById('loginFormElement');
            console.log('Login form element:', loginForm);
            
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    console.log('Login form submitted!');
                    e.preventDefault();
                    const alertDiv = document.getElementById('authAlert');
                    alertDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                    
                    try {
                        const email = document.getElementById('loginEmail').value;
                        const password = document.getElementById('loginPassword').value;
                        console.log('Attempting login with email:', email);

                        const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    currentUser = data.user;
                    alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Login successful!</div>';
                    
                    setTimeout(() => {
                        document.getElementById('authModal').style.display = 'none';
                        document.querySelector('.container').style.display = 'block';
                        loadDashboard();
                    }, 1000);

                } catch (error) {
                    console.error('Login error:', error);
                    alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${error.message}</div>`;
                }
                });
            } else {
                console.error('Login form element not found!');
            }

            // Setup signup form handler
            console.log('Setting up signup form handler...');
            const signupForm = document.getElementById('signupFormElement');
            console.log('Signup form element:', signupForm);
            
            if (signupForm) {
                // Add real-time password matching feedback
                const passwordInput = document.getElementById('signupPassword');
                const confirmPasswordInput = document.getElementById('signupConfirmPassword');
                
                const checkPasswordMatch = () => {
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    
                    if (confirmPassword.length === 0) {
                        confirmPasswordInput.style.borderColor = '';
                        return;
                    }
                    
                    if (password === confirmPassword) {
                        confirmPasswordInput.style.borderColor = 'var(--cupboard-green)';
                        confirmPasswordInput.style.boxShadow = '0 0 8px rgba(0, 255, 127, 0.3)';
                    } else {
                        confirmPasswordInput.style.borderColor = '#ef4444';
                        confirmPasswordInput.style.boxShadow = '0 0 8px rgba(239, 68, 68, 0.3)';
                    }
                };
                
                passwordInput.addEventListener('input', checkPasswordMatch);
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
                
                signupForm.addEventListener('submit', async (e) => {
                    console.log('Signup form submitted!');
                    e.preventDefault();
                    const alertDiv = document.getElementById('authAlert');
                    alertDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                    
                    try {
                        const email = document.getElementById('signupEmail').value;
                        const password = document.getElementById('signupPassword').value;
                        const confirmPassword = document.getElementById('signupConfirmPassword').value;
                        const username = document.getElementById('signupUsername').value.trim();

                        // Validate passwords match
                        if (password !== confirmPassword) {
                            throw new Error('Passwords do not match! Please make sure both passwords are the same.');
                        }

                        // Validate username format
                        if (!username || username.length < 3) {
                            throw new Error('Username must be at least 3 characters long');
                        }

                        if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                            throw new Error('Username can only contain letters, numbers, underscores, and hyphens');
                        }

                        // Check for profanity
                        if (containsProfanity(username)) {
                            throw new Error('Username contains inappropriate language. Please choose a different username.');
                        }

                        // Check if username is already taken
                        const { data: usernameCheck } = await supabase
                            .from('user_profiles')
                            .select('username')
                            .eq('username', username)
                            .maybeSingle();

                        if (usernameCheck) {
                            throw new Error('Username is already taken. Please choose a different one.');
                        }

                        const { data, error } = await supabase.auth.signUp({
                            email: email,
                            password: password
                    });

                    if (error) throw error;

                    // Update the auto-created profile with username
                    await supabase
                        .from('user_profiles')
                        .update({ username: username })
                        .eq('auth_user_id', data.user.id);

                    currentUser = data.user;
                    alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Account created! Logging you in...</div>';

                    setTimeout(() => {
                        document.getElementById('authModal').style.display = 'none';
                        document.querySelector('.container').style.display = 'block';
                        loadDashboard();
                    }, 1500);

                } catch (error) {
                    console.error('Signup error:', error);
                    alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${error.message}</div>`;
                }
                });
            } else {
                console.error('Signup form element not found!');
            }

            // Setup forgot password form handler
            const forgotPasswordForm = document.getElementById('forgotPasswordFormElement');
            if (forgotPasswordForm) {
                forgotPasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const alertDiv = document.getElementById('forgotPasswordAlert');
                    alertDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                    
                    try {
                        const email = document.getElementById('forgotPasswordEmail').value;

                        console.log('Attempting password reset for:', email);
                        console.log('Redirect URL:', `${window.location.origin}/#reset-password`);

                        // Use the current origin (GitHub Pages URL)
                        const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                            redirectTo: `${window.location.origin}/#reset-password`
                        });

                        console.log('Password reset response:', { data, error });

                        if (error) {
                            console.error('Full error object:', error);
                            throw error;
                        }

                        alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Password reset link sent! Check your email.</div>';
                        
                        // Clear form and show success for 3 seconds, then go back to login
                        document.getElementById('forgotPasswordFormElement').reset();
                        setTimeout(() => {
                            showLoginForm();
                        }, 3000);

                    } catch (error) {
                        console.error('Password reset error:', error);
                        console.error('Error details:', {
                            message: error.message,
                            status: error.status,
                            code: error.code,
                            full: error
                        });
                        alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${error.message}<br><small>Check browser console (F12) for details</small></div>`;
                    }
                });
            }
            
            // Handle password reset from email link
            const handlePasswordReset = async () => {
                // Check if we have a reset token in the URL
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                if (hashParams.get('type') === 'recovery' || window.location.hash.includes('reset-password')) {
                    console.log('Password reset detected');
                    
                    // Show password reset form
                    const newPassword = prompt('Please enter your new password (minimum 6 characters):');
                    
                    if (newPassword && newPassword.length >= 6) {
                        try {
                            const { error } = await supabase.auth.updateUser({
                                password: newPassword
                            });

                            if (error) throw error;

                            alert('‚úÖ Password updated successfully! Please log in with your new password.');
                            
                            // Clear the hash and refresh
                            window.location.hash = '';
                            window.location.reload();

                        } catch (error) {
                            console.error('Password update error:', error);
                            alert('‚ùå Error updating password: ' + error.message);
                        }
                    } else if (newPassword !== null) {
                        alert('‚ùå Password must be at least 6 characters long.');
                    }
                }
            };

            // Run password reset handler
            await handlePasswordReset();
            
            // Check if user is logged in
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                console.log('User logged in:', currentUser.email);
                document.getElementById('authModal').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                
                // Check for Stripe success redirect
                await handleStripeSuccess();
                
                loadDashboard();
            } else {
                console.log('No user logged in, showing auth modal');
                document.getElementById('authModal').style.display = 'flex';
                document.querySelector('.container').style.display = 'none';
            }
            
            loadSports();
            loadManufacturers();
        });

        // Tab Switching
        async function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'dashboard') {
                document.querySelector('[onclick="switchTab(\'dashboard\')"]').classList.add('active');
                document.getElementById('dashboardTab').classList.add('active');
                loadDashboard();
            } else if (tab === 'add') {
                document.querySelector('[onclick="switchTab(\'add\')"]').classList.add('active');
                document.getElementById('addTab').classList.add('active');
                loadFoldersIntoAddForm(); // Load folders into add card dropdown
            } else if (tab === 'collection') {
                document.querySelector('[onclick="switchTab(\'collection\')"]').classList.add('active');
                document.getElementById('collectionTab').classList.add('active');
                loadFolders(); // Load folder dropdown options
                updateArchiveButtonCount(); // Update archive count
                loadCollection();
            } else if (tab === 'sales') {
                document.querySelector('[onclick="switchTab(\'sales\')"]').classList.add('active');
                document.getElementById('salesTab').classList.add('active');
                loadSalesHistory();
            } else if (tab === 'achievements') {
                document.querySelector('[onclick="switchTab(\'achievements\')"]').classList.add('active');
                document.getElementById('achievementsTab').classList.add('active');
                loadAchievements();
            } else if (tab === 'leaderboard') {
                document.querySelector('[onclick="switchTab(\'leaderboard\')"]').classList.add('active');
                document.getElementById('leaderboardTab').classList.add('active');
                loadLeaderboard();
            } else if (tab === 'shop') {
                document.querySelector('[onclick="switchTab(\'shop\')"]').classList.add('active');
                document.getElementById('shopTab').classList.add('active');
                await handleStripeSuccess();
                loadShop();
            } else if (tab === 'customize') {
                document.querySelector('[onclick="switchTab(\'customize\')"]').classList.add('active');
                document.getElementById('customizeTab').classList.add('active');
                loadCustomizeProfile();
            } else if (tab === 'settings') {
                document.querySelector('[onclick="switchTab(\'settings\')"]').classList.add('active');
                document.getElementById('settingsTab').classList.add('active');
                loadAccountSettings();
            } else if (tab === 'scores') {
                document.querySelector('[onclick="switchTab(\'scores\')"]').classList.add('active');
                document.getElementById('scoresTab').classList.add('active');
                loadCollectorScores();
            }
        }


        // Load Sports
        async function loadSports() {
            console.log('Loading sports...');
            try {
                const { data, error } = await supabase.from('sports').select('*');
                
                console.log('Sports query result:', { data, error });
                
                if (error) {
                    console.error('Error loading sports:', error);
                    alert('Error loading sports: ' + error.message + '\n\nPlease check that Row Level Security is disabled on the sports table.');
                    return;
                }
                
                console.log('Sports data received:', data);
                
                const select = document.getElementById('sportSelect');
                if (data && data.length > 0) {
                    data.forEach(sport => {
                        const option = document.createElement('option');
                        option.value = sport.sport_id;
                        option.textContent = sport.sport_name;
                        select.appendChild(option);
                        console.log('Added sport option:', sport.sport_name);
                    });
                    console.log('Total sports loaded:', data.length);
                } else {
                    console.warn('No sports data returned');
                    alert('No sports found in database. Please check your Supabase setup.');
                }
            } catch (err) {
                console.error('Exception loading sports:', err);
                alert('Exception loading sports: ' + err.message);
            }
        }

        // Load Manufacturers
        async function loadManufacturers() {
            console.log('Loading manufacturers...');
            try {
                const { data, error } = await supabase.from('manufacturers').select('*');
                
                console.log('Manufacturers query result:', { data, error });
                
                if (error) {
                    console.error('Error loading manufacturers:', error);
                    alert('Error loading manufacturers: ' + error.message + '\n\nPlease check that Row Level Security is disabled on the manufacturers table.');
                    return;
                }
                
                console.log('Manufacturers data received:', data);
                
                const select = document.getElementById('manufacturerSelect');
                if (data && data.length > 0) {
                    data.forEach(manufacturer => {
                        const option = document.createElement('option');
                        option.value = manufacturer.manufacturer_id;
                        option.textContent = manufacturer.name;
                        select.appendChild(option);
                        console.log('Added manufacturer option:', manufacturer.name);
                    });
                    console.log('Total manufacturers loaded:', data.length);
                } else {
                    console.warn('No manufacturers data returned');
                    alert('No manufacturers found in database. Please check your Supabase setup.');
                }
            } catch (err) {
                console.error('Exception loading manufacturers:', err);
                alert('Exception loading manufacturers: ' + err.message);
            }
        }

        // Image Upload Handler
        document.getElementById('imageUploadArea').addEventListener('click', function() {
            document.getElementById('cardImage').click();
        });

        document.getElementById('cardImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                console.log('Image selected:', file.name, file.type, file.size);
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('imagePreview');
                    const previewImg = document.getElementById('previewImg');
                    
                    previewImg.src = event.target.result;
                    preview.style.display = 'block';
                    
                    console.log('Image preview loaded');
                };
                reader.readAsDataURL(file);
            }
        });

        // Clear Add Card Form
        function clearAddCardForm() {
            if (!confirm('Are you sure you want to clear the form? All entered data will be lost.')) {
                return;
            }

            // Reset the entire form
            document.getElementById('addCardForm').reset();

            // Clear image preview
            const imagePreview = document.getElementById('imagePreview');
            if (imagePreview) imagePreview.style.display = 'none';

            // Reset specific fields to defaults
            document.getElementById('quantity').value = '1';
            document.getElementById('isRookie').value = 'false';
            document.getElementById('isAutograph').value = 'false';

            // Clear file input
            const cardImageInput = document.getElementById('cardImage');
            if (cardImageInput) cardImageInput.value = '';

            showToast('üóëÔ∏è Form cleared!', 'info');
        }

        // Add Card Form Submit
        document.getElementById('addCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check if we're in edit mode
            if (isEditMode && editingCollectionId) {
                await updateCard(editingCollectionId);
                return;
            }
            
            const alertDiv = document.getElementById('addAlert');
            
            // Validate image is uploaded (only for new cards, not edits)
            const cardImageInput = document.getElementById('cardImage');
            if (!cardImageInput.files || cardImageInput.files.length === 0) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Please upload a card image before submitting.</div>';
                // Scroll to the image upload area
                document.getElementById('imageUploadArea').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            alertDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                // Get form values
                const sportId = parseInt(document.getElementById('sportSelect').value);
                const playerFirstName = document.getElementById('playerFirstName').value;
                const playerLastName = document.getElementById('playerLastName').value;
                const manufacturerId = parseInt(document.getElementById('manufacturerSelect').value);
                const setName = document.getElementById('setName').value;
                const setYear = parseInt(document.getElementById('setYear').value);
                const cardNumber = document.getElementById('cardNumber').value;
                const variant = document.getElementById('cardVariant').value;
                const isRookie = document.getElementById('isRookie').value === 'true';
                const isAutograph = document.getElementById('isAutograph').value === 'true';
                const condition = document.getElementById('condition').value;
                const gradingCompany = document.getElementById('gradingCompany').value;
                const grade = document.getElementById('grade').value ? parseFloat(document.getElementById('grade').value) : null;
                const autoGrade = document.getElementById('autoGrade').value ? parseFloat(document.getElementById('autoGrade').value) : null;
                const certNumber = document.getElementById('certNumber').value;
                const purchasePrice = document.getElementById('purchasePrice').value ? parseFloat(document.getElementById('purchasePrice').value) : null;
                const purchaseDate = document.getElementById('purchaseDate').value || null;
                const quantity = parseInt(document.getElementById('quantity').value);
                const notes = document.getElementById('notes').value;

                console.log('Starting card add process...');

                // Step 1: Create or find player
                let playerId;
                const { data: existingPlayer } = await supabase
                    .from('players')
                    .select('player_id')
                    .eq('first_name', playerFirstName)
                    .eq('last_name', playerLastName)
                    .eq('sport_id', sportId)
                    .single();

                if (existingPlayer) {
                    playerId = existingPlayer.player_id;
                    console.log('Found existing player:', playerId);
                } else {
                    const { data: newPlayer, error: playerError } = await supabase
                        .from('players')
                        .insert([{ first_name: playerFirstName, last_name: playerLastName, sport_id: sportId }])
                        .select()
                        .single();
                    
                    if (playerError) throw playerError;
                    playerId = newPlayer.player_id;
                    console.log('Created new player:', playerId);
                }

                // Step 2: Create or find card set
                let setId;
                const { data: existingSet } = await supabase
                    .from('card_sets')
                    .select('set_id')
                    .eq('set_name', setName)
                    .eq('year', setYear)
                    .eq('manufacturer_id', manufacturerId)
                    .single();

                if (existingSet) {
                    setId = existingSet.set_id;
                    console.log('Found existing set:', setId);
                } else {
                    const { data: newSet, error: setError } = await supabase
                        .from('card_sets')
                        .insert([{ set_name: setName, year: setYear, sport_id: sportId, manufacturer_id: manufacturerId }])
                        .select()
                        .single();
                    
                    if (setError) throw setError;
                    setId = newSet.set_id;
                    console.log('Created new set:', setId);
                }

                // Step 3: Create or find card
                let cardId;
                const { data: existingCard } = await supabase
                    .from('cards')
                    .select('card_id')
                    .eq('set_id', setId)
                    .eq('player_id', playerId)
                    .eq('card_number', cardNumber)
                    .eq('variant', variant || '')
                    .single();

                if (existingCard) {
                    cardId = existingCard.card_id;
                    console.log('Found existing card:', cardId);
                } else {
                    const { data: newCard, error: cardError } = await supabase
                        .from('cards')
                        .insert([{ 
                            set_id: setId, 
                            player_id: playerId, 
                            card_number: cardNumber,
                            variant: variant,
                            is_rookie: isRookie,
                            is_autograph: isAutograph
                        }])
                        .select()
                        .single();
                    
                    if (cardError) throw cardError;
                    cardId = newCard.card_id;
                    console.log('Created new card:', cardId);
                }

                // Step 4: Add to collection
                const folderId = document.getElementById('cardFolder').value || null;
                const { data: collection, error: collectionError } = await supabase
                    .from('my_collection')
                    .insert([{
                        card_id: cardId,
                        auth_user_id: currentUser.id,
                        condition: condition,
                        grade: grade,
                        auto_grade: autoGrade,
                        grading_company: gradingCompany,
                        cert_number: certNumber,
                        purchase_price: purchasePrice,
                        purchase_date: purchaseDate,
                        quantity: quantity,
                        notes: notes,
                        is_rookie: isRookie,
                        is_autograph: isAutograph,
                        card_number_override: cardNumber,
                        variant_override: variant,
                        sport_override_id: sportId,
                        folder_id: folderId
                    }])
                    .select()
                    .single();

                if (collectionError) throw collectionError;
                console.log('Added to collection:', collection.collection_id);

                // Step 5: Upload image if provided
                const imageFile = document.getElementById('cardImage').files[0];
                if (imageFile) {
                    console.log('Uploading image...');
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${collection.collection_id}-${Date.now()}.${fileExt}`;
                    const filePath = `${fileName}`;

                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('card-images')
                        .upload(filePath, imageFile, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) {
                        console.error('Image upload error:', uploadError);
                        alertDiv.innerHTML = `<div class="alert alert-error">‚ö†Ô∏è Card added but image upload failed: ${uploadError.message}</div>`;
                    } else {
                        console.log('Image uploaded:', uploadData);
                        
                        // Get public URL
                        const { data: urlData } = supabase.storage
                            .from('card-images')
                            .getPublicUrl(filePath);

                        console.log('Image URL:', urlData.publicUrl);

                        // Save image record
                        const { error: imageError } = await supabase
                            .from('card_images')
                            .insert([{
                                collection_id: collection.collection_id,
                                image_url: urlData.publicUrl,
                                image_type: 'front',
                                is_primary: true
                            }]);

                        if (imageError) {
                            console.error('Image record error:', imageError);
                        }
                    }
                }

                // Success!
                alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Card successfully added to your collection!</div>';
                document.getElementById('addCardForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                
                // Refresh collection
                loadCollection();
                
                // Refresh dashboard timeline if we're on dashboard or silently update
                refreshDashboardTimeline();
                
                // Check for newly unlocked achievements
                checkAchievements();
                
                setTimeout(() => {
                    alertDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error adding card:', error);
                alertDiv.innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        });

        // Toggle Archive View
        async function toggleArchive() {
            isViewingArchive = !isViewingArchive;
            
            const btn = document.getElementById('archiveToggleBtn');
            const title = document.querySelector('.section-title');
            
            if (isViewingArchive) {
                btn.style.background = 'linear-gradient(135deg, var(--cupboard-purple), #9333ea)';
                btn.style.borderColor = 'var(--cupboard-purple)';
                title.textContent = 'üì¶ Archive (Sold Cards)';
            } else {
                btn.style.background = 'linear-gradient(135deg, rgba(138, 43, 226, 0.3), rgba(147, 51, 234, 0.3))';
                btn.style.borderColor = 'var(--cupboard-purple)';
                title.textContent = 'My Collection';
            }
            
            // Reload collection with new filter
            await loadCollection();
            
            // Update button count
            await updateArchiveButtonCount();
        }

        // Update Archive Button Count
        async function updateArchiveButtonCount() {
            try {
                const { count, error } = await supabase
                    .from('my_collection')
                    .select('*', { count: 'exact', head: true })
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_sold', true);
                
                if (error) throw error;
                
                const btn = document.getElementById('archiveToggleBtn');
                const archiveCount = count || 0;
                
                if (isViewingArchive) {
                    btn.innerHTML = `üì¶ Viewing Archive (${archiveCount})`;
                } else {
                    btn.innerHTML = `üì¶ Archive (${archiveCount})`;
                }
            } catch (error) {
                console.error('Error updating archive count:', error);
            }
        }

        // Update Archive Button (called after loading collection)
        function updateArchiveButton(count) {
            const btn = document.getElementById('archiveToggleBtn');
            if (isViewingArchive) {
                btn.innerHTML = `üì¶ Viewing Archive (${count})`;
            }
        }

        // Search Collection
        function searchCollection() {
            const searchTerm = document.getElementById('collectionSearch').value.toLowerCase();
            
            if (!myCollectionData) return;

            const grid = document.getElementById('collectionGrid');
            grid.innerHTML = '';

            // Filter data by search term
            let filteredData = myCollectionData;
            if (searchTerm) {
                filteredData = myCollectionData.filter(item => {
                    const player = item.cards.players;
                    const fullName = `${player.first_name} ${player.last_name}`.toLowerCase();
                    return fullName.includes(searchTerm);
                });
            }

            // Apply current sort
            const sortValue = document.getElementById('collectionSort')?.value || 'date_desc';
            
            if (sortValue === 'player_asc' || sortValue === 'player_desc') {
                filteredData.sort((a, b) => {
                    const nameA = `${a.cards.players.first_name} ${a.cards.players.last_name}`.toLowerCase();
                    const nameB = `${b.cards.players.first_name} ${b.cards.players.last_name}`.toLowerCase();
                    return sortValue === 'player_asc' 
                        ? nameA.localeCompare(nameB) 
                        : nameB.localeCompare(nameA);
                });
            } else if (sortValue === 'score_desc' || sortValue === 'score_asc') {
                filteredData.sort((a, b) => {
                    const scoreA = calculateCollectorScore(a);
                    const scoreB = calculateCollectorScore(b);
                    return sortValue === 'score_desc'
                        ? scoreB - scoreA
                        : scoreA - scoreB;
                });
            }

            if (filteredData.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-text">No cards found matching "${searchTerm}"</div>
                    </div>
                `;
                return;
            }

            // Render filtered results (using same rendering logic as loadCollection)
            filteredData.forEach(item => {
                const card = item.cards;
                const player = card.players;
                const set = card.card_sets;
                const manufacturer = set.manufacturers;
                const primaryImage = item.card_images?.find(img => img.is_primary);

                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.onclick = () => showCardDetails(item);

                const displayCardNumber = item.card_number_override || card.card_number;
                const displayIsRookie = item.is_rookie !== null ? item.is_rookie : card.is_rookie;

                let imageHTML = 'üèÄ';
                if (primaryImage && primaryImage.image_url) {
                    imageHTML = `<img src="${primaryImage.image_url}" alt="${player.first_name} ${player.last_name}">`;
                }

                cardElement.innerHTML = `
                    <button class="delete-card-btn" onclick="event.stopPropagation(); deleteCard(${item.collection_id})" title="Delete Card">üóëÔ∏è</button>
                    <div class="card-image">
                        ${imageHTML}
                        ${item.grade ? `<div class="card-grade-badge">${item.grading_company} ${item.grade}</div>` : ''}
                        ${item.auto_grade >= 10 ? `<div class="card-grade-badge" style="background: linear-gradient(135deg, var(--cupboard-purple), #9333ea); top: 10px; left: 10px; right: auto;">AUTO 10</div>` : ''}
                    </div>
                    <div class="card-details">
                        <div class="card-title">${player.first_name} ${player.last_name}</div>
                        <div class="card-meta">
                            <div class="card-meta-row">
                                <span>${set.year} ${manufacturer.name} ${set.set_name}</span>
                            </div>
                            <div class="card-meta-row">
                                <span>#${displayCardNumber || 'N/A'}</span>
                                <span>${item.cert_number || 'N/A'}</span>
                            </div>
                            ${displayIsRookie ? '<div style="color: var(--cupboard-gold);">‚≠ê ROOKIE CARD</div>' : ''}
                        </div>
                        ${item.purchase_price ? `<div class="card-price">$${item.purchase_price.toFixed(2)}</div>` : ''}
                    </div>
                `;

                grid.appendChild(cardElement);
            });

            // Update header stats
            updateHeaderStats();
        }

        // Load Collection
        async function loadCollection() {
            const grid = document.getElementById('collectionGrid');
            const loading = document.getElementById('collectionLoading');
            
            loading.style.display = 'flex';
            grid.innerHTML = '';

            try {
                // Get sort preference
                const sortValue = document.getElementById('collectionSort')?.value || 'date_desc';
                
                // Get folder filter
                const folderFilter = document.getElementById('folderFilter')?.value || 'all';
                
                // Build query
                let query = supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        ),
                        card_images (*)
                    `)
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_sold', isViewingArchive); // Filter by sold status
                
                // Apply folder filter (only when not viewing archive)
                if (!isViewingArchive && folderFilter !== 'all') {
                    if (folderFilter === 'none') {
                        query = query.is('folder_id', null);
                    } else {
                        query = query.eq('folder_id', folderFilter);
                    }
                }

                // Apply sorting
                switch(sortValue) {
                    case 'date_desc':
                        query = query.order('added_at', { ascending: false });
                        break;
                    case 'date_asc':
                        query = query.order('added_at', { ascending: true });
                        break;
                    case 'price_desc':
                        query = query.order('purchase_price', { ascending: false, nullsLast: true });
                        break;
                    case 'price_asc':
                        query = query.order('purchase_price', { ascending: true, nullsLast: true });
                        break;
                    // Player name sorting will be done client-side after loading
                    default:
                        query = query.order('added_at', { ascending: false });
                }

                const { data, error } = await query;

                if (error) throw error;

                // Update archive button count
                updateArchiveButton(data.length);

                // Store data globally for searching
                myCollectionData = data;

                // Client-side sorting for player names and collector score
                if (sortValue === 'player_asc' || sortValue === 'player_desc') {
                    data.sort((a, b) => {
                        const nameA = `${a.cards.players.first_name} ${a.cards.players.last_name}`.toLowerCase();
                        const nameB = `${b.cards.players.first_name} ${b.cards.players.last_name}`.toLowerCase();
                        return sortValue === 'player_asc' 
                            ? nameA.localeCompare(nameB) 
                            : nameB.localeCompare(nameA);
                    });
                } else if (sortValue === 'score_desc' || sortValue === 'score_asc') {
                    data.sort((a, b) => {
                        const scoreA = calculateCollectorScore(a);
                        const scoreB = calculateCollectorScore(b);
                        return sortValue === 'score_desc'
                            ? scoreB - scoreA
                            : scoreA - scoreB;
                    });
                }

                loading.style.display = 'none';

                // Apply search filter if search box has text
                const searchTerm = document.getElementById('collectionSearch')?.value.toLowerCase();
                if (searchTerm) {
                    data = data.filter(item => {
                        const player = item.cards.players;
                        const fullName = `${player.first_name} ${player.last_name}`.toLowerCase();
                        return fullName.includes(searchTerm);
                    });
                }

                if (data.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-text">No cards in your collection yet. Add your first card!</div>
                        </div>
                    `;
                    
                    return;
                }

                let totalValue = 0;
                data.forEach(item => {
                    totalValue += item.purchase_price || 0;
                    
                    const card = item.cards;
                    const player = card.players;
                    const set = card.card_sets;
                    const manufacturer = set.manufacturers;
                    
                    console.log('Card item:', item);
                    console.log('Card images:', item.card_images);
                    
                    const primaryImage = item.card_images?.find(img => img.is_primary);
                    console.log('Primary image:', primaryImage);

                    const cardElement = document.createElement('div');
                    cardElement.className = 'card-item';
                    cardElement.onclick = () => showCardDetails(item);
                    
                    let imageHTML = 'üèÄ';
                    if (primaryImage && primaryImage.image_url) {
                        console.log('Using image URL:', primaryImage.image_url);
                        imageHTML = `<img src="${primaryImage.image_url}" alt="${player.first_name} ${player.last_name}">`;
                    } else {
                        console.log('No primary image found, using default emoji');
                    }
                    
                    // Use override values from my_collection if available, otherwise use card table values
                    const displayCardNumber = item.card_number_override || card.card_number;
                    const displayVariant = item.variant_override || card.variant;
                    const displayIsRookie = item.is_rookie !== null ? item.is_rookie : card.is_rookie;
                    
                    cardElement.innerHTML = `
                        <button class="delete-card-btn" onclick="event.stopPropagation(); deleteCard(${item.collection_id})" title="Delete Card">üóëÔ∏è</button>
                        <div class="card-image">
                            ${imageHTML}
                            ${item.grade ? `<div class="card-grade-badge">${item.grading_company} ${item.grade}</div>` : ''}
                            ${item.auto_grade >= 10 ? `<div class="card-grade-badge" style="background: linear-gradient(135deg, var(--cupboard-purple), #9333ea); top: 10px; left: 10px; right: auto;">AUTO 10</div>` : ''}
                        </div>
                        <div class="card-details">
                            <div class="card-title">${player.first_name} ${player.last_name}</div>
                            <div class="card-meta">
                                <div class="card-meta-row">
                                    <span>${set.year} ${manufacturer.name} ${set.set_name}</span>
                                </div>
                                <div class="card-meta-row">
                                    <span>#${displayCardNumber || 'N/A'}</span>
                                    <span>${item.cert_number || 'N/A'}</span>
                                </div>
                                ${displayIsRookie ? '<div style="color: var(--cupboard-gold);">‚≠ê ROOKIE CARD</div>' : ''}
                            </div>
                            ${item.purchase_price ? `<div class="card-price">$${item.purchase_price.toFixed(2)}</div>` : ''}
                        </div>
                    `;
                    
                    grid.appendChild(cardElement);
                });

                

            } catch (error) {
                console.error('Error loading collection:', error);
                loading.style.display = 'none';
                grid.innerHTML = `<div class="alert alert-error">Error loading collection: ${error.message}</div>`;
            }
        }

        // Show Card Details
        function showCardDetails(item) {
            currentCardItem = item; // Store for editing
            
            const card = item.cards;
            const player = card.players;
            const set = card.card_sets;
            const manufacturer = set.manufacturers;
            const primaryImage = item.card_images?.find(img => img.is_primary);
            
            console.log('Card images data:', item.card_images);
            console.log('Primary image:', primaryImage);

            const modal = document.getElementById('cardModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Show edit button since it's our card
            document.getElementById('editCardBtn').style.display = 'block';

            modalTitle.textContent = `${player.first_name} ${player.last_name}`;
            
            // Use override values if available
            const displayCardNumber = item.card_number_override || card.card_number;
            const displayVariant = item.variant_override || card.variant;
            const displayIsRookie = item.is_rookie !== null ? item.is_rookie : card.is_rookie;
            const displayIsAutograph = item.is_autograph !== null ? item.is_autograph : card.is_autograph;
            
            let imageHTML = '';
            if (primaryImage && primaryImage.image_url) {
                imageHTML = `
                    <div style="flex: 1; display: flex; justify-content: center; align-items: flex-start;">
                        <img src="${primaryImage.image_url}" alt="${player.first_name} ${player.last_name}" 
                             onclick="event.stopPropagation(); zoomImage('${primaryImage.image_url}')"
                             style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: zoom-in; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.05)'"
                             onmouseout="this.style.transform='scale(1)'">
                    </div>
                `;
            } else if (item.card_images && item.card_images.length > 0) {
                // Fallback to first image if no primary
                const firstImage = item.card_images[0];
                imageHTML = `
                    <div style="flex: 1; display: flex; justify-content: center; align-items: flex-start;">
                        <img src="${firstImage.image_url}" alt="${player.first_name} ${player.last_name}" 
                             onclick="event.stopPropagation(); zoomImage('${firstImage.image_url}')"
                             style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: zoom-in; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.05)'"
                             onmouseout="this.style.transform='scale(1)'">
                    </div>
                `;
            } else {
                // No image placeholder
                imageHTML = `
                    <div style="flex: 1; display: flex; justify-content: center; align-items: center; background: rgba(255,255,255,0.05); border-radius: 8px; min-height: 300px;">
                        <div style="text-align: center; color: rgba(255,255,255,0.3);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üé¥</div>
                            <div>No image available</div>
                        </div>
                    </div>
                `;
            }
            
            modalBody.innerHTML = `
                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 1rem;">
                        <div><strong>Set:</strong> ${set.year} ${manufacturer.name} ${set.set_name}</div>
                        <div><strong>Rarity:</strong> ${displayCardNumber || 'N/A'}</div>
                        ${displayVariant ? `<div><strong>Variant:</strong> ${displayVariant}</div>` : ''}
                        ${displayIsRookie ? '<div style="color: var(--cupboard-gold);"><strong>‚≠ê ROOKIE CARD</strong></div>' : ''}
                        ${displayIsAutograph ? '<div style="color: var(--cupboard-purple);"><strong>‚úçÔ∏è AUTOGRAPH</strong></div>' : ''}
                        ${item.grading_company ? `<div><strong>Grade:</strong> ${item.grading_company} ${item.grade}${item.auto_grade ? ` / Auto ${item.auto_grade}` : ''}</div>` : ''}
                        ${item.cert_number ? `<div><strong>Cert #:</strong> ${item.cert_number}</div>` : ''}
                        <div><strong>Condition:</strong> ${item.condition || 'N/A'}</div>
                        ${item.purchase_price ? `<div><strong>Purchase Price:</strong> $${item.purchase_price.toFixed(2)}</div>` : ''}
                        ${item.purchase_date ? `<div><strong>Purchase Date:</strong> ${item.purchase_date}</div>` : ''}
                        <div><strong>Quantity:</strong> ${item.quantity}</div>
                        ${item.notes ? `<div><strong>Notes:</strong> ${item.notes}</div>` : ''}
                        <div><strong>Added:</strong> ${new Date(item.added_at).toLocaleDateString()}</div>
                    </div>
                    ${imageHTML}
                </div>
            `;

            modal.classList.add('active');
            
            // Check if variant is KABOOM and trigger fireworks
            if (displayVariant && displayVariant.toLowerCase().includes('kaboom')) {
                setTimeout(() => triggerFireworks(), 300);
            }
        }

        // Close Modal
        function closeCardModal() {
            document.getElementById('cardModal').classList.remove('active');
            currentCardItem = null;
        }

        // Edit Card
        function editCard() {
            if (!currentCardItem) return;

            const item = currentCardItem;
            const card = item.cards;
            const player = card.players;
            const set = card.card_sets;
            const manufacturer = set.manufacturers;
            
            // Switch to Add Card tab
            switchTab('add');
            
            // Close the modal
            closeCardModal();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Pre-fill ALL form fields
            setTimeout(() => {
                // Player & Set Info - use sport override if available
                const displaySportId = item.sport_override_id || player.sport_id;
                document.getElementById('sportSelect').value = displaySportId;
                document.getElementById('playerFirstName').value = player.first_name;
                document.getElementById('playerLastName').value = player.last_name;
                document.getElementById('manufacturerSelect').value = manufacturer.manufacturer_id;
                document.getElementById('setName').value = set.set_name;
                document.getElementById('setYear').value = set.year;
                
                // Card Details - use override values if available
                document.getElementById('cardNumber').value = item.card_number_override || card.card_number || '';
                document.getElementById('cardVariant').value = item.variant_override || card.variant || '';
                document.getElementById('isRookie').value = (item.is_rookie !== null ? item.is_rookie : card.is_rookie) ? 'true' : 'false';
                document.getElementById('isAutograph').value = (item.is_autograph !== null ? item.is_autograph : card.is_autograph) ? 'true' : 'false';
                
                // Editable Collection Details
                document.getElementById('condition').value = item.condition || '';
                document.getElementById('gradingCompany').value = item.grading_company || '';
                document.getElementById('grade').value = item.grade || '';
                document.getElementById('autoGrade').value = item.auto_grade || '';
                document.getElementById('certNumber').value = item.cert_number || '';
                document.getElementById('purchasePrice').value = item.purchase_price || '';
                document.getElementById('purchaseDate').value = item.purchase_date || '';
                document.getElementById('quantity').value = item.quantity || 1;
                document.getElementById('notes').value = item.notes || '';
                document.getElementById('cardFolder').value = item.folder_id || '';
                
                // Show existing image
                const primaryImage = item.card_images?.find(img => img.is_primary);
                if (primaryImage && primaryImage.image_url) {
                    const imagePreview = document.getElementById('imagePreview');
                    const previewImg = document.getElementById('previewImg');
                    previewImg.src = primaryImage.image_url;
                    imagePreview.style.display = 'block';
                    
                    // Update the success message
                    imagePreview.querySelector('div').textContent = '‚úì Current image (click to change)';
                }
                
                // Remove required attribute from image input during edit
                document.getElementById('cardImage').removeAttribute('required');
                
                // Show an alert that they're editing
                const alertDiv = document.getElementById('addAlert');
                alertDiv.innerHTML = `
                    <div class="alert" style="background: rgba(255, 165, 0, 0.2); border: 2px solid #ffa500; color: #ffa500;">
                        ‚ö†Ô∏è Editing: ${player.first_name} ${player.last_name} - 
                        ${set.year} ${manufacturer.name} ${set.set_name}
                        <br><small>All fields are editable. Your personal tracking info will be updated.</small>
                    </div>
                `;
                
                // Set edit mode
                isEditMode = true;
                editingCollectionId = item.collection_id;
                
                // Change button text
                const submitBtn = document.getElementById('addCardForm').querySelector('button[type="submit"]');
                submitBtn.textContent = 'üíæ Update Card';
                submitBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            }, 100);
        }

        // Update Card
        async function updateCard(collectionId) {
            console.log('updateCard called with collectionId:', collectionId);
            
            const alertDiv = document.getElementById('addAlert');
            alertDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const sportId = parseInt(document.getElementById('sportSelect').value);
                const condition = document.getElementById('condition').value;
                const gradingCompany = document.getElementById('gradingCompany').value;
                const grade = document.getElementById('grade').value ? parseFloat(document.getElementById('grade').value) : null;
                const autoGrade = document.getElementById('autoGrade').value ? parseFloat(document.getElementById('autoGrade').value) : null;
                const certNumber = document.getElementById('certNumber').value;
                const purchasePrice = document.getElementById('purchasePrice').value ? parseFloat(document.getElementById('purchasePrice').value) : null;
                const purchaseDate = document.getElementById('purchaseDate').value || null;
                const quantity = parseInt(document.getElementById('quantity').value);
                const notes = document.getElementById('notes').value;
                const isRookie = document.getElementById('isRookie').value === 'true';
                const isAutograph = document.getElementById('isAutograph').value === 'true';
                const cardNumber = document.getElementById('cardNumber').value;
                const variant = document.getElementById('cardVariant').value;
                const folderId = document.getElementById('cardFolder').value || null;

                console.log('Update data:', {
                    sportId, condition, gradingCompany, grade, certNumber,
                    purchasePrice, purchaseDate, quantity, notes, isRookie,
                    isAutograph, cardNumber, variant, folderId
                });

                const { error } = await supabase
                    .from('my_collection')
                    .update({
                        condition: condition,
                        grade: grade,
                        auto_grade: autoGrade,
                        grading_company: gradingCompany,
                        cert_number: certNumber,
                        purchase_price: purchasePrice,
                        purchase_date: purchaseDate,
                        quantity: quantity,
                        notes: notes,
                        is_rookie: isRookie,
                        is_autograph: isAutograph,
                        card_number_override: cardNumber,
                        variant_override: variant,
                        sport_override_id: sportId,
                        folder_id: folderId
                    })
                    .eq('collection_id', collectionId);

                if (error) throw error;

                console.log('Update successful');
                
                alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Card updated successfully!</div>';
                
                // Reset edit mode
                isEditMode = false;
                editingCollectionId = null;
                
                // Re-add required attribute to image input for new cards
                document.getElementById('cardImage').setAttribute('required', '');
                
                // Reload the page to reset everything properly and avoid duplicates
                setTimeout(() => {
                    location.reload();
                }, 1000);

            } catch (error) {
                console.error('Error updating card:', error);
                alertDiv.innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Delete Card
        async function deleteCard(collectionId) {
            if (!confirm('Are you sure you want to delete this card from your collection?')) {
                return;
            }

            try {
                console.log('Deleting card with collection_id:', collectionId);

                // First, delete associated images from storage and database
                const { data: images } = await supabase
                    .from('card_images')
                    .select('image_url')
                    .eq('collection_id', collectionId);

                if (images && images.length > 0) {
                    for (const image of images) {
                        // Extract file path from URL
                        const url = new URL(image.image_url);
                        const pathParts = url.pathname.split('/');
                        const fileName = pathParts[pathParts.length - 1];
                        
                        // Delete from storage
                        await supabase.storage
                            .from('card-images')
                            .remove([fileName]);
                    }
                }

                // Delete the collection item (images will cascade delete due to foreign key)
                const { error } = await supabase
                    .from('my_collection')
                    .delete()
                    .eq('collection_id', collectionId);

                if (error) throw error;

                console.log('Card deleted successfully');
                
                // Reload the collection
                loadCollection();
                
                // Refresh dashboard timeline
                refreshDashboardTimeline();

            } catch (error) {
                console.error('Error deleting card:', error);
                alert('Error deleting card: ' + error.message);
            }
        }

        // LEADERBOARD FUNCTIONS

        // Load User Profile
        // Load Leaderboard
        // Collectors Score Algorithm
        function calculateCollectorScore(card) {
            // 1. Rarity Points
            let rarityPoints = 10; // Default base
            const rarity = (card.card_number_override || card.cards?.card_number || '').toLowerCase();
            
            // Extract the number from the rarity (e.g., "/15" -> 15)
            let rarityNum = null;
            const match = rarity.match(/\/(\d+)/);
            if (match) {
                rarityNum = parseInt(match[1]);
            }

            // Assign points based on ranges
            if (rarity.includes('1/1')) rarityPoints = 1000;
            else if (rarityNum !== null) {
                if (rarityNum >= 2 && rarityNum <= 4) rarityPoints = 750;
                else if (rarityNum >= 5 && rarityNum <= 7) rarityPoints = 600;
                else if (rarityNum >= 8 && rarityNum <= 10) rarityPoints = 500;
                else if (rarityNum >= 11 && rarityNum <= 15) rarityPoints = 400;
                else if (rarityNum >= 16 && rarityNum <= 25) rarityPoints = 350;
                else if (rarityNum >= 26 && rarityNum <= 35) rarityPoints = 275;
                else if (rarityNum >= 36 && rarityNum <= 49) rarityPoints = 225;
                else if (rarityNum >= 50 && rarityNum <= 75) rarityPoints = 175;
                else if (rarityNum >= 76 && rarityNum <= 99) rarityPoints = 150;
                else if (rarityNum >= 100 && rarityNum <= 149) rarityPoints = 100;
                else if (rarityNum >= 150 && rarityNum <= 199) rarityPoints = 75;
                else if (rarityNum >= 200 && rarityNum <= 299) rarityPoints = 50;
                else if (rarityNum >= 300 && rarityNum <= 499) rarityPoints = 35;
                else if (rarityNum >= 500) rarityPoints = 20;
            }
            else if (rarity.includes('case hit')) rarityPoints = 400;
            else if (rarity.includes('ssp')) rarityPoints = 250;
            else if (rarity.includes('sp')) rarityPoints = 100;

            // 2. Special Bonuses
            let bonusPoints = 0;
            const isRookie = card.is_rookie !== null ? card.is_rookie : card.cards?.is_rookie;
            const isAuto = card.is_autograph !== null ? card.is_autograph : card.cards?.is_autograph;
            
            if (isRookie) bonusPoints += 200;
            if (isAuto) bonusPoints += 300;
            if (isRookie && isAuto) bonusPoints += 100; // Combo bonus

            // 3. Grade Multiplier
            let gradeMultiplier = 1.0;
            const grade = card.grade;
            const gradingCompany = card.grading_company;
            
            if (gradingCompany && grade) {
                if (grade >= 10) gradeMultiplier = 2.5;
                else if (grade >= 9.5) gradeMultiplier = 2.0;
                else if (grade >= 9) gradeMultiplier = 1.75;
                else if (grade >= 8.5) gradeMultiplier = 1.5;
                else if (grade >= 8) gradeMultiplier = 1.3;
                else if (grade >= 7) gradeMultiplier = 1.15;
                else if (grade >= 6) gradeMultiplier = 1.05;
            }

            // 3b. Auto Grade Multiplier (additional 1.5x for Auto 10)
            let autoGradeMultiplier = 1.0;
            const autoGrade = card.auto_grade;
            
            if (autoGrade && autoGrade >= 10) {
                autoGradeMultiplier = 1.5;
            }

            // 4. Premium Set Multiplier
            let setMultiplier = 1.0;
            const setName = (card.cards?.card_sets?.set_name || '').toLowerCase();
            const manufacturer = (card.cards?.card_sets?.manufacturers?.name || '').toLowerCase();
            const year = card.cards?.card_sets?.year;

            // S-Tier (3.5x)
            if ((year === 2014 && manufacturer.includes('panini') && setName.includes('prizm') && setName.includes('world cup')) ||
                (year === 2017 && manufacturer.includes('topps') && setName.includes('chrome')) ||
                (manufacturer.includes('panini') && setName.includes('flawless')) ||
                (manufacturer.includes('panini') && setName.includes('eminence'))) {
                setMultiplier = 3.5;
            }
            // A-Tier (2.5x)
            else if ((manufacturer.includes('panini') && setName.includes('national treasures')) ||
                     (manufacturer.includes('topps') && setName.includes('stadium club')) ||
                     (manufacturer.includes('topps') && setName.includes('inception')) ||
                     (manufacturer.includes('topps') && setName.includes('sapphire')) ||
                     (year === 2018 && manufacturer.includes('topps') && setName.includes('chrome')) ||
                     (year === 2019 && manufacturer.includes('topps') && setName.includes('chrome')) ||
                     (manufacturer.includes('panini') && setName.includes('prizm') && setName.includes('world cup') && year !== 2014)) {
                setMultiplier = 2.5;
            }
            // B-Tier (1.8x)
            else if ((manufacturer.includes('topps') && setName.includes('chrome') && year !== 2017 && year !== 2018 && year !== 2019) ||
                     (manufacturer.includes('panini') && setName.includes('prizm') && !setName.includes('world cup')) ||
                     (manufacturer.includes('panini') && setName.includes('immaculate')) ||
                     (manufacturer.includes('panini') && setName.includes('impeccable')) ||
                     (manufacturer.includes('panini') && setName.includes('select'))) {
                setMultiplier = 1.8;
            }
            // C-Tier (1.3x)
            else if ((manufacturer.includes('topps') && setName.includes('finest')) ||
                     (manufacturer.includes('panini') && setName.includes('obsidian')) ||
                     (manufacturer.includes('panini') && setName.includes('donruss')) ||
                     (manufacturer.includes('panini') && setName.includes('mosaic')) ||
                     (setName.includes('bowman'))) {
                setMultiplier = 1.3;
            }

            // 5. Player Tier Multiplier
            let playerMultiplier = 1.0; // Default D-Tier
            const player = card.cards?.players;
            const playerName = player ? `${player.first_name} ${player.last_name}`.toLowerCase() : '';

            // S-Tier (4.0x) - GOATs
            const sTier = ['lionel messi', 'cristiano ronaldo', 'pel√©', 'pele', 'diego maradona', 'ronaldo naz√°rio', 'ronaldo nazario', 'johan cruyff', 'zinedine zidane'];
            
            // A+ Tier (3.0x) - Elite Legends
            const aPlusTier = ['franz beckenbauer', 'alfredo di st√©fano', 'alfredo di stefano', 'ronaldinho', 'michel platini', 'ferenc pusk√°s', 'ferenc puskas', 'paolo maldini', 'thierry henry', 'xavi', 'andr√©s iniesta', 'andres iniesta', 'eus√©bio', 'eusebio', 'gerd m√ºller', 'gerd muller', 'george best', 'neymar', 'neymar jr', 'neymar jr.', 'luka modriƒá', 'luka modric', 'bobby charlton', 'lev yashin', 'franco baresi', 'roberto baggio', 'ruud gullit', 'marco van basten', 'rivaldo', 'sergio ramos', 'roberto carlos', 'andrea pirlo', 'kak√°', 'kaka', 'clarence seedorf', 'philipp lahm', 'cafu', 'luis su√°rez', 'luis suarez', 'karim benzema'];
            
            // A-Tier (2.5x) - Elite Players
            const aTier = ['zlatan ibrahimoviƒá', 'zlatan ibrahimovic', 'dennis bergkamp', 'xabi alonso', 'steven gerrard', 'frank lampard', 'paul scholes', 'ronald koeman', 'alessandro del piero', 'francesco totti', 'ra√∫l', 'raul', 'manuel neuer', 'iker casillas', 'gianluigi buffon', 'didier drogba', 'samuel eto\'o', 'samuel etoo', 'wayne rooney', 'ryan giggs', 'arjen robben', 'franck rib√©ry', 'franck ribery', 'luis figo', 'patrick vieira', 'claude mak√©l√©l√©', 'claude makelele', 'thiago silva', 'fabio cannavaro', 'nemanja vidiƒá', 'nemanja vidic', 'virgil van dijk', 'kevin de bruyne', 'mohamed salah', 'robert lewandowski', 'thomas m√ºller', 'thomas muller'];
            
            // B-Tier (2.0x) - Top Quality
            const bTier = ['erling haaland', 'kylian mbapp√©', 'kylian mbappe', 'harry kane', 'son heung-min', 'sergio ag√ºero', 'sergio aguero', 'david beckham', 'fernando torres', 'carlos tevez', 'wesley sneijder', 'pavel nedvƒõd', 'pavel nedved', 'michael ballack', 'juan rom√°n riquelme', 'juan roman riquelme', 'dani alves', 'marcelo', 'gerard piqu√©', 'gerard pique', 'carles puyol', 'giorgio chiellini', 'leonardo bonucci', 'toni kroos', 'sadio man√©', 'sadio mane', 'eden hazard', 'riyad mahrez', 'bruno fernandes', '√°ngel di mar√≠a', 'angel di maria', 'mesut √∂zil', 'mesut ozil', 'marco reus', 'robin van persie', 'radamel falcao', 'james rodr√≠guez', 'james rodriguez', 'antoine griezmann'];
            
            // C-Tier (1.5x) - Solid Players
            const cTier = ['bernardo silva', 'rodri', 'joshua kimmich', 'declan rice', 'n\'golo kant√©', 'ngolo kante', 'arturo vidal', 'paul pogba', 'david silva', 'cesc f√†bregas', 'cesc fabregas', 'fernandinho', 'casemiro', 'ivan rakitiƒá', 'ivan rakitic', 'henrikh mkhitaryan', 'lautaro mart√≠nez', 'lautaro martinez', 'romelu lukaku', 'pierre-emerick aubameyang', 'jamie vardy', 'isco', 'jo√£o f√©lix', 'joao felix', 'jude bellingham', 'pedri', 'phil foden', 'bukayo saka', 'jack grealish', 'rafael le√£o', 'rafael leao', 'victor osimhen', 'achraf hakimi', 'theo hern√°ndez', 'theo hernandez', 'matthijs de ligt', 'william saliba'];

            if (sTier.includes(playerName)) {
                playerMultiplier = 4.0;
            } else if (aPlusTier.includes(playerName)) {
                playerMultiplier = 3.0;
            } else if (aTier.includes(playerName)) {
                playerMultiplier = 2.5;
            } else if (bTier.includes(playerName)) {
                playerMultiplier = 2.0;
            } else if (cTier.includes(playerName)) {
                playerMultiplier = 1.5;
            }

            // Calculate final score with all multipliers
            const score = (rarityPoints + bonusPoints) * gradeMultiplier * autoGradeMultiplier * setMultiplier * playerMultiplier;
            return Math.round(score);
        }

        // Load Achievements
        async function loadAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            const unlockedCount = document.getElementById('unlockedCount');
            const lockedCount = document.getElementById('lockedCount');
            const completionRate = document.getElementById('completionRate');

            try {
                // Calculate user's stats
                const { data: cards, error } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        )
                    `)
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_sold', false);

                if (error) throw error;

                // Calculate collection stats
                let totalScore = 0;
                let totalCards = cards?.length || 0;
                let gradedCards = 0;
                let rookieCards = 0;
                let autographCards = 0;
                let psa10Cards = 0;

                if (cards && cards.length > 0) {
                    cards.forEach(card => {
                        totalScore += calculateCollectorScore(card);
                        if (card.grading_company) gradedCards++;
                        if (card.is_rookie || card.cards?.is_rookie) rookieCards++;
                        if (card.is_autograph || card.cards?.is_autograph) autographCards++;
                        if (card.grading_company && card.grade >= 10) psa10Cards++;
                    });
                }

                // Get sales count
                const { count: salesCount } = await supabase
                    .from('sales_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('auth_user_id', currentUser.id);

                // Define all achievements
                const achievements = [
                    {
                        id: 'rising_star',
                        name: 'üåü Rising Star',
                        description: 'Reach 10,000 Collector Score',
                        requirement: 10000,
                        current: totalScore,
                        unlocked: totalScore >= 10000,
                        tier: 'gold',
                        badge: '<span style="background: linear-gradient(135deg, #00FF00, #7FFF00); padding: 0.4rem 1rem; border-radius: 25px; font-size: 0.85rem; font-weight: bold; color: #000; box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);">üåü RISING STAR</span>'
                    },
                    {
                        id: 'elite_collector',
                        name: 'üíé Elite Collector',
                        description: 'Reach 100,000 Collector Score',
                        requirement: 100000,
                        current: totalScore,
                        unlocked: totalScore >= 100000,
                        tier: 'elite',
                        badge: '<span style="background: linear-gradient(135deg, #FF00FF, #00FFFF); padding: 0.4rem 1rem; border-radius: 25px; font-size: 0.85rem; font-weight: bold; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); animation: pulse 2s infinite;">üíé ELITE COLLECTOR</span>'
                    },
                    {
                        id: 'first_card',
                        name: 'üé¥ First Card',
                        description: 'Add your first card to the collection',
                        requirement: 1,
                        current: totalCards,
                        unlocked: totalCards >= 1,
                        tier: 'bronze'
                    },
                    {
                        id: 'collector_10',
                        name: 'üìö Collector',
                        description: 'Own 10 cards',
                        requirement: 10,
                        current: totalCards,
                        unlocked: totalCards >= 10,
                        tier: 'bronze'
                    },
                    {
                        id: 'collector_50',
                        name: 'üì¶ Serious Collector',
                        description: 'Own 50 cards',
                        requirement: 50,
                        current: totalCards,
                        unlocked: totalCards >= 50,
                        tier: 'silver'
                    },
                    {
                        id: 'collector_100',
                        name: 'üèõÔ∏è Master Collector',
                        description: 'Own 100 cards',
                        requirement: 100,
                        current: totalCards,
                        unlocked: totalCards >= 100,
                        tier: 'gold'
                    },
                    {
                        id: 'graded_1',
                        name: '‚≠ê First Graded',
                        description: 'Add your first graded card',
                        requirement: 1,
                        current: gradedCards,
                        unlocked: gradedCards >= 1,
                        tier: 'bronze'
                    },
                    {
                        id: 'graded_10',
                        name: 'üèÖ Grading Expert',
                        description: 'Own 10 graded cards',
                        requirement: 10,
                        current: gradedCards,
                        unlocked: gradedCards >= 10,
                        tier: 'silver'
                    },
                    {
                        id: 'psa_10',
                        name: 'üíØ Pristine',
                        description: 'Own a PSA 10 (or BGS 10) card',
                        requirement: 1,
                        current: psa10Cards,
                        unlocked: psa10Cards >= 1,
                        tier: 'gold'
                    },
                    {
                        id: 'rookie_1',
                        name: 'üåü Rookie Hunter',
                        description: 'Own your first rookie card',
                        requirement: 1,
                        current: rookieCards,
                        unlocked: rookieCards >= 1,
                        tier: 'bronze'
                    },
                    {
                        id: 'rookie_10',
                        name: '‚≠ê Rookie Master',
                        description: 'Own 10 rookie cards',
                        requirement: 10,
                        current: rookieCards,
                        unlocked: rookieCards >= 10,
                        tier: 'gold'
                    },
                    {
                        id: 'auto_1',
                        name: '‚úçÔ∏è Autograph Collector',
                        description: 'Own your first autograph card',
                        requirement: 1,
                        current: autographCards,
                        unlocked: autographCards >= 1,
                        tier: 'silver'
                    },
                    {
                        id: 'auto_5',
                        name: '‚ú® Signature Expert',
                        description: 'Own 5 autograph cards',
                        requirement: 5,
                        current: autographCards,
                        unlocked: autographCards >= 5,
                        tier: 'gold'
                    },
                    {
                        id: 'first_sale',
                        name: 'üí∞ First Sale',
                        description: 'Record your first card sale',
                        requirement: 1,
                        current: salesCount || 0,
                        unlocked: (salesCount || 0) >= 1,
                        tier: 'bronze'
                    },
                    {
                        id: 'trader_10',
                        name: 'üìà Active Trader',
                        description: 'Record 10 sales',
                        requirement: 10,
                        current: salesCount || 0,
                        unlocked: (salesCount || 0) >= 10,
                        tier: 'silver'
                    }
                ];

                // Calculate stats
                const unlockedAchievements = achievements.filter(a => a.unlocked);
                const lockedAchievements = achievements.filter(a => !a.unlocked);
                const completion = Math.round((unlockedAchievements.length / achievements.length) * 100);

                unlockedCount.textContent = unlockedAchievements.length;
                lockedCount.textContent = lockedAchievements.length;
                completionRate.textContent = completion + '%';

                // Sort achievements: unlocked first, then locked
                const sortedAchievements = [...unlockedAchievements, ...lockedAchievements];

                // Render achievements with divider
                let achievementsHTML = '';
                
                // Unlocked achievements
                if (unlockedAchievements.length > 0) {
                    achievementsHTML += '<div style="margin-bottom: 1rem; padding-bottom: 1rem;"><h3 style="font-family: \'Bebas Neue\', sans-serif; color: var(--cupboard-gold); font-size: 1.5rem; letter-spacing: 1px; margin-bottom: 1rem;">üèÜ UNLOCKED ACHIEVEMENTS</h3></div>';
                    
                    achievementsHTML += sortedAchievements.filter(a => a.unlocked).map(achievement => {
                        const isUnlocked = true;
                        
                        let tierColor = 'rgba(205, 127, 50, 0.3)';
                        if (achievement.tier === 'silver') tierColor = 'rgba(192, 192, 192, 0.3)';
                        if (achievement.tier === 'gold') tierColor = 'rgba(255, 215, 0, 0.3)';
                        if (achievement.tier === 'elite') tierColor = 'rgba(255, 0, 255, 0.3)';

                        return `
                            <div style="background: linear-gradient(135deg, rgba(30, 144, 255, 0.15), rgba(138, 43, 226, 0.15)); 
                                        border: 2px solid ${tierColor}; 
                                        border-radius: 12px; 
                                        padding: 1.5rem;
                                        margin-bottom: 1rem;
                                        position: relative;
                                        overflow: hidden;">
                                
                                ${achievement.badge ? '<div style="position: absolute; top: 10px; right: 10px;">' + achievement.badge + '</div>' : ''}
                                
                                <div style="display: flex; gap: 1.5rem; align-items: center;">
                                    <div style="font-size: 4rem;">
                                        ${achievement.name.split(' ')[0]}
                                    </div>
                                    
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem;">
                                            ${achievement.name.substring(achievement.name.indexOf(' ') + 1)}
                                        </div>
                                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">
                                            ${achievement.description}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--cupboard-green); font-weight: bold;">
                                            <span style="font-size: 1.2rem;">‚úÖ</span>
                                            <span>Unlocked!</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Locked achievements with divider
                if (lockedAchievements.length > 0) {
                    achievementsHTML += `
                        <div style="margin: 2rem 0; padding: 1.5rem 0; border-top: 2px solid rgba(255,255,255,0.1);">
                            <h3 style="font-family: 'Bebas Neue', sans-serif; color: rgba(255,255,255,0.5); font-size: 1.5rem; letter-spacing: 1px; margin-bottom: 1rem;">üîí LOCKED ACHIEVEMENTS</h3>
                        </div>
                    `;
                    
                    achievementsHTML += sortedAchievements.filter(a => !a.unlocked).map(achievement => {
                        const progress = Math.min((achievement.current / achievement.requirement) * 100, 100);
                        const isUnlocked = false;
                        
                        let tierColor = 'rgba(205, 127, 50, 0.3)';
                        if (achievement.tier === 'silver') tierColor = 'rgba(192, 192, 192, 0.3)';
                        if (achievement.tier === 'gold') tierColor = 'rgba(255, 215, 0, 0.3)';
                        if (achievement.tier === 'elite') tierColor = 'rgba(255, 0, 255, 0.3)';

                        return `
                            <div style="background: rgba(255,255,255,0.03); 
                                        border: 2px solid rgba(255,255,255,0.1); 
                                        border-radius: 12px; 
                                        padding: 1.5rem;
                                        opacity: 0.5;
                                        margin-bottom: 1rem;
                                        position: relative;
                                        overflow: hidden;">
                                
                                <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">üîí LOCKED</div>
                                
                                <div style="display: flex; gap: 1.5rem; align-items: center;">
                                    <div style="font-size: 4rem; filter: grayscale(100%) brightness(0.5);">
                                        ${achievement.name.split(' ')[0]}
                                    </div>
                                    
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.3rem; font-weight: bold; color: rgba(255,255,255,0.4); margin-bottom: 0.5rem;">
                                            ${achievement.name.substring(achievement.name.indexOf(' ') + 1)}
                                        </div>
                                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">
                                            ${achievement.description}
                                        </div>
                                        <div style="margin-bottom: 0.5rem;">
                                            <div style="background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; overflow: hidden;">
                                                <div style="background: linear-gradient(90deg, var(--cupboard-blue), var(--cupboard-purple)); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                            </div>
                                        </div>
                                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                            Progress: ${achievement.current} / ${achievement.requirement}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                achievementsList.innerHTML = achievementsHTML;

            } catch (error) {
                console.error('Error loading achievements:', error);
                achievementsList.innerHTML = '<div class="alert alert-error">Error loading achievements: ' + error.message + '</div>';
            }
        }

        // Initialize Stripe
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        // Load Shop
        async function loadShop() {
            const shopGrid = document.getElementById('shopGrid');
            const shopBannerGrid = document.getElementById('shopBannerGrid');

            try {
                // Load shop items
                const { data: items, error: itemsError } = await supabase
                    .from('shop_items')
                    .select('*')
                    .eq('is_active', true)
                    .order('price', { ascending: true });

                if (itemsError) throw itemsError;

                // Load user's purchases
                const { data: purchases, error: purchasesError } = await supabase
                    .from('user_purchases')
                    .select('*, shop_items(*)')
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_active', true);

                if (purchasesError) throw purchasesError;

                const purchasedBadgeIds = purchases ? purchases.map(p => p.badge_id) : [];

                // Render shop items
                shopGrid.innerHTML = items.map(item => {
                    const isPurchased = purchasedBadgeIds.includes(item.badge_id);
                    
                    let tierColor = 'rgba(30, 144, 255, 0.3)';
                    if (item.tier === 'rare') tierColor = 'rgba(138, 43, 226, 0.3)';
                    if (item.tier === 'epic') tierColor = 'rgba(255, 0, 255, 0.3)';
                    if (item.tier === 'legendary') tierColor = 'rgba(255, 215, 0, 0.3)';

                    return `
                        <div style="background: linear-gradient(135deg, rgba(30, 144, 255, 0.1), rgba(138, 43, 226, 0.1)); border: 2px solid ${tierColor}; border-radius: 12px; padding: 2rem; text-align: center; position: relative;">
                            ${isPurchased ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--cupboard-green); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold;">‚úì OWNED</div>' : ''}
                            
                            <div style="font-size: 5rem; margin-bottom: 1rem;">${item.badge_emoji}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">${item.badge_name}</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 1.5rem; min-height: 40px;">${item.description}</div>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-green); margin-bottom: 1rem;">$${item.price.toFixed(2)}</div>
                            
                            ${isPurchased ? 
                                '<button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">Already Owned</button>' :
                                `<button class="btn" onclick="purchaseBadge('${item.item_id}', '${item.stripe_price_id}', '${item.badge_id}')" style="background: linear-gradient(135deg, var(--cupboard-green), #00D084); font-weight: bold;">üõí BUY NOW</button>`
                            }
                        </div>
                    `;
                }).join('');

                // Load premium banners in shop
                await loadShopBanners();

                // Load mascots in shop
                await loadShopMascots();

            } catch (error) {
                console.error('Error loading shop:', error);
                shopGrid.innerHTML = '<div class="alert alert-error">Error loading shop: ' + error.message + '</div>';
            }
        }

        // Load Premium Banners in Shop
        async function loadShopBanners() {
            const shopBannerGrid = document.getElementById('shopBannerGrid');
            
            // Get user's owned banners
            const { data: profile } = await supabase
                .from('user_profiles')
                .select('owned_banners')
                .eq('auth_user_id', currentUser.id)
                .single();
            
            const ownedBanners = profile?.owned_banners ? JSON.parse(profile.owned_banners) : [];

            // Premium banners only (not free ones)
            const premiumBanners = [
                {
                    id: 'rainbow',
                    name: 'üåà Rainbow Elite',
                    gradient: 'linear-gradient(135deg, rgba(255, 0, 0, 0.4), rgba(255, 127, 0, 0.4), rgba(255, 255, 0, 0.4), rgba(0, 255, 0, 0.4), rgba(0, 0, 255, 0.4), rgba(75, 0, 130, 0.4), rgba(148, 0, 211, 0.4))',
                    price: 2.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_rainbow',
                    tier: 'premium',
                    description: 'Full spectrum gradient - show your true colors!'
                },
                {
                    id: 'sunset',
                    name: 'üåÖ Sunset Vibes',
                    gradient: 'linear-gradient(135deg, rgba(255, 94, 77, 0.5), rgba(255, 154, 158, 0.4), rgba(250, 208, 196, 0.3), rgba(255, 183, 77, 0.4), rgba(255, 138, 101, 0.5))',
                    price: 2.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_sunset',
                    tier: 'premium',
                    description: 'Warm sunset gradient - luxury coastal vibes'
                },
                {
                    id: 'neon',
                    name: '‚ö° Neon City',
                    gradient: 'linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(255, 0, 255, 0.5), rgba(0, 255, 255, 0.5))',
                    price: 3.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_neon',
                    tier: 'epic',
                    description: 'Cyberpunk neon glow - electric and futuristic'
                },
                {
                    id: 'aurora',
                    name: '‚ú® Aurora Borealis',
                    gradient: 'radial-gradient(ellipse at top, rgba(0, 255, 136, 0.4), transparent 50%), radial-gradient(ellipse at bottom, rgba(138, 43, 226, 0.4), transparent 50%), linear-gradient(135deg, rgba(0, 200, 255, 0.3), rgba(100, 255, 200, 0.3), rgba(138, 43, 226, 0.3))',
                    price: 4.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_aurora',
                    tier: 'legendary',
                    description: 'Northern lights mystique - ethereal and mesmerizing'
                },
                {
                    id: 'galaxy',
                    name: 'üåå Cosmic Galaxy',
                    gradient: 'radial-gradient(ellipse at 20% 30%, rgba(138, 43, 226, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 80% 60%, rgba(255, 0, 128, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 40% 80%, rgba(0, 150, 255, 0.5) 0%, transparent 40%), linear-gradient(135deg, rgba(10, 10, 40, 0.8), rgba(30, 0, 60, 0.8))',
                    price: 5.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_galaxy',
                    tier: 'legendary',
                    description: 'Deep space nebula - infinite cosmic beauty'
                }
            ];

            shopBannerGrid.innerHTML = premiumBanners.map(banner => {
                const isOwned = ownedBanners.includes(banner.id);
                
                const tierColor = {
                    'premium': 'rgba(0, 255, 136, 0.5)',
                    'epic': 'rgba(138, 43, 226, 0.7)',
                    'legendary': 'rgba(255, 215, 0, 0.7)'
                };
                
                return `
                    <div style="background: var(--cupboard-dark); border: 2px solid ${tierColor[banner.tier]}; border-radius: 12px; overflow: hidden; transition: all 0.3s; ${!isOwned ? 'box-shadow: 0 0 20px ' + tierColor[banner.tier] + ';' : ''} position: relative;">
                        ${isOwned ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--cupboard-green); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 10;">‚úì OWNED</div>' : ''}
                        ${!isOwned && banner.tier === 'legendary' ? '<div style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #FFD700, #FFA500); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: #000; animation: pulse 2s infinite; z-index: 10;">‚≠ê LEGENDARY</div>' : ''}
                        ${!isOwned && banner.tier === 'epic' ? '<div style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #8A2BE2, #9333ea); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 10;">üíé EPIC</div>' : ''}
                        ${!isOwned && banner.tier === 'premium' ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--cupboard-green); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 10;">üîí PREMIUM</div>' : ''}
                        
                        <div style="height: 140px; background: ${banner.gradient}; position: relative;"></div>
                        <div style="padding: 1.5rem; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif;">${banner.name}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem; min-height: 40px;">${banner.description}</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--cupboard-green); margin-bottom: 1rem;">$${banner.price.toFixed(2)}</div>
                            
                            ${isOwned ? 
                                '<button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">Already Owned</button>' :
                                `<button class="btn" onclick="purchaseBanner('${banner.id}', '${banner.stripeUrl}')" style="background: linear-gradient(135deg, var(--cupboard-green), #00D084); font-weight: bold;">üõí BUY NOW</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Purchase Banner
        function purchaseBanner(bannerId, stripeUrl) {
            // Check if using placeholder URL
            if (stripeUrl.includes('placeholder') || !stripeUrl.startsWith('https://buy.stripe.com/')) {
                alert(
                    'üöß Payment Not Configured\n\n' +
                    'This banner is not available for purchase yet.\n\n' +
                    'The site owner needs to:\n' +
                    '1. Create Stripe Payment Links\n' +
                    '2. Replace placeholder URLs in the code\n\n' +
                    'Contact the admin for more info!'
                );
                return;
            }
            
            const proceed = confirm(
                'üé® Purchase Premium Banner\n\n' +
                'You will be redirected to Stripe to complete your purchase.\n\n' +
                '‚ö†Ô∏è IMPORTANT: After payment, return to the Customize Profile tab to activate your banner.\n\n' +
                'Click OK to proceed to payment.'
            );
            
            if (proceed) {
                // Store purchase info
                sessionStorage.setItem('pendingBannerPurchase', JSON.stringify({
                    bannerId: bannerId,
                    userId: currentUser.id,
                    timestamp: Date.now()
                }));
                
                // Redirect to Stripe
                window.location.href = stripeUrl;
            }
        }

        // Load Shop Mascots
        async function loadShopMascots() {
            const shopMascotGrid = document.getElementById('shopMascotGrid');
            
            // Get user's owned mascots
            const { data: profile } = await supabase
                .from('user_profiles')
                .select('owned_mascots')
                .eq('auth_user_id', currentUser.id)
                .single();
            
            const ownedMascots = profile?.owned_mascots ? JSON.parse(profile.owned_mascots) : [];

            // Available mascots
            const mascots = [
                {
                    id: 'viking',
                    name: 'üßò The Viking',
                    imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/viking.png',
                    price: 4.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_mascot_viking',
                    tier: 'legendary',
                    description: 'Zen warrior in meditation - peaceful strength'
                },
                {
                    id: 'magician',
                    name: 'üé© The Magician',
                    imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/magician.png',
                    price: 4.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_mascot_magician',
                    tier: 'legendary',
                    description: 'Iconic celebration - pure magic on the field'
                },
                {
                    id: 'calm',
                    name: '‚ö° The Calm',
                    imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/calm.png',
                    price: 4.99,
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_mascot_calm',
                    tier: 'legendary',
                    description: 'Iconic celebration - unstoppable force'
                }
            ];

            shopMascotGrid.innerHTML = mascots.map(mascot => {
                const isOwned = ownedMascots.includes(mascot.id);
                
                const tierColor = {
                    'standard': 'rgba(30, 144, 255, 0.5)',
                    'epic': 'rgba(138, 43, 226, 0.7)',
                    'legendary': 'rgba(255, 215, 0, 0.7)'
                };
                
                return `
                    <div style="background: var(--cupboard-dark); border: 2px solid ${tierColor[mascot.tier]}; border-radius: 12px; overflow: hidden; transition: all 0.3s; ${!isOwned ? 'box-shadow: 0 0 20px ' + tierColor[mascot.tier] + ';' : ''} position: relative;">
                        ${isOwned ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--cupboard-green); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 10;">‚úì OWNED</div>' : ''}
                        ${!isOwned && mascot.tier === 'legendary' ? '<div style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #FFD700, #FFA500); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: #000; animation: pulse 2s infinite; z-index: 10;">‚≠ê LEGENDARY</div>' : ''}
                        
                        <div style="height: 200px; background: linear-gradient(135deg, rgba(30, 144, 255, 0.1), rgba(138, 43, 226, 0.1)); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                            <img src="${mascot.imageUrl}" alt="${mascot.name}" style="max-height: 160px; max-width: 100%; object-fit: contain; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.3));">
                        </div>
                        <div style="padding: 1.5rem; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif;">${mascot.name}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem; min-height: 40px;">${mascot.description}</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--cupboard-green); margin-bottom: 1rem;">$${mascot.price.toFixed(2)}</div>
                            
                            ${isOwned ? 
                                '<button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">Already Owned</button>' :
                                `<button class="btn" onclick="purchaseMascot('${mascot.id}', '${mascot.stripeUrl}')" style="background: linear-gradient(135deg, var(--cupboard-green), #00D084); font-weight: bold;">üõí BUY NOW</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Purchase Mascot
        function purchaseMascot(mascotId, stripeUrl) {
            // Check if using placeholder URL
            if (stripeUrl.includes('placeholder') || !stripeUrl.startsWith('https://buy.stripe.com/')) {
                alert(
                    'üöß Payment Not Configured\n\n' +
                    'This mascot is not available for purchase yet.\n\n' +
                    'The site owner needs to:\n' +
                    '1. Create Stripe Payment Links\n' +
                    '2. Replace placeholder URLs in the code\n\n' +
                    'Contact the admin for more info!'
                );
                return;
            }
            
            const proceed = confirm(
                'üé≠ Purchase Mascot\n\n' +
                'You will be redirected to Stripe to complete your purchase.\n\n' +
                '‚ö†Ô∏è IMPORTANT: After payment, return to the Customize Profile tab to equip your mascot.\n\n' +
                'Click OK to proceed to payment.'
            );
            
            if (proceed) {
                // Store purchase info
                sessionStorage.setItem('pendingMascotPurchase', JSON.stringify({
                    mascotId: mascotId,
                    userId: currentUser.id,
                    timestamp: Date.now()
                }));
                
                // Redirect to Stripe
                window.location.href = stripeUrl;
            }
        }

        // Load Mascot Manager (Customize Profile)
        async function loadMascotManager() {
            const mascotManager = document.getElementById('mascotManager');
            
            try {
                // Get user's mascots
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('owned_mascots, active_mascot')
                    .eq('auth_user_id', currentUser.id)
                    .single();
                
                const ownedMascots = profile?.owned_mascots ? JSON.parse(profile.owned_mascots) : [];
                const activeMascot = profile?.active_mascot;

                // Mascot definitions
                const mascots = [
                    {
                        id: 'viking',
                        name: 'üßò The Viking',
                        imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/viking.png',
                        description: 'Zen warrior in meditation'
                    },
                    {
                        id: 'magician',
                        name: 'üé© The Magician',
                        imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/magician.png',
                        description: 'Iconic celebration'
                    },
                    {
                        id: 'calm',
                        name: '‚ö° The Calm',
                        imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/calm.png',
                        description: 'Iconic celebration'
                    }
                ];

                // Filter to owned mascots
                const ownedMascotsList = mascots.filter(m => ownedMascots.includes(m.id));

                if (ownedMascots.length > 0) {
                    mascotManager.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 1rem; background: rgba(138, 43, 226, 0.1); border: 2px solid var(--cupboard-purple); border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-weight: bold; color: var(--cupboard-purple); margin-bottom: 0.5rem;">‚ÑπÔ∏è How Mascots Work</div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Mascots appear between your name and stats on the leaderboard. Only one can be active at a time.</div>
                        </div>
                    ` + ownedMascotsList.map(mascot => {
                        const isActive = activeMascot === mascot.id;
                        return `
                            <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(30, 144, 255, 0.1)); border: 2px solid ${isActive ? 'var(--cupboard-gold)' : 'rgba(255,255,255,0.2)'}; border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.3s;">
                                <img src="${mascot.imageUrl}" alt="${mascot.name}" style="max-height: 120px; width: auto; object-fit: contain; margin-bottom: 1rem; filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.5));">
                                <div style="font-size: 1.1rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem;">${mascot.name}</div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 1rem;">${mascot.description}</div>
                                
                                <button class="btn" onclick="toggleMascot('${mascot.id}', ${!isActive})" style="width: 100%; ${isActive ? 'background: linear-gradient(135deg, #dc2626, #991b1b);' : 'background: linear-gradient(135deg, var(--cupboard-green), #00D084);'}">
                                    ${isActive ? '‚ùå UNEQUIP' : '‚úÖ EQUIP'}
                                </button>
                                
                                ${isActive ? '<div style="margin-top: 0.5rem; color: var(--cupboard-green); font-weight: bold; font-size: 0.9rem;">Currently Active</div>' : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    mascotManager.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: rgba(255,255,255,0.5); background: rgba(138, 43, 226, 0.05); border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üé≠</div>
                            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">No Mascots Yet</div>
                            <div style="font-size: 0.9rem;">Purchase mascots from the Shop tab to customize your profile!</div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading mascot manager:', error);
                mascotManager.innerHTML = '<div class="alert alert-error">Error loading mascots: ' + error.message + '</div>';
            }
        }

        // Toggle Mascot
        async function toggleMascot(mascotId, activate) {
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ active_mascot: activate ? mascotId : null })
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                const message = activate ? 'üé≠ Mascot equipped!' : '‚ùå Mascot unequipped';
                showToast(message, activate ? 'success' : 'info');
                
                await loadMascotManager();
                await updateProfilePreview();

            } catch (error) {
                console.error('Error toggling mascot:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Load Badge Manager
        async function loadBadgeManager() {
            const badgeManager = document.getElementById('badgeManager');

            try {
                // Load user's purchases with display settings
                const { data: purchases, error } = await supabase
                    .from('user_purchases')
                    .select('*, shop_items(*)')
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_active', true)
                    .order('purchased_at', { ascending: false });

                if (error) throw error;

                if (purchases && purchases.length > 0) {
                    badgeManager.innerHTML = purchases.map(purchase => {
                        const item = purchase.shop_items;
                        const isVisible = purchase.display_badge !== false; // Default to true if null/undefined
                        
                        return `
                            <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(30, 144, 255, 0.1)); border: 2px solid ${isVisible ? 'var(--cupboard-green)' : 'rgba(255,255,255,0.2)'}; border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="font-size: 2.5rem;">${item.badge_emoji}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--cupboard-gold);">${item.badge_name}</div>
                                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${item.description}</div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" ${isVisible ? 'checked' : ''} onchange="toggleBadgeDisplayShop('${purchase.badge_id}', this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span style="color: ${isVisible ? 'var(--cupboard-green)' : 'rgba(255,255,255,0.5)'}; font-weight: 600; font-size: 0.9rem;">
                                            ${isVisible ? 'üëÅÔ∏è VISIBLE' : 'üîí HIDDEN'}
                                        </span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
                                        ${isVisible ? 'Showing on profile' : 'Not displayed'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    badgeManager.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: rgba(255,255,255,0.5); background: rgba(30, 144, 255, 0.05); border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üè∑Ô∏è</div>
                            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">No Badges to Manage</div>
                            <div style="font-size: 0.9rem;">Purchase badges from the shop above to customize your profile!</div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading badge manager:', error);
                badgeManager.innerHTML = '<div class="alert alert-error">Error loading badge manager: ' + error.message + '</div>';
            }
        }

        // Toggle Badge Display
        async function toggleBadgeDisplay(badgeId, isVisible) {
            console.log('Toggling badge:', badgeId, 'to visible:', isVisible);
            
            try {
                const { data, error } = await supabase
                    .from('user_purchases')
                    .update({ display_badge: isVisible })
                    .eq('auth_user_id', currentUser.id)
                    .eq('badge_id', badgeId)
                    .select();

                if (error) throw error;

                console.log('Badge toggle successful. Updated records:', data);

                // Show feedback
                const message = isVisible ? '‚úÖ Badge will now appear on your profile!' : 'üîí Badge hidden from your profile';
                
                // Show toast notification
                showToast(message, isVisible ? 'success' : 'info');

                // Return success so caller knows to reload their UI
                return true;

            } catch (error) {
                console.error('Error toggling badge display:', error);
                alert('‚ùå Error updating badge display: ' + error.message);
                return false;
            }
        }

        // Toggle Badge from Shop Tab
        async function toggleBadgeDisplayShop(badgeId, isVisible) {
            const success = await toggleBadgeDisplay(badgeId, isVisible);
            if (success) {
                await loadBadgeManager();
            }
        }

        // Show Toast Notification
        function showToast(message, type = 'info') {
            // Remove existing toast if any
            const existingToast = document.getElementById('toast');
            if (existingToast) existingToast.remove();

            // Create toast
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: ${type === 'success' ? 'linear-gradient(135deg, var(--cupboard-green), #00D084)' : 'linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple))'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Show Achievement Unlock Notification
        function showAchievementUnlock(achievement) {
            console.log('üéâ Creating achievement notification for:', achievement.name);
            
            // Remove any existing notification
            const existing = document.querySelector('.achievement-overlay');
            if (existing) {
                console.log('Removing existing notification');
                existing.remove();
            }

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'achievement-overlay';

            // Create notification
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="achievement-glow"></div>
                <div class="achievement-icon">${achievement.emoji}</div>
                <div class="achievement-unlocked">üéâ ACHIEVEMENT UNLOCKED! üéâ</div>
                <div class="achievement-title">${achievement.name}</div>
                <div class="achievement-description">${achievement.description}</div>
                <button class="achievement-close" id="achievementCloseBtn">AWESOME!</button>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(notification);

            console.log('‚úÖ Notification added to DOM');

            // Prevent notification from closing when clicking inside it
            notification.addEventListener('click', (e) => {
                console.log('Clicked inside notification');
                e.stopPropagation();
            });

            // Click overlay to close
            overlay.addEventListener('click', () => {
                console.log('Clicked overlay - closing');
                closeAchievementNotification();
            });

            // Wait a tiny bit for DOM to be ready, then add button listener
            setTimeout(() => {
                const closeBtn = document.getElementById('achievementCloseBtn');
                if (closeBtn) {
                    console.log('‚úÖ Button found, adding listeners');
                    
                    // Primary click handler
                    closeBtn.onclick = (e) => {
                        console.log('üñ±Ô∏è Button clicked!');
                        e.stopPropagation();
                        closeAchievementNotification();
                    };
                    
                    // Backup addEventListener
                    closeBtn.addEventListener('click', (e) => {
                        console.log('üñ±Ô∏è Button clicked (addEventListener)!');
                        e.stopPropagation();
                        closeAchievementNotification();
                    }, true); // Use capture phase
                    
                    // Touch event for mobile
                    closeBtn.addEventListener('touchend', (e) => {
                        console.log('üëÜ Button touched!');
                        e.preventDefault();
                        e.stopPropagation();
                        closeAchievementNotification();
                    });
                    
                    console.log('Button element:', closeBtn);
                    console.log('Button computed style:', window.getComputedStyle(closeBtn).getPropertyValue('pointer-events'));
                } else {
                    console.error('‚ùå Button not found!');
                }
            }, 100);

            // Auto close after 10 seconds (increased for testing)
            setTimeout(() => {
                console.log('‚è∞ Auto-closing after timeout');
                closeAchievementNotification();
            }, 10000);
        }

        // Close Achievement Notification
        function closeAchievementNotification() {
            const overlay = document.querySelector('.achievement-overlay');
            const notification = document.querySelector('.achievement-notification');

            if (overlay && notification) {
                overlay.classList.add('closing');
                notification.classList.add('closing');

                setTimeout(() => {
                    overlay.remove();
                    notification.remove();
                }, 400);
            }
        }

        // Check for newly unlocked achievements
        async function checkAchievements() {
            try {
                console.log('üîç Checking all achievements...');
                
                // Get user's collection
                const { data: cards } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        )
                    `)
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_sold', false);

                // Calculate stats
                let totalScore = 0;
                let totalCards = cards?.length || 0;
                let gradedCards = 0;
                let rookieCards = 0;
                let autographCards = 0;
                let psa10Cards = 0;

                if (cards && cards.length > 0) {
                    cards.forEach(card => {
                        totalScore += calculateCollectorScore(card);
                        if (card.grading_company) gradedCards++;
                        if (card.is_rookie || card.cards?.is_rookie) rookieCards++;
                        if (card.is_autograph || card.cards?.is_autograph) autographCards++;
                        if (card.grading_company && card.grade >= 10) psa10Cards++;
                    });
                }

                // Get sales count
                const { count: salesCount } = await supabase
                    .from('sales_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('auth_user_id', currentUser.id);

                console.log('üìä Stats:', { totalScore, totalCards, gradedCards, rookieCards, autographCards, psa10Cards, salesCount });

                // Get user's profile to check what achievements they've seen
                const { data: profile, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('achievement_notifications_shown')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                if (profileError) {
                    console.error('Profile error:', profileError);
                }

                // Parse shown achievements (stored as JSON array)
                const shownAchievements = profile?.achievement_notifications_shown ? JSON.parse(profile.achievement_notifications_shown) : [];
                console.log('‚úÖ Already shown:', shownAchievements);

                // Define all achievements with their notification data
                const achievementDefinitions = [
                    {
                        id: 'rising_star',
                        emoji: 'üåü',
                        name: 'RISING STAR',
                        description: 'You\'ve reached 10,000+ Collector Score! You\'re on your way to becoming an elite collector. Keep building that amazing collection!',
                        unlocked: totalScore >= 10000
                    },
                    {
                        id: 'elite_collector',
                        emoji: 'üíé',
                        name: 'ELITE COLLECTOR',
                        description: 'INCREDIBLE! You\'ve achieved 100,000+ Collector Score! You are now among the top 1% of collectors. You are a true master of the hobby!',
                        unlocked: totalScore >= 100000
                    },
                    {
                        id: 'first_card',
                        emoji: 'üé¥',
                        name: 'FIRST CARD',
                        description: 'Welcome to the hobby! You\'ve added your very first card to your collection. This is just the beginning of an amazing journey!',
                        unlocked: totalCards >= 1
                    },
                    {
                        id: 'collector_10',
                        emoji: 'üìö',
                        name: 'COLLECTOR',
                        description: 'You now own 10 cards! Your collection is really starting to take shape. Keep adding those gems!',
                        unlocked: totalCards >= 10
                    },
                    {
                        id: 'collector_50',
                        emoji: 'üì¶',
                        name: 'SERIOUS COLLECTOR',
                        description: 'WOW! 50 cards in your collection! You\'re building something truly impressive. The hobby is lucky to have you!',
                        unlocked: totalCards >= 50
                    },
                    {
                        id: 'collector_100',
                        emoji: 'üèõÔ∏è',
                        name: 'MASTER COLLECTOR',
                        description: 'AMAZING! You\'ve reached 100 cards! This is a major milestone. You\'re officially a master collector!',
                        unlocked: totalCards >= 100
                    },
                    {
                        id: 'graded_1',
                        emoji: '‚≠ê',
                        name: 'FIRST GRADED',
                        description: 'You\'ve added your first professionally graded card! These slabs are the premium pieces of any collection!',
                        unlocked: gradedCards >= 1
                    },
                    {
                        id: 'graded_10',
                        emoji: 'üèÖ',
                        name: 'GRADING EXPERT',
                        description: 'You own 10 graded cards! You clearly understand the value of professionally authenticated pieces!',
                        unlocked: gradedCards >= 10
                    },
                    {
                        id: 'psa_10',
                        emoji: 'üíØ',
                        name: 'PRISTINE',
                        description: 'You own a perfect 10! This is the pinnacle of card collecting - absolute perfection in your hands!',
                        unlocked: psa10Cards >= 1
                    },
                    {
                        id: 'rookie_1',
                        emoji: 'üåü',
                        name: 'ROOKIE HUNTER',
                        description: 'You\'ve snagged your first rookie card! These are often the most valuable cards in any player\'s career!',
                        unlocked: rookieCards >= 1
                    },
                    {
                        id: 'rookie_10',
                        emoji: '‚≠ê',
                        name: 'ROOKIE MASTER',
                        description: 'You own 10 rookie cards! You have a keen eye for spotting future stars!',
                        unlocked: rookieCards >= 10
                    },
                    {
                        id: 'auto_1',
                        emoji: '‚úçÔ∏è',
                        name: 'AUTOGRAPH COLLECTOR',
                        description: 'Your first autograph card! There\'s something special about owning a piece signed by the athlete themselves!',
                        unlocked: autographCards >= 1
                    },
                    {
                        id: 'auto_5',
                        emoji: '‚ú®',
                        name: 'SIGNATURE EXPERT',
                        description: 'You own 5 autograph cards! Your signature collection is growing beautifully!',
                        unlocked: autographCards >= 5
                    },
                    {
                        id: 'first_sale',
                        emoji: 'üí∞',
                        name: 'FIRST SALE',
                        description: 'You\'ve recorded your first card sale! Whether it\'s profit or making room for new pickups, you\'re now actively managing your collection!',
                        unlocked: (salesCount || 0) >= 1
                    },
                    {
                        id: 'trader_10',
                        emoji: 'üìà',
                        name: 'ACTIVE TRADER',
                        description: 'You\'ve completed 10 sales! You\'re actively buying, selling, and managing your portfolio like a pro!',
                        unlocked: (salesCount || 0) >= 10
                    }
                ];

                // Check for newly unlocked achievements
                let newlyUnlockedCount = 0;
                for (const achievement of achievementDefinitions) {
                    if (achievement.unlocked && !shownAchievements.includes(achievement.id)) {
                        console.log(`üéâ NEW ACHIEVEMENT: ${achievement.name}!`);
                        
                        // Show notification
                        showAchievementUnlock(achievement);
                        
                        // Add to shown list
                        shownAchievements.push(achievement.id);
                        newlyUnlockedCount++;
                        
                        // Only show one at a time
                        break;
                    }
                }

                // Update database with shown achievements
                if (newlyUnlockedCount > 0) {
                    await supabase
                        .from('user_profiles')
                        .update({ achievement_notifications_shown: JSON.stringify(shownAchievements) })
                        .eq('auth_user_id', currentUser.id);
                }

                console.log(`‚úÖ Achievement check complete. ${newlyUnlockedCount} new achievement(s) shown.`);

            } catch (error) {
                console.error('‚ùå Error checking achievements:', error);
            }
        }

        // Purchase Badge with Stripe
        async function purchaseBadge(itemId, priceId, badgeId) {
            try {
                // Store purchase info in sessionStorage for after redirect
                sessionStorage.setItem('pendingPurchase', JSON.stringify({
                    itemId: itemId,
                    badgeId: badgeId,
                    userId: currentUser.id,
                    timestamp: Date.now()
                }));

                // Store the current page URL to help user return
                sessionStorage.setItem('returnUrl', window.location.href);

                // Show user instructions before redirect
                const proceed = confirm(
                    'üõí You will be redirected to Stripe to complete your purchase.\n\n' +
                    '‚ö†Ô∏è IMPORTANT: After payment, manually return to this page by:\n' +
                    '1. Closing the Stripe tab/window, OR\n' +
                    '2. Using your browser\'s back button\n\n' +
                    'Click OK to proceed to payment.'
                );

                if (proceed) {
                    // Redirect to Stripe Payment Link
                    window.location.href = priceId;
                } else {
                    // User cancelled, clear the pending purchase
                    sessionStorage.removeItem('pendingPurchase');
                }
            } catch (error) {
                console.error('Error purchasing badge:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Handle Stripe Success Redirect
        async function handleStripeSuccess() {
            // Check if returning from Stripe payment
            const pendingPurchase = sessionStorage.getItem('pendingPurchase');
            
            if (pendingPurchase) {
                const purchase = JSON.parse(pendingPurchase);
                
                // Check if this is a stale pending purchase (older than 1 hour)
                const timestamp = purchase.timestamp || 0;
                const hourAgo = Date.now() - (60 * 60 * 1000);
                
                if (timestamp < hourAgo) {
                    // Stale purchase, just clear it
                    sessionStorage.removeItem('pendingPurchase');
                    return;
                }
                
                // Ask user to confirm they completed payment
                const confirmed = confirm(
                    'üí≥ Welcome back!\n\n' +
                    'Did you complete your payment on Stripe?\n\n' +
                    '‚Ä¢ Click OK if you successfully paid\n' +
                    '‚Ä¢ Click Cancel if you didn\'t complete the payment'
                );
                
                if (confirmed) {
                    // Show loading state
                    const shopContent = document.getElementById('shopContent');
                    if (shopContent) {
                        shopContent.innerHTML = '<div class="loading" style="min-height: 300px;"><div class="spinner"></div><p>Processing your purchase...</p></div>';
                    }

                    try {
                        // Record purchase in database
                        const { error } = await supabase
                            .from('user_purchases')
                            .insert({
                                auth_user_id: purchase.userId,
                                item_id: purchase.itemId,
                                badge_id: purchase.badgeId,
                                stripe_payment_id: 'payment_link_' + Date.now(),
                                is_active: true
                            });

                        if (error) throw error;

                        // Clear pending purchase
                        sessionStorage.removeItem('pendingPurchase');
                        sessionStorage.removeItem('returnUrl');

                        // Show success message
                        alert('üéâ Badge purchased successfully! It will now appear on your profile and in the shop.');

                        // Reload shop to show the new badge
                        await loadShop();
                        switchTab('shop');
                    } catch (error) {
                        console.error('Error recording purchase:', error);
                        alert('‚ùå Error recording purchase. Please contact support with this info:\n' + error.message);
                        
                        // Reload shop anyway
                        await loadShop();
                    }
                } else {
                    // User cancelled, just clear the pending purchase
                    sessionStorage.removeItem('pendingPurchase');
                    sessionStorage.removeItem('returnUrl');
                    
                    alert('Purchase cancelled. If you completed the payment but clicked Cancel by mistake, please contact support.');
                }
            }
        }

        // Load Customize Profile Tab
        async function loadCustomizeProfile() {
            // Check for completed banner purchase
            await handleBannerPurchaseSuccess();
            
            await loadCustomizeBadgeManager();
            await loadProfileBanners();
            await loadMascotManager();
            await updateProfilePreview();
        }

        // Load Badge Manager in Customize Tab
        async function loadCustomizeBadgeManager() {
            const badgeManager = document.getElementById('customizeBadgeManager');

            try {
                // Get purchased badges
                const { data: purchases, error: purchaseError } = await supabase
                    .from('user_purchases')
                    .select('*, shop_items(*)')
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_active', true)
                    .order('purchased_at', { ascending: false });

                if (purchaseError) throw purchaseError;

                // Get user's profile to check achievement badge settings
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('hide_rising_star_badge, hide_elite_collector_badge')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                // Get user's collection to check achievement eligibility
                const { data: cards } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        )
                    `)
                    .eq('auth_user_id', currentUser.id);

                let totalScore = 0;
                if (cards && cards.length > 0) {
                    cards.forEach(card => {
                        totalScore += calculateCollectorScore(card);
                    });
                }

                console.log('Badge Manager - Total Score:', totalScore);
                console.log('Badge Manager - Cards Count:', cards?.length || 0);

                // Define achievement badges based on score
                const achievementBadges = [];
                
                if (totalScore >= 10000) {
                    console.log('Adding Rising Star badge');
                    achievementBadges.push({
                        type: 'achievement',
                        id: 'rising_star',
                        emoji: 'üåü',
                        name: 'RISING STAR',
                        description: 'Achieved 10,000+ Collector Score',
                        isVisible: !profile?.hide_rising_star_badge,
                        color: 'linear-gradient(135deg, #00FF00, #7FFF00)'
                    });
                }
                
                if (totalScore >= 100000) {
                    console.log('Adding Elite Collector badge');
                    achievementBadges.push({
                        type: 'achievement',
                        id: 'elite_collector',
                        emoji: 'üíé',
                        name: 'ELITE COLLECTOR',
                        description: 'Achieved 100,000+ Collector Score',
                        isVisible: !profile?.hide_elite_collector_badge,
                        color: 'linear-gradient(135deg, #FF00FF, #00FFFF)'
                    });
                }

                console.log('Achievement Badges:', achievementBadges);

                let badgesHTML = '';

                // Render achievement badges first
                if (achievementBadges.length > 0) {
                    badgesHTML += achievementBadges.map(badge => `
                        <div style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(138, 43, 226, 0.1)); border: 2px solid ${badge.isVisible ? 'var(--cupboard-green)' : 'rgba(255,255,255,0.2)'}; border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <div style="font-size: 2.5rem;">${badge.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: var(--cupboard-gold);">${badge.name}</div>
                                    <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${badge.description}</div>
                                </div>
                            </div>
                            <div style="background: ${badge.color}; padding: 0.5rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                                <span style="font-size: 0.75rem; font-weight: bold; color: #000; letter-spacing: 1px;">üèÜ ACHIEVEMENT BADGE</span>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" ${badge.isVisible ? 'checked' : ''} onchange="toggleAchievementBadge('${badge.id}', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="color: ${badge.isVisible ? 'var(--cupboard-green)' : 'rgba(255,255,255,0.5)'}; font-weight: 600; font-size: 0.9rem;">
                                        ${badge.isVisible ? 'üëÅÔ∏è VISIBLE' : 'üîí HIDDEN'}
                                    </span>
                                </div>
                                <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
                                    ${badge.isVisible ? 'Showing on profile' : 'Not displayed'}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Render purchased badges
                if (purchases && purchases.length > 0) {
                    badgesHTML += purchases.map(purchase => {
                        const item = purchase.shop_items;
                        const isVisible = purchase.display_badge !== false;
                        
                        return `
                            <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(30, 144, 255, 0.1)); border: 2px solid ${isVisible ? 'var(--cupboard-green)' : 'rgba(255,255,255,0.2)'}; border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 2.5rem;">${item.badge_emoji}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--cupboard-gold);">${item.badge_name}</div>
                                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${item.description}</div>
                                    </div>
                                </div>
                                <div style="background: linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple)); padding: 0.5rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                                    <span style="font-size: 0.75rem; font-weight: bold; color: white; letter-spacing: 1px;">üõí PURCHASED BADGE</span>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" ${isVisible ? 'checked' : ''} onchange="toggleBadgeDisplayCustomize('${purchase.badge_id}', this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span style="color: ${isVisible ? 'var(--cupboard-green)' : 'rgba(255,255,255,0.5)'}; font-weight: 600; font-size: 0.9rem;">
                                            ${isVisible ? 'üëÅÔ∏è VISIBLE' : 'üîí HIDDEN'}
                                        </span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
                                        ${isVisible ? 'Showing on profile' : 'Not displayed'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                if (badgesHTML) {
                    badgeManager.innerHTML = badgesHTML;
                } else {
                    badgeManager.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: rgba(255,255,255,0.5); background: rgba(30, 144, 255, 0.05); border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üè∑Ô∏è</div>
                            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">No Badges Yet</div>
                            <div style="font-size: 0.9rem;">Visit the <a href="#" onclick="switchTab('shop'); return false;" style="color: var(--cupboard-blue);">Shop</a> to purchase badges or earn achievements!</div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading badge manager:', error);
                badgeManager.innerHTML = '<div class="alert alert-error">Error loading badges: ' + error.message + '</div>';
            }
        }

        // Toggle Achievement Badge
        async function toggleAchievementBadge(badgeId, isVisible) {
            try {
                const fieldName = badgeId === 'rising_star' ? 'hide_rising_star_badge' : 'hide_elite_collector_badge';
                
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ [fieldName]: !isVisible })
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                const message = isVisible ? '‚úÖ Achievement badge will now appear!' : 'üîí Achievement badge hidden';
                showToast(message, isVisible ? 'success' : 'info');
                
                await loadCustomizeBadgeManager();
                await updateProfilePreview();

            } catch (error) {
                console.error('Error toggling achievement badge:', error);
                alert('‚ùå Error updating badge: ' + error.message);
                await loadCustomizeBadgeManager();
            }
        }

        // Toggle Badge from Customize Tab
        async function toggleBadgeDisplayCustomize(badgeId, isVisible) {
            await toggleBadgeDisplay(badgeId, isVisible);
            await loadCustomizeBadgeManager();
            await updateProfilePreview();
        }

        // Load Profile Banners
        async function loadProfileBanners() {
            const bannerGrid = document.getElementById('bannerGrid');
            
            // Get user's current banner
            const { data: profile } = await supabase
                .from('user_profiles')
                .select('profile_banner, owned_banners')
                .eq('auth_user_id', currentUser.id)
                .single();
            
            const currentBanner = profile?.profile_banner || 'default';
            const ownedBanners = profile?.owned_banners ? JSON.parse(profile.owned_banners) : [];

            // Banner options - FREE and PREMIUM
            const banners = [
                // FREE BANNERS
                {
                    id: 'default',
                    name: 'Classic Blue',
                    gradient: 'linear-gradient(135deg, rgba(30, 144, 255, 0.3), rgba(147, 51, 234, 0.3))',
                    price: 'FREE',
                    owned: true,
                    tier: 'free'
                },
                {
                    id: 'gold',
                    name: 'Golden Glory',
                    gradient: 'linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.4))',
                    price: 'FREE',
                    owned: true,
                    tier: 'free'
                },
                {
                    id: 'green',
                    name: 'Emerald Dream',
                    gradient: 'linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(0, 200, 100, 0.3))',
                    price: 'FREE',
                    owned: true,
                    tier: 'free'
                },
                {
                    id: 'red',
                    name: 'Ruby Blaze',
                    gradient: 'linear-gradient(135deg, rgba(255, 51, 102, 0.3), rgba(200, 0, 50, 0.3))',
                    price: 'FREE',
                    owned: true,
                    tier: 'free'
                },
                {
                    id: 'purple',
                    name: 'Royal Purple',
                    gradient: 'linear-gradient(135deg, rgba(147, 51, 234, 0.4), rgba(100, 20, 180, 0.4))',
                    price: 'FREE',
                    owned: true,
                    tier: 'free'
                },
                // PREMIUM BANNERS
                {
                    id: 'rainbow',
                    name: 'üåà Rainbow Elite',
                    gradient: 'linear-gradient(135deg, rgba(255, 0, 0, 0.4), rgba(255, 127, 0, 0.4), rgba(255, 255, 0, 0.4), rgba(0, 255, 0, 0.4), rgba(0, 0, 255, 0.4), rgba(75, 0, 130, 0.4), rgba(148, 0, 211, 0.4))',
                    price: '$2.99',
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_rainbow',
                    owned: ownedBanners.includes('rainbow'),
                    tier: 'premium',
                    description: 'Full spectrum gradient - show your true colors!'
                },
                {
                    id: 'sunset',
                    name: 'üåÖ Sunset Vibes',
                    gradient: 'linear-gradient(135deg, rgba(255, 94, 77, 0.5), rgba(255, 154, 158, 0.4), rgba(250, 208, 196, 0.3), rgba(255, 183, 77, 0.4), rgba(255, 138, 101, 0.5))',
                    price: '$2.99',
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_sunset',
                    owned: ownedBanners.includes('sunset'),
                    tier: 'premium',
                    description: 'Warm sunset gradient - luxury coastal vibes'
                },
                {
                    id: 'neon',
                    name: '‚ö° Neon City',
                    gradient: 'linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(255, 0, 255, 0.5), rgba(0, 255, 255, 0.5))',
                    price: '$3.99',
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_neon',
                    owned: ownedBanners.includes('neon'),
                    tier: 'epic',
                    description: 'Cyberpunk neon glow - electric and futuristic'
                },
                {
                    id: 'aurora',
                    name: '‚ú® Aurora Borealis',
                    gradient: 'radial-gradient(ellipse at top, rgba(0, 255, 136, 0.4), transparent 50%), radial-gradient(ellipse at bottom, rgba(138, 43, 226, 0.4), transparent 50%), linear-gradient(135deg, rgba(0, 200, 255, 0.3), rgba(100, 255, 200, 0.3), rgba(138, 43, 226, 0.3))',
                    price: '$4.99',
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_aurora',
                    owned: ownedBanners.includes('aurora'),
                    tier: 'legendary',
                    description: 'Northern lights mystique - ethereal and mesmerizing'
                },
                {
                    id: 'galaxy',
                    name: 'üåå Cosmic Galaxy',
                    gradient: 'radial-gradient(ellipse at 20% 30%, rgba(138, 43, 226, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 80% 60%, rgba(255, 0, 128, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 40% 80%, rgba(0, 150, 255, 0.5) 0%, transparent 40%), linear-gradient(135deg, rgba(10, 10, 40, 0.8), rgba(30, 0, 60, 0.8))',
                    price: '$5.99',
                    stripeUrl: 'https://buy.stripe.com/test_placeholder_galaxy',
                    owned: ownedBanners.includes('galaxy'),
                    tier: 'legendary',
                    description: 'Deep space nebula - infinite cosmic beauty'
                }
            ];

            bannerGrid.innerHTML = banners.map(banner => {
                const isActive = currentBanner === banner.id;
                const tierColor = {
                    'free': 'rgba(255,255,255,0.2)',
                    'premium': 'rgba(0, 255, 136, 0.5)',
                    'epic': 'rgba(138, 43, 226, 0.7)',
                    'legendary': 'rgba(255, 215, 0, 0.7)'
                };
                
                return `
                    <div style="background: var(--cupboard-dark); border: 2px solid ${isActive ? 'var(--cupboard-gold)' : tierColor[banner.tier]}; border-radius: 12px; overflow: hidden; transition: all 0.3s; cursor: pointer; ${!banner.owned ? 'box-shadow: 0 0 20px ' + tierColor[banner.tier] + ';' : ''}" onclick="selectBanner('${banner.id}', ${banner.owned}, '${banner.stripeUrl || ''}')">
                        <div style="height: 140px; background: ${banner.gradient}; position: relative;">
                            ${isActive ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--cupboard-gold); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: #000;">‚úì ACTIVE</div>' : ''}
                            ${!banner.owned && banner.tier === 'legendary' ? '<div style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #FFD700, #FFA500); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: #000; animation: pulse 2s infinite;">‚≠ê LEGENDARY</div>' : ''}
                            ${!banner.owned && banner.tier === 'epic' ? '<div style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #8A2BE2, #9333ea); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold;">üíé EPIC</div>' : ''}
                            ${!banner.owned && banner.tier === 'premium' ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--cupboard-green); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: bold;">üîí PREMIUM</div>' : ''}
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.25rem;">${banner.name}</div>
                            ${banner.description ? `<div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem; min-height: 32px;">${banner.description}</div>` : ''}
                            <div style="color: ${banner.owned ? 'var(--cupboard-green)' : 'var(--cupboard-blue)'}; font-size: 0.9rem; font-weight: 600;">${banner.owned ? (banner.tier === 'free' ? 'FREE' : '‚úì OWNED') : banner.price}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select Banner
        async function selectBanner(bannerId, owned, stripeUrl) {
            if (!owned) {
                const proceed = confirm(
                    'üé® This is a premium banner!\n\n' +
                    'You will be redirected to Stripe to complete your purchase.\n\n' +
                    '‚ö†Ô∏è IMPORTANT: After payment, return to this page to activate your banner.\n\n' +
                    'Click OK to proceed to payment.'
                );
                
                if (proceed && stripeUrl) {
                    // Store purchase info
                    sessionStorage.setItem('pendingBannerPurchase', JSON.stringify({
                        bannerId: bannerId,
                        userId: currentUser.id,
                        timestamp: Date.now()
                    }));
                    
                    // Redirect to Stripe
                    window.location.href = stripeUrl;
                }
                return;
            }

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ profile_banner: bannerId })
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                showToast('üé® Banner updated successfully!', 'success');
                await loadProfileBanners();
                await updateProfilePreview();

            } catch (error) {
                console.error('Error updating banner:', error);
                alert('‚ùå Error updating banner: ' + error.message);
            }
        }
        
        // Handle Banner Purchase Success
        async function handleBannerPurchaseSuccess() {
            const pendingBanner = sessionStorage.getItem('pendingBannerPurchase');
            
            if (pendingBanner) {
                const purchase = JSON.parse(pendingBanner);
                
                try {
                    // Get current owned banners
                    const { data: profile } = await supabase
                        .from('user_profiles')
                        .select('owned_banners')
                        .eq('auth_user_id', currentUser.id)
                        .single();
                    
                    const ownedBanners = profile?.owned_banners ? JSON.parse(profile.owned_banners) : [];
                    
                    // Add new banner if not already owned
                    if (!ownedBanners.includes(purchase.bannerId)) {
                        ownedBanners.push(purchase.bannerId);
                        
                        await supabase
                            .from('user_profiles')
                            .update({ 
                                owned_banners: JSON.stringify(ownedBanners),
                                profile_banner: purchase.bannerId // Auto-activate
                            })
                            .eq('auth_user_id', currentUser.id);
                        
                        showToast('üéâ Banner purchased and activated!', 'success');
                        
                        // Reload banners
                        await loadProfileBanners();
                        await updateProfilePreview();
                    }
                    
                    sessionStorage.removeItem('pendingBannerPurchase');
                    
                } catch (error) {
                    console.error('Error processing banner purchase:', error);
                }
            }
        }

        // Update Profile Preview
        async function updateProfilePreview() {
            try {
                // Get user's profile data
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('username, display_name, profile_banner, active_mascot, is_founder, hide_rising_star_badge, hide_elite_collector_badge')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                // Get user's collection stats
                const { data: cards } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        )
                    `)
                    .eq('auth_user_id', currentUser.id);

                // Calculate stats
                let totalScore = 0;
                let totalCards = cards?.length || 0;
                let rookieCards = 0;
                let autographCards = 0;
                let bestCardScore = 0;
                let bestCardName = 'None';

                if (cards && cards.length > 0) {
                    cards.forEach(card => {
                        const score = calculateCollectorScore(card);
                        totalScore += score;
                        
                        if (card.is_rookie || card.cards?.is_rookie) rookieCards++;
                        if (card.is_autograph || card.cards?.is_autograph) autographCards++;

                        if (score > bestCardScore) {
                            const player = card.cards?.players;
                            bestCardScore = score;
                            bestCardName = player ? `${player.first_name} ${player.last_name}` : 'Unknown';
                        }
                    });
                }

                const avgScore = totalCards > 0 ? Math.round(totalScore / totalCards) : 0;

                // Get visible purchased badges
                const { data: badges } = await supabase
                    .from('user_purchases')
                    .select('shop_items(badge_emoji, badge_name)')
                    .eq('auth_user_id', currentUser.id)
                    .eq('is_active', true)
                    .eq('display_badge', true)
                    .limit(5);

                // Update preview elements
                document.getElementById('previewUsername').textContent = profile?.display_name || profile?.username || 'Your Username';
                document.getElementById('previewTotalScore').textContent = totalScore.toLocaleString();
                document.getElementById('previewTotalCards').textContent = totalCards;
                document.getElementById('previewAvgScore').textContent = avgScore.toLocaleString();
                document.getElementById('previewRookies').textContent = rookieCards;
                document.getElementById('previewAutos').textContent = autographCards;
                document.getElementById('previewBestCard').textContent = bestCardName;
                document.getElementById('previewBestScore').textContent = bestCardScore.toLocaleString();
                
                // Update banner
                const bannerMap = {
                    'default': 'linear-gradient(135deg, rgba(30, 144, 255, 0.3), rgba(147, 51, 234, 0.3))',
                    'gold': 'linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.4))',
                    'green': 'linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(0, 200, 100, 0.3))',
                    'red': 'linear-gradient(135deg, rgba(255, 51, 102, 0.3), rgba(200, 0, 50, 0.3))',
                    'purple': 'linear-gradient(135deg, rgba(147, 51, 234, 0.4), rgba(100, 20, 180, 0.4))',
                    'rainbow': 'linear-gradient(135deg, rgba(255, 0, 0, 0.4), rgba(255, 127, 0, 0.4), rgba(255, 255, 0, 0.4), rgba(0, 255, 0, 0.4), rgba(0, 0, 255, 0.4), rgba(75, 0, 130, 0.4), rgba(148, 0, 211, 0.4))',
                    'sunset': 'linear-gradient(135deg, rgba(255, 94, 77, 0.5), rgba(255, 154, 158, 0.4), rgba(250, 208, 196, 0.3), rgba(255, 183, 77, 0.4), rgba(255, 138, 101, 0.5))',
                    'neon': 'linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(255, 0, 255, 0.5), rgba(0, 255, 255, 0.5))',
                    'aurora': 'radial-gradient(ellipse at top, rgba(0, 255, 136, 0.4), transparent 50%), radial-gradient(ellipse at bottom, rgba(138, 43, 226, 0.4), transparent 50%), linear-gradient(135deg, rgba(0, 200, 255, 0.3), rgba(100, 255, 200, 0.3), rgba(138, 43, 226, 0.3))',
                    'galaxy': 'radial-gradient(ellipse at 20% 30%, rgba(138, 43, 226, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 80% 60%, rgba(255, 0, 128, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 40% 80%, rgba(0, 150, 255, 0.5) 0%, transparent 40%), linear-gradient(135deg, rgba(10, 10, 40, 0.8), rgba(30, 0, 60, 0.8))'
                };
                
                const currentBanner = profile?.profile_banner || 'default';
                document.getElementById('previewBanner').style.background = bannerMap[currentBanner];

                // Update mascot
                const previewMascot = document.getElementById('previewMascot');
                if (profile?.active_mascot) {
                    const mascotMap = {
                        'viking': {
                            name: 'The Viking',
                            imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/viking.png'
                        },
                        'magician': {
                            name: 'The Magician',
                            imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/magician.png'
                        },
                        'calm': {
                            name: 'The Calm',
                            imageUrl: 'https://quinnk5.github.io/collectiq/images/mascots/calm.png'
                        }
                    };
                    const mascot = mascotMap[profile.active_mascot];
                    if (mascot) {
                        previewMascot.style.display = 'flex';
                        previewMascot.innerHTML = `
                            <div style="padding: 0.5rem; background: rgba(138, 43, 226, 0.1); border: 2px solid var(--cupboard-purple); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <img src="${mascot.imageUrl}" alt="${mascot.name}" style="max-height: 100px; width: auto; object-fit: contain; filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.5));">
                                <div style="font-size: 0.7rem; color: var(--cupboard-purple); font-weight: bold; margin-top: 0.25rem;">${mascot.name}</div>
                            </div>
                        `;
                    }
                } else {
                    previewMascot.style.display = 'none';
                    previewMascot.innerHTML = '';
                }

                // Build badges HTML - same order as leaderboard
                const previewBadges = document.getElementById('previewBadges');
                let badgesHTML = '';

                // Founder badge
                if (profile?.is_founder) {
                    badgesHTML += '<span title="üëë FOUNDER - The visionary who built CollectIQ from the ground up. Original creator and architect of the platform." style="background: linear-gradient(135deg, #FFD700, #8A2BE2, #FFD700); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); animation: sparkle 2s infinite; cursor: help; border: 2px solid #FFD700;">üëë FOUNDER</span>';
                }

                // Elite Collector badge (100k+)
                if (totalScore >= 100000 && !profile?.hide_elite_collector_badge) {
                    badgesHTML += '<span title="üíé ELITE COLLECTOR - Achieved 100,000+ Collector Score! Only the top 1% of collectors earn this prestigious badge. You are a true master of the hobby!" style="background: linear-gradient(135deg, #FF00FF, #00FFFF); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); animation: pulse 2s infinite; cursor: help;">üíé ELITE COLLECTOR</span>';
                }

                // Rising Star badge (10k+)
                if (totalScore >= 10000 && !profile?.hide_rising_star_badge) {
                    badgesHTML += '<span title="üåü RISING STAR - Achieved 10,000+ Collector Score! You\'re on your way to becoming an elite collector. Keep building that collection!" style="background: linear-gradient(135deg, #00FF00, #7FFF00); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 15px rgba(0, 255, 0, 0.6); color: #000; cursor: help;">üåü RISING STAR</span>';
                }

                // Purchased badges
                if (badges && badges.length > 0) {
                    badgesHTML += badges.map(b => 
                        `<span style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.8), rgba(30, 144, 255, 0.8)); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);">${b.shop_items.badge_emoji} ${b.shop_items.badge_name}</span>`
                    ).join('');
                }

                previewBadges.innerHTML = badgesHTML || '';

            } catch (error) {
                console.error('Error updating preview:', error);
            }
        }

        // Load Leaderboard with Collector Scores
        async function loadLeaderboard() {
            const loading = document.getElementById('leaderboardLoading');
            const list = document.getElementById('leaderboardList');
            const banner = document.getElementById('joinLeaderboardBanner');
            
            loading.style.display = 'flex';
            list.innerHTML = '';

            try {
                // Check if current user is sharing stats
                const { data: currentUserProfile } = await supabase
                    .from('user_profiles')
                    .select('share_stats')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                // Show/hide join banner based on user's share_stats setting
                if (banner) {
                    banner.style.display = (!currentUserProfile || !currentUserProfile.share_stats) ? 'block' : 'none';
                }

                // Get all users who share stats
                const { data: users, error: usersError } = await supabase
                    .from('user_profiles')
                    .select('auth_user_id, username, display_name, is_founder, profile_banner, active_mascot, hide_rising_star_badge, hide_elite_collector_badge')
                    .eq('share_stats', true);

                if (usersError) throw usersError;

                // Founder email
                const founderEmail = 'cmcqk5@gmail.com';

                if (!users || users.length === 0) {
                    loading.style.display = 'none';
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üèÜ</div>
                            <div class="empty-text">No collectors on the leaderboard yet. Be the first to share your stats!</div>
                        </div>
                    `;
                    return;
                }

                // Calculate scores for each user
                const leaderboardData = [];
                
                for (const user of users) {
                    // is_founder comes from database now
                    const isFounder = user.is_founder === true;

                    const { data: cards, error: cardsError } = await supabase
                        .from('my_collection')
                        .select(`
                            *,
                            cards (
                                *,
                                players (*),
                                card_sets (
                                    *,
                                    manufacturers (*)
                                )
                            )
                        `)
                        .eq('auth_user_id', user.auth_user_id);

                    if (cardsError) {
                        console.error('Error loading cards for user:', user.username, cardsError);
                        continue;
                    }

                    let totalScore = 0;
                    let totalCards = cards?.length || 0;
                    let gradedCards = 0;
                    let rookieCards = 0;
                    let autographCards = 0;
                    let bestCardScore = 0;
                    let bestCardName = '';

                    if (cards && cards.length > 0) {
                        cards.forEach(card => {
                            const score = calculateCollectorScore(card);
                            totalScore += score;
                            
                            if (card.grading_company) gradedCards++;
                            if (card.is_rookie || card.cards?.is_rookie) rookieCards++;
                            if (card.is_autograph || card.cards?.is_autograph) autographCards++;

                            // Track best card
                            if (score > bestCardScore) {
                                const player = card.cards?.players;
                                bestCardScore = score;
                                bestCardName = player ? `${player.first_name} ${player.last_name}` : 'Unknown';
                            }
                        });
                    }

                    // Get user's purchased badges (only visible ones)
                    const { data: purchases } = await supabase
                        .from('user_purchases')
                        .select('badge_id, display_badge, shop_items(badge_name, badge_emoji)')
                        .eq('auth_user_id', user.auth_user_id)
                        .eq('is_active', true)
                        .eq('display_badge', true)
                        .limit(3);

                    leaderboardData.push({
                        ...user,
                        totalScore,
                        totalCards,
                        gradedCards,
                        rookieCards,
                        autographCards,
                        avgScore: totalCards > 0 ? Math.round(totalScore / totalCards) : 0,
                        bestCardScore,
                        bestCardName,
                        purchasedBadges: purchases || [],
                        isFounder: isFounder
                    });
                }

                // Sort by total score
                leaderboardData.sort((a, b) => b.totalScore - a.totalScore);

                loading.style.display = 'none';

                leaderboardData.forEach((user, index) => {
                    const rank = index + 1;
                    let rankClass = '';
                    if (rank === 1) rankClass = 'top1';
                    else if (rank === 2) rankClass = 'top2';
                    else if (rank === 3) rankClass = 'top3';

                    const isCurrentUser = currentUser && user.auth_user_id === currentUser.id;

                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.style.cursor = 'pointer';
                    item.onclick = () => viewUserCollection(user.auth_user_id, user.display_name || user.username);
                    
                    if (isCurrentUser) {
                        item.style.border = '3px solid var(--cupboard-gold)';
                        item.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(30, 144, 255, 0.1))';
                    }
                    
                    const bannerMap = {
                        'default': 'linear-gradient(135deg, rgba(30, 144, 255, 0.3), rgba(147, 51, 234, 0.3))',
                        'gold': 'linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.4))',
                        'green': 'linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(0, 200, 100, 0.3))',
                        'red': 'linear-gradient(135deg, rgba(255, 51, 102, 0.3), rgba(200, 0, 50, 0.3))',
                        'purple': 'linear-gradient(135deg, rgba(147, 51, 234, 0.4), rgba(100, 20, 180, 0.4))',
                        'rainbow': 'linear-gradient(135deg, rgba(255, 0, 0, 0.4), rgba(255, 127, 0, 0.4), rgba(255, 255, 0, 0.4), rgba(0, 255, 0, 0.4), rgba(0, 0, 255, 0.4), rgba(75, 0, 130, 0.4), rgba(148, 0, 211, 0.4))',
                        'sunset': 'linear-gradient(135deg, rgba(255, 94, 77, 0.5), rgba(255, 154, 158, 0.4), rgba(250, 208, 196, 0.3), rgba(255, 183, 77, 0.4), rgba(255, 138, 101, 0.5))',
                        'neon': 'linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(255, 0, 255, 0.5), rgba(0, 255, 255, 0.5))',
                        'aurora': 'radial-gradient(ellipse at top, rgba(0, 255, 136, 0.4), transparent 50%), radial-gradient(ellipse at bottom, rgba(138, 43, 226, 0.4), transparent 50%), linear-gradient(135deg, rgba(0, 200, 255, 0.3), rgba(100, 255, 200, 0.3), rgba(138, 43, 226, 0.3))',
                        'galaxy': 'radial-gradient(ellipse at 20% 30%, rgba(138, 43, 226, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 80% 60%, rgba(255, 0, 128, 0.5) 0%, transparent 40%), radial-gradient(ellipse at 40% 80%, rgba(0, 150, 255, 0.5) 0%, transparent 40%), linear-gradient(135deg, rgba(10, 10, 40, 0.8), rgba(30, 0, 60, 0.8))'
                    };
                    const userBanner = user.profile_banner || 'default';
                    const bannerGradient = bannerMap[userBanner];
                    
                    item.innerHTML = `
                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 1.5rem; align-items: center; width: 100%;">
                            <!-- Rank Badge -->
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <div class="leaderboard-rank ${rankClass}" style="margin: 0;">
                                    ${rank <= 3 ? (rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â') : '#' + rank}
                                </div>
                            </div>
                            
                            <!-- Main Content Grid -->
                            <div style="display: grid; grid-template-columns: ${user.active_mascot ? '1fr auto 2fr' : '1fr 2fr'}; gap: 1.5rem; align-items: center; position: relative;">
                                <!-- Profile Banner with gradient fade -->
                                <div style="position: absolute; top: -1.5rem; right: -1.5rem; bottom: -1.5rem; left: calc(33.333% + 0.75rem); background: ${bannerGradient}; z-index: 0; border-radius: 0 12px 12px 0; mask-image: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.3) 5%, rgba(0,0,0,1) 15%); -webkit-mask-image: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.3) 5%, rgba(0,0,0,1) 15%);"></div>
                                
                                <!-- Left: User Info -->
                                <div style="position: relative; z-index: 1;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--cupboard-blue); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                        <span>${user.display_name || user.username}</span>
                                        ${user.isFounder ? '<span title="üëë FOUNDER - The visionary who built CollectIQ from the ground up. Original creator and architect of the platform." style="background: linear-gradient(135deg, #FFD700, #8A2BE2, #FFD700); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); animation: sparkle 2s infinite; cursor: help; border: 2px solid #FFD700;">üëë FOUNDER</span>' : ''}
                                        ${isCurrentUser && !user.isFounder ? '<span style="color: var(--cupboard-gold); font-size: 1rem;">üëë YOU</span>' : ''}
                                        ${user.totalScore >= 100000 && !user.hide_elite_collector_badge ? '<span title="üíé ELITE COLLECTOR - Achieved 100,000+ Collector Score! Only the top 1% of collectors earn this prestigious badge. You are a true master of the hobby!" style="background: linear-gradient(135deg, #FF00FF, #00FFFF); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); animation: pulse 2s infinite; cursor: help;">üíé ELITE COLLECTOR</span>' : ''}
                                        ${user.totalScore >= 10000 && !user.hide_rising_star_badge ? '<span title="üåü RISING STAR - Achieved 10,000+ Collector Score! You\'re on your way to becoming an elite collector. Keep building that collection!" style="background: linear-gradient(135deg, #00FF00, #7FFF00); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 15px rgba(0, 255, 0, 0.6); color: #000; cursor: help;">üåü RISING STAR</span>' : ''}
                                        ${user.purchasedBadges && user.purchasedBadges.length > 0 ? user.purchasedBadges.map(p => `<span style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.8), rgba(30, 144, 255, 0.8)); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);">${p.shop_items.badge_emoji} ${p.shop_items.badge_name}</span>`).join(' ') : ''}
                                    </div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-bottom: 0.5rem;">
                                        üëÅÔ∏è Click to view collection
                                    </div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">
                                        üèÜ Best: ${user.bestCardName}
                                    </div>
                                    <div style="color: var(--cupboard-gold); font-size: 0.9rem; font-weight: bold;">
                                        ${user.bestCardScore.toLocaleString()} pts
                                    </div>
                                </div>

                                ${user.active_mascot ? `
                                <!-- Center: Mascot -->
                                <div style="position: relative; z-index: 1;">
                                    <div style="padding: 0.5rem; background: rgba(138, 43, 226, 0.1); border: 2px solid var(--cupboard-purple); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <img src="https://quinnk5.github.io/collectiq/images/mascots/${user.active_mascot}.png" alt="Mascot" style="max-height: 100px; width: auto; object-fit: contain; filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.5));">
                                        <div style="font-size: 0.7rem; color: var(--cupboard-purple); font-weight: bold; margin-top: 0.25rem;">${user.active_mascot === 'viking' ? 'The Viking' : user.active_mascot === 'magician' ? 'The Magician' : user.active_mascot === 'calm' ? 'The Calm' : 'Mascot'}</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Right: Stats Grid -->
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; position: relative; z-index: 1;">
                                    <div style="text-align: center; padding: 0.75rem; background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(212, 175, 55, 0.15)); border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.3);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-gold);">${user.totalScore.toLocaleString()}</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">SCORE</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(30, 144, 255, 0.1); border-radius: 8px; border: 1px solid rgba(30, 144, 255, 0.3);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-blue);">${user.totalCards}</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">CARDS</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(138, 43, 226, 0.1); border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.3);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-purple);">${user.avgScore.toLocaleString()}</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">AVG/CARD</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(255, 215, 0, 0.08); border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.2);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 215, 0, 0.9);">${user.rookieCards}</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">‚≠ê ROOKIES</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: rgba(138, 43, 226, 0.08); border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.2);">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: rgba(138, 43, 226, 0.9);">${user.autographCards}</div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">‚úçÔ∏è AUTOS</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    list.appendChild(item);
                });

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                loading.style.display = 'none';
                list.innerHTML = `<div class="alert alert-error">Error loading leaderboard: ${error.message}</div>`;
            }
        }

        // View User Collection
        async function viewUserCollection(userId, username) {
            const modal = document.getElementById('userCollectionModal');
            const title = document.getElementById('userModalTitle');
            const loading = document.getElementById('userCollectionLoading');
            const grid = document.getElementById('userCollectionGrid');
            
            currentUserCollectionOwner = username;
            
            modal.classList.add('active');
            loading.style.display = 'flex';
            grid.innerHTML = '';

            // Reset sort dropdown and search bar
            document.getElementById('userCollectionSort').value = 'date_desc';
            document.getElementById('userCollectionSearch').value = '';

            try {
                const { data, error } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        ),
                        card_images (*)
                    `)
                    .eq('auth_user_id', userId)
                    .order('added_at', { ascending: false });

                if (error) throw error;

                // Calculate total score for badge
                let totalScore = 0;
                if (data && data.length > 0) {
                    data.forEach(card => {
                        totalScore += calculateCollectorScore(card);
                    });
                }

                // Set title with badge
                let badgeHTML = '';
                
                // Check if this is the founder
                if (userId === currentUser.id && currentUser.email === 'cmcqk5@gmail.com') {
                    badgeHTML = '<span title="üëë FOUNDER - The visionary who built CollectIQ from the ground up. Original creator and architect of the platform." style="background: linear-gradient(135deg, #FFD700, #8A2BE2, #FFD700); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-left: 0.75rem; box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); cursor: help; border: 2px solid #FFD700;">üëë FOUNDER</span> ';
                }
                
                if (totalScore >= 100000) {
                    badgeHTML += '<span title="üíé ELITE COLLECTOR - Achieved 100,000+ Collector Score! Only the top 1% of collectors earn this prestigious badge. A true master of the hobby!" style="background: linear-gradient(135deg, #FF00FF, #00FFFF); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-left: 0.75rem; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); cursor: help;">üíé ELITE COLLECTOR</span>';
                } else if (totalScore >= 10000) {
                    badgeHTML += '<span title="üåü RISING STAR - Achieved 10,000+ Collector Score! This collector is on their way to becoming elite!" style="background: linear-gradient(135deg, #00FF00, #7FFF00); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-left: 0.75rem; box-shadow: 0 0 15px rgba(0, 255, 0, 0.6); color: #000; cursor: help;">üåü RISING STAR</span>';
                }
                
                title.innerHTML = `${username}'s Collection ${badgeHTML}`;

                loading.style.display = 'none';

                if (data.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì¶</div>
                            <div class="empty-text">This user hasn't added any cards yet!</div>
                        </div>
                    `;
                    return;
                }

                // Store data globally for sorting
                currentUserCollectionData = data;
                
                // Render the collection
                renderUserCollection(data);

            } catch (error) {
                console.error('Error loading user collection:', error);
                loading.style.display = 'none';
                grid.innerHTML = `<div class="alert alert-error">Error loading collection: ${error.message}</div>`;
            }
        }

        // Sort User Collection
        function sortUserCollection() {
            if (!currentUserCollectionData) return;
            
            const sortValue = document.getElementById('userCollectionSort').value;
            let sortedData = [...currentUserCollectionData];

            switch(sortValue) {
                case 'score_desc':
                    sortedData.sort((a, b) => calculateCollectorScore(b) - calculateCollectorScore(a));
                    break;
                case 'score_asc':
                    sortedData.sort((a, b) => calculateCollectorScore(a) - calculateCollectorScore(b));
                    break;
                case 'date_desc':
                    sortedData.sort((a, b) => new Date(b.added_at) - new Date(a.added_at));
                    break;
                case 'date_asc':
                    sortedData.sort((a, b) => new Date(a.added_at) - new Date(b.added_at));
                    break;
                case 'price_desc':
                    sortedData.sort((a, b) => (b.purchase_price || 0) - (a.purchase_price || 0));
                    break;
                case 'price_asc':
                    sortedData.sort((a, b) => (a.purchase_price || 0) - (b.purchase_price || 0));
                    break;
                case 'player_asc':
                    sortedData.sort((a, b) => {
                        const nameA = `${a.cards.players.first_name} ${a.cards.players.last_name}`.toLowerCase();
                        const nameB = `${b.cards.players.first_name} ${b.cards.players.last_name}`.toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'player_desc':
                    sortedData.sort((a, b) => {
                        const nameA = `${a.cards.players.first_name} ${a.cards.players.last_name}`.toLowerCase();
                        const nameB = `${b.cards.players.first_name} ${b.cards.players.last_name}`.toLowerCase();
                        return nameB.localeCompare(nameA);
                    });
                    break;
            }

            // Apply search filter if search is active
            const searchTerm = document.getElementById('userCollectionSearch').value.toLowerCase().trim();
            if (searchTerm) {
                sortedData = sortedData.filter(item => {
                    const player = item.cards.players;
                    const playerName = `${player.first_name} ${player.last_name}`.toLowerCase();
                    return playerName.includes(searchTerm);
                });
            }

            renderUserCollection(sortedData);
        }

        // Search User Collection
        function searchUserCollection() {
            sortUserCollection(); // Reuse sort function which now includes search filter
        }

        // Render User Collection
        function renderUserCollection(data) {
            const grid = document.getElementById('userCollectionGrid');
            grid.innerHTML = '';

            data.forEach(item => {
                const card = item.cards;
                const player = card.players;
                const set = card.card_sets;
                const manufacturer = set.manufacturers;
                const primaryImage = item.card_images?.find(img => img.is_primary);

                // Calculate Collector Score for this card
                const collectorScore = calculateCollectorScore(item);

                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.style.cursor = 'pointer';
                cardElement.onclick = () => showUserCardDetails(item, currentUserCollectionOwner);
                
                // Use override values if available
                const displayCardNumber = item.card_number_override || card.card_number;
                const displayIsRookie = item.is_rookie !== null ? item.is_rookie : card.is_rookie;
                
                let imageHTML = 'üèÄ';
                if (primaryImage && primaryImage.image_url) {
                    imageHTML = `<img src="${primaryImage.image_url}" alt="${player.first_name} ${player.last_name}">`;
                }
                
                cardElement.innerHTML = `
                    <div class="card-image">
                        ${imageHTML}
                        ${item.grade ? `<div class="card-grade-badge">${item.grading_company} ${item.grade}</div>` : ''}
                        ${item.auto_grade >= 10 ? `<div class="card-grade-badge" style="background: linear-gradient(135deg, var(--cupboard-purple), #9333ea); top: 10px; left: 10px; right: auto;">AUTO 10</div>` : ''}
                        <div class="card-grade-badge" style="background: linear-gradient(135deg, var(--cupboard-gold), #d4af37); top: auto; bottom: 10px; left: 10px; font-weight: bold;">
                            ‚≠ê ${collectorScore.toLocaleString()} pts
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="card-title">${player.first_name} ${player.last_name}</div>
                        <div class="card-meta">
                            <div class="card-meta-row">
                                <span>${set.year} ${manufacturer.name} ${set.set_name}</span>
                            </div>
                            <div class="card-meta-row">
                                <span>#${displayCardNumber || 'N/A'}</span>
                                <span>${item.cert_number || 'N/A'}</span>
                            </div>
                            ${displayIsRookie ? '<div style="color: var(--cupboard-gold);">‚≠ê ROOKIE CARD</div>' : ''}
                        </div>
                        ${item.purchase_price ? `<div class="card-price">$${item.purchase_price.toFixed(2)}</div>` : ''}
                    </div>
                `;
                
                grid.appendChild(cardElement);
            });
        }

        // Close User Collection Modal
        function closeUserCollectionModal() {
            document.getElementById('userCollectionModal').classList.remove('active');
        }

        // Show User Card Details
        function showUserCardDetails(item, ownerUsername) {
            const card = item.cards;
            const player = card.players;
            const set = card.card_sets;
            const manufacturer = set.manufacturers;
            const primaryImage = item.card_images?.find(img => img.is_primary);

            // Calculate Collector Score with breakdown
            const scoreBreakdown = calculateCollectorScoreWithBreakdown(item);

            const modal = document.getElementById('cardModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Hide edit button since it's not our card
            document.getElementById('editCardBtn').style.display = 'none';

            modalTitle.textContent = `${player.first_name} ${player.last_name}`;
            
            // Use override values if available
            const displayCardNumber = item.card_number_override || card.card_number;
            const displayVariant = item.variant_override || card.variant;
            const displayIsRookie = item.is_rookie !== null ? item.is_rookie : card.is_rookie;
            const displayIsAutograph = item.is_autograph !== null ? item.is_autograph : card.is_autograph;
            
            let imageHTML = '';
            if (primaryImage && primaryImage.image_url) {
                imageHTML = `
                    <div style="flex: 1; display: flex; justify-content: center; align-items: flex-start;">
                        <img src="${primaryImage.image_url}" alt="${player.first_name} ${player.last_name}" 
                             onclick="event.stopPropagation(); zoomImage('${primaryImage.image_url}')"
                             style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: zoom-in; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.05)'"
                             onmouseout="this.style.transform='scale(1)'">
                    </div>
                `;
            }
            
            modalBody.innerHTML = `
                <div style="background: rgba(255, 215, 0, 0.1); border: 2px solid var(--cupboard-gold); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="color: var(--cupboard-gold); font-weight: bold;">üë§ ${ownerUsername}'s Card</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.2)); border: 2px solid var(--cupboard-gold); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center; cursor: pointer;" onclick="toggleScoreBreakdown()">
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.25rem;">Collector Score <span style="font-size: 0.8rem;">(click for breakdown)</span></div>
                    <div style="font-size: 2rem; color: var(--cupboard-gold); font-weight: bold;">‚≠ê ${scoreBreakdown.totalScore.toLocaleString()} pts</div>
                </div>
                <div id="scoreBreakdownSection" style="display: none; background: rgba(30, 144, 255, 0.1); border: 2px solid var(--cupboard-blue); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <h4 style="color: var(--cupboard-blue); margin-bottom: 1rem; text-align: center;">üìä Score Breakdown</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <span><strong>Base Rarity:</strong> ${scoreBreakdown.rarityName}</span>
                            <span style="color: var(--cupboard-gold);">${scoreBreakdown.rarityPoints} pts</span>
                        </div>
                        ${scoreBreakdown.rookieBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <span><strong>Rookie Bonus:</strong></span>
                            <span style="color: var(--cupboard-gold);">+${scoreBreakdown.rookieBonus} pts</span>
                        </div>` : ''}
                        ${scoreBreakdown.autoBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <span><strong>Autograph Bonus:</strong>${scoreBreakdown.autoGradeName && scoreBreakdown.autoGradeName.includes('Auto 10') ? ' <span style="background: linear-gradient(135deg, var(--cupboard-purple), #9333ea); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; font-weight: bold;">AUTO 10</span>' : ''}</span>
                            <span style="color: var(--cupboard-gold);">+${scoreBreakdown.autoBonus} pts</span>
                        </div>` : ''}
                        ${scoreBreakdown.comboBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <span><strong>Rookie+Auto Combo:</strong></span>
                            <span style="color: var(--cupboard-gold);">+${scoreBreakdown.comboBonus} pts</span>
                        </div>` : ''}
                        <div style="border-top: 2px solid rgba(255,255,255,0.2); padding-top: 0.75rem; margin-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <span><strong>Base Total:</strong></span>
                                <span style="color: var(--cupboard-gold); font-weight: bold;">${scoreBreakdown.baseTotal} pts</span>
                            </div>
                        </div>
                        <div style="border-top: 2px solid rgba(255,255,255,0.2); padding-top: 0.75rem; margin-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <span><strong>Grade Multiplier:</strong> ${scoreBreakdown.gradeName}</span>
                                <span style="color: var(--cupboard-blue);">√ó${scoreBreakdown.gradeMultiplier}</span>
                            </div>
                            ${scoreBreakdown.autoGradeName && scoreBreakdown.autoGradeName !== 'No Auto Grade' ? `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <span><strong>Auto Grade Multiplier:</strong> ${scoreBreakdown.autoGradeName}</span>
                                <span style="color: var(--cupboard-blue);">√ó${scoreBreakdown.autoGradeMultiplier}</span>
                            </div>` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <span><strong>Set Multiplier:</strong> ${scoreBreakdown.setTier}</span>
                                <span style="color: var(--cupboard-blue);">√ó${scoreBreakdown.setMultiplier}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <span><strong>Player Multiplier:</strong> ${scoreBreakdown.playerTier}</span>
                                <span style="color: var(--cupboard-blue);">√ó${scoreBreakdown.playerMultiplier}</span>
                            </div>
                        </div>
                        <div style="border-top: 2px solid var(--cupboard-gold); padding-top: 0.75rem; margin-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.2)); border-radius: 6px;">
                                <span style="font-size: 1.1rem;"><strong>FINAL SCORE:</strong></span>
                                <span style="color: var(--cupboard-gold); font-size: 1.3rem; font-weight: bold;">${scoreBreakdown.totalScore.toLocaleString()} pts</span>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem; color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                            Formula: (${scoreBreakdown.baseTotal}) √ó ${scoreBreakdown.gradeMultiplier}${scoreBreakdown.autoGradeMultiplier > 1.0 ? ` √ó ${scoreBreakdown.autoGradeMultiplier}` : ''} √ó ${scoreBreakdown.setMultiplier} √ó ${scoreBreakdown.playerMultiplier} = ${scoreBreakdown.totalScore.toLocaleString()}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 1rem;">
                        <div><strong>Set:</strong> ${set.year} ${manufacturer.name} ${set.set_name}</div>
                        <div><strong>Rarity:</strong> ${displayCardNumber || 'N/A'}</div>
                        ${displayVariant ? `<div><strong>Variant:</strong> ${displayVariant}</div>` : ''}
                        ${displayIsRookie ? '<div style="color: var(--cupboard-gold);"><strong>‚≠ê ROOKIE CARD</strong></div>' : ''}
                        ${displayIsAutograph ? '<div style="color: var(--cupboard-purple);"><strong>‚úçÔ∏è AUTOGRAPH</strong></div>' : ''}
                        ${item.grading_company ? `<div><strong>Grade:</strong> ${item.grading_company} ${item.grade}${item.auto_grade ? ` / Auto ${item.auto_grade}` : ''}</div>` : ''}
                        ${item.cert_number ? `<div><strong>Cert #:</strong> ${item.cert_number}</div>` : ''}
                        <div><strong>Condition:</strong> ${item.condition || 'N/A'}</div>
                        ${item.purchase_price ? `<div><strong>Purchase Price:</strong> $${item.purchase_price.toFixed(2)}</div>` : ''}
                        ${item.purchase_date ? `<div><strong>Purchase Date:</strong> ${item.purchase_date}</div>` : ''}
                        <div><strong>Quantity:</strong> ${item.quantity}</div>
                        ${item.notes ? `<div><strong>Notes:</strong> ${item.notes}</div>` : ''}
                        <div><strong>Added:</strong> ${new Date(item.added_at).toLocaleDateString()}</div>
                    </div>
                    ${imageHTML}
                </div>
            `;

            modal.classList.add('active');
            
            // Check if variant is KABOOM and trigger fireworks
            if (displayVariant && displayVariant.toLowerCase().includes('kaboom')) {
                setTimeout(() => triggerFireworks(), 300);
            }
        }

        // Toggle Score Breakdown
        function toggleScoreBreakdown() {
            const breakdown = document.getElementById('scoreBreakdownSection');
            if (breakdown.style.display === 'none') {
                breakdown.style.display = 'block';
            } else {
                breakdown.style.display = 'none';
            }
        }

        // Calculate Collector Score with Detailed Breakdown
        // Calculate Collector Score with Breakdown
        function calculateCollectorScoreWithBreakdown(card) {
            // Copy the same logic from calculateCollectorScore but return full breakdown
            let rarityPoints = 10;
            let rarityName = 'Base';
            const rarity = (card.card_number_override || card.cards?.card_number || '').toLowerCase();
            
            // Extract the number from the rarity
            let rarityNum = null;
            const match = rarity.match(/\/(\d+)/);
            if (match) {
                rarityNum = parseInt(match[1]);
            }

            // Assign points and name based on ranges
            if (rarity.includes('1/1')) { 
                rarityPoints = 1000; 
                rarityName = '1/1'; 
            }
            else if (rarityNum !== null) {
                if (rarityNum >= 2 && rarityNum <= 4) { 
                    rarityPoints = 750; 
                    rarityName = `/${rarityNum} (Ultra Rare)`; 
                }
                else if (rarityNum >= 5 && rarityNum <= 7) { 
                    rarityPoints = 600; 
                    rarityName = `/${rarityNum} (Super Rare)`; 
                }
                else if (rarityNum >= 8 && rarityNum <= 10) { 
                    rarityPoints = 500; 
                    rarityName = `/${rarityNum} (Very Rare)`; 
                }
                else if (rarityNum >= 11 && rarityNum <= 15) { 
                    rarityPoints = 400; 
                    rarityName = `/${rarityNum} (High Rare)`; 
                }
                else if (rarityNum >= 16 && rarityNum <= 25) { 
                    rarityPoints = 350; 
                    rarityName = `/${rarityNum} (Rare)`; 
                }
                else if (rarityNum >= 26 && rarityNum <= 35) { 
                    rarityPoints = 275; 
                    rarityName = `/${rarityNum} (Uncommon)`; 
                }
                else if (rarityNum >= 36 && rarityNum <= 49) { 
                    rarityPoints = 225; 
                    rarityName = `/${rarityNum}`; 
                }
                else if (rarityNum >= 50 && rarityNum <= 75) { 
                    rarityPoints = 175; 
                    rarityName = `/${rarityNum}`; 
                }
                else if (rarityNum >= 76 && rarityNum <= 99) { 
                    rarityPoints = 150; 
                    rarityName = `/${rarityNum}`; 
                }
                else if (rarityNum >= 100 && rarityNum <= 149) { 
                    rarityPoints = 100; 
                    rarityName = `/${rarityNum}`; 
                }
                else if (rarityNum >= 150 && rarityNum <= 199) { 
                    rarityPoints = 75; 
                    rarityName = `/${rarityNum}`; 
                }
                else if (rarityNum >= 200 && rarityNum <= 299) { 
                    rarityPoints = 50; 
                    rarityName = `/${rarityNum}`; 
                }
                else if (rarityNum >= 300 && rarityNum <= 499) { 
                    rarityPoints = 35; 
                    rarityName = `/${rarityNum}`; 
                }
                else if (rarityNum >= 500) { 
                    rarityPoints = 20; 
                    rarityName = `/${rarityNum} (High Print)`; 
                }
            }
            else if (rarity.includes('case hit')) { 
                rarityPoints = 400; 
                rarityName = 'Case Hit'; 
            }
            else if (rarity.includes('ssp')) { 
                rarityPoints = 250; 
                rarityName = 'SSP'; 
            }
            else if (rarity.includes('sp')) { 
                rarityPoints = 100; 
                rarityName = 'SP'; 
            }

            const isRookie = card.is_rookie !== null ? card.is_rookie : card.cards?.is_rookie;
            const isAuto = card.is_autograph !== null ? card.is_autograph : card.cards?.is_autograph;
            
            let rookieBonus = isRookie ? 200 : 0;
            let autoBonus = isAuto ? 300 : 0;
            let comboBonus = (isRookie && isAuto) ? 100 : 0;
            let baseTotal = rarityPoints + rookieBonus + autoBonus + comboBonus;

            let gradeMultiplier = 1.0;
            let gradeName = 'Raw/Ungraded';
            const grade = card.grade;
            const gradingCompany = card.grading_company;
            
            if (gradingCompany && grade) {
                if (grade >= 10) { gradeMultiplier = 2.5; gradeName = `${gradingCompany} ${grade}`; }
                else if (grade >= 9.5) { gradeMultiplier = 2.0; gradeName = `${gradingCompany} ${grade}`; }
                else if (grade >= 9) { gradeMultiplier = 1.75; gradeName = `${gradingCompany} ${grade}`; }
                else if (grade >= 8.5) { gradeMultiplier = 1.5; gradeName = `${gradingCompany} ${grade}`; }
                else if (grade >= 8) { gradeMultiplier = 1.3; gradeName = `${gradingCompany} ${grade}`; }
                else if (grade >= 7) { gradeMultiplier = 1.15; gradeName = `${gradingCompany} ${grade}`; }
                else if (grade >= 6) { gradeMultiplier = 1.05; gradeName = `${gradingCompany} ${grade}`; }
            }

            // Auto Grade Multiplier
            let autoGradeMultiplier = 1.0;
            let autoGradeName = 'No Auto Grade';
            const autoGrade = card.auto_grade;
            
            console.log('Card auto_grade:', autoGrade, 'for card:', card.cards?.players?.first_name, card.cards?.players?.last_name);
            
            if (autoGrade && autoGrade >= 10) {
                autoGradeMultiplier = 1.5;
                autoGradeName = `Auto ${autoGrade} (1.5x)`;
            }

            let setMultiplier = 1.0;
            let setTier = 'Base Tier';
            const setName = (card.cards?.card_sets?.set_name || '').toLowerCase();
            const manufacturer = (card.cards?.card_sets?.manufacturers?.name || '').toLowerCase();
            const year = card.cards?.card_sets?.year;

            if ((year === 2014 && manufacturer.includes('panini') && setName.includes('prizm') && setName.includes('world cup')) ||
                (year === 2017 && manufacturer.includes('topps') && setName.includes('chrome')) ||
                (manufacturer.includes('panini') && setName.includes('flawless')) ||
                (manufacturer.includes('panini') && setName.includes('eminence'))) {
                setMultiplier = 3.5; setTier = 'S-Tier (3.5x)';
            }
            else if ((manufacturer.includes('panini') && setName.includes('national treasures')) ||
                     (manufacturer.includes('topps') && setName.includes('stadium club')) ||
                     (manufacturer.includes('topps') && setName.includes('inception')) ||
                     (manufacturer.includes('topps') && setName.includes('sapphire')) ||
                     (year === 2018 && manufacturer.includes('topps') && setName.includes('chrome')) ||
                     (year === 2019 && manufacturer.includes('topps') && setName.includes('chrome')) ||
                     (manufacturer.includes('panini') && setName.includes('prizm') && setName.includes('world cup') && year !== 2014)) {
                setMultiplier = 2.5; setTier = 'A-Tier (2.5x)';
            }
            else if ((manufacturer.includes('topps') && setName.includes('chrome') && year !== 2017 && year !== 2018 && year !== 2019) ||
                     (manufacturer.includes('panini') && setName.includes('prizm') && !setName.includes('world cup')) ||
                     (manufacturer.includes('panini') && setName.includes('immaculate')) ||
                     (manufacturer.includes('panini') && setName.includes('impeccable')) ||
                     (manufacturer.includes('panini') && setName.includes('select'))) {
                setMultiplier = 1.8; setTier = 'B-Tier (1.8x)';
            }
            else if ((manufacturer.includes('topps') && setName.includes('finest')) ||
                     (manufacturer.includes('panini') && setName.includes('obsidian')) ||
                     (manufacturer.includes('panini') && setName.includes('donruss')) ||
                     (manufacturer.includes('panini') && setName.includes('mosaic')) ||
                     (setName.includes('bowman'))) {
                setMultiplier = 1.3; setTier = 'C-Tier (1.3x)';
            }

            let playerMultiplier = 1.0;
            let playerTier = 'D-Tier (1.0x)';
            const player = card.cards?.players;
            const playerName = player ? `${player.first_name} ${player.last_name}`.toLowerCase() : '';

            const sTier = ['lionel messi', 'cristiano ronaldo', 'pel√©', 'pele', 'diego maradona', 'ronaldo naz√°rio', 'ronaldo nazario', 'johan cruyff', 'zinedine zidane'];
            const aPlusTier = ['franz beckenbauer', 'alfredo di st√©fano', 'alfredo di stefano', 'ronaldinho', 'michel platini', 'ferenc pusk√°s', 'ferenc puskas', 'paolo maldini', 'thierry henry', 'xavi', 'andr√©s iniesta', 'andres iniesta', 'eus√©bio', 'eusebio', 'gerd m√ºller', 'gerd muller', 'george best', 'neymar', 'neymar jr', 'neymar jr.', 'luka modriƒá', 'luka modric', 'bobby charlton', 'lev yashin', 'franco baresi', 'roberto baggio', 'ruud gullit', 'marco van basten', 'rivaldo', 'sergio ramos', 'roberto carlos', 'andrea pirlo', 'kak√°', 'kaka', 'clarence seedorf', 'philipp lahm', 'cafu', 'luis su√°rez', 'luis suarez', 'karim benzema'];
            const aTier = ['zlatan ibrahimoviƒá', 'zlatan ibrahimovic', 'dennis bergkamp', 'xabi alonso', 'steven gerrard', 'frank lampard', 'paul scholes', 'ronald koeman', 'alessandro del piero', 'francesco totti', 'ra√∫l', 'raul', 'manuel neuer', 'iker casillas', 'gianluigi buffon', 'didier drogba', 'samuel eto\'o', 'samuel etoo', 'wayne rooney', 'ryan giggs', 'arjen robben', 'franck rib√©ry', 'franck ribery', 'luis figo', 'patrick vieira', 'claude mak√©l√©l√©', 'claude makelele', 'thiago silva', 'fabio cannavaro', 'nemanja vidiƒá', 'nemanja vidic', 'virgil van dijk', 'kevin de bruyne', 'mohamed salah', 'robert lewandowski', 'thomas m√ºller', 'thomas muller'];
            const bTier = ['erling haaland', 'kylian mbapp√©', 'kylian mbappe', 'harry kane', 'son heung-min', 'sergio ag√ºero', 'sergio aguero', 'david beckham', 'fernando torres', 'carlos tevez', 'wesley sneijder', 'pavel nedvƒõd', 'pavel nedved', 'michael ballack', 'juan rom√°n riquelme', 'juan roman riquelme', 'dani alves', 'marcelo', 'gerard piqu√©', 'gerard pique', 'carles puyol', 'giorgio chiellini', 'leonardo bonucci', 'toni kroos', 'sadio man√©', 'sadio mane', 'eden hazard', 'riyad mahrez', 'bruno fernandes', '√°ngel di mar√≠a', 'angel di maria', 'mesut √∂zil', 'mesut ozil', 'marco reus', 'robin van persie', 'radamel falcao', 'james rodr√≠guez', 'james rodriguez', 'antoine griezmann'];
            const cTier = ['bernardo silva', 'rodri', 'joshua kimmich', 'declan rice', 'n\'golo kant√©', 'ngolo kante', 'arturo vidal', 'paul pogba', 'david silva', 'cesc f√†bregas', 'cesc fabregas', 'fernandinho', 'casemiro', 'ivan rakitiƒá', 'ivan rakitic', 'henrikh mkhitaryan', 'lautaro mart√≠nez', 'lautaro martinez', 'romelu lukaku', 'pierre-emerick aubameyang', 'jamie vardy', 'isco', 'jo√£o f√©lix', 'joao felix', 'jude bellingham', 'pedri', 'phil foden', 'bukayo saka', 'jack grealish', 'rafael le√£o', 'rafael leao', 'victor osimhen', 'achraf hakimi', 'theo hern√°ndez', 'theo hernandez', 'matthijs de ligt', 'william saliba'];

            if (sTier.includes(playerName)) { playerMultiplier = 4.0; playerTier = 'üêê S-Tier (4.0x)'; }
            else if (aPlusTier.includes(playerName)) { playerMultiplier = 3.0; playerTier = 'üî• A+ Tier (3.0x)'; }
            else if (aTier.includes(playerName)) { playerMultiplier = 2.5; playerTier = '‚≠ê A-Tier (2.5x)'; }
            else if (bTier.includes(playerName)) { playerMultiplier = 2.0; playerTier = 'üëç B-Tier (2.0x)'; }
            else if (cTier.includes(playerName)) { playerMultiplier = 1.5; playerTier = 'üìò C-Tier (1.5x)'; }

            const totalScore = Math.round(baseTotal * gradeMultiplier * autoGradeMultiplier * setMultiplier * playerMultiplier);

            return {
                rarityPoints,
                rarityName,
                rookieBonus,
                autoBonus,
                comboBonus,
                baseTotal,
                gradeMultiplier,
                gradeName,
                autoGradeMultiplier,
                autoGradeName,
                setMultiplier,
                setTier,
                playerMultiplier,
                playerTier,
                totalScore
            };
        }

        // Fireworks Animation for KABOOM Cards
        function triggerFireworks() {
            const colors = ['#ff0000', '#ffd700', '#ff6600', '#00ff00', '#0099ff', '#ff00ff'];
            const fireworkCount = 8;
            
            for (let i = 0; i < fireworkCount; i++) {
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * (window.innerHeight * 0.6) + (window.innerHeight * 0.1);
                    createFirework(x, y, colors[Math.floor(Math.random() * colors.length)]);
                }, i * 200);
            }
        }

        function createFirework(x, y, color) {
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.backgroundColor = color;
                
                const angle = (Math.PI * 2 * i) / particleCount;
                const velocity = 50 + Math.random() * 100;
                const xVel = Math.cos(angle) * velocity;
                const yVel = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--x', xVel + 'px');
                particle.style.setProperty('--y', yVel + 'px');
                
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        // Image Zoom Functions
        function zoomImage(imageUrl) {
            const modal = document.getElementById('imageZoomModal');
            const img = document.getElementById('zoomedImage');
            img.src = imageUrl;
            modal.classList.add('active');
        }

        function closeImageZoom() {
            document.getElementById('imageZoomModal').classList.remove('active');
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const cardModal = document.getElementById('cardModal');
            const userModal = document.getElementById('userCollectionModal');
            if (event.target === cardModal) {
                closeCardModal();
            }
            if (event.target === userModal) {
                closeUserCollectionModal();
            }
        }
        // Load Collector Scores Tab
        let collectorScoresData = []; // Store breakdown data globally

        async function loadCollectorScores() {
            const loading = document.getElementById('scoresLoading');
            const tbody = document.getElementById('scoresTableBody');
            
            loading.style.display = 'flex';
            tbody.innerHTML = '';
            collectorScoresData = []; // Reset data

            try {
                const { data, error } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        ),
                        card_images (*)
                    `)
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                loading.style.display = 'none';

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.6);">
                                No cards in your collection yet. Add some cards to see their scores!
                            </td>
                        </tr>
                    `;
                    // Reset summary
                    document.getElementById('totalCollectorScore').textContent = '0';
                    document.getElementById('avgCollectorScore').textContent = '0';
                    document.getElementById('bestCardScore').textContent = '0';
                    document.getElementById('bestCardName').textContent = '-';
                    return;
                }

                // Calculate scores and sort
                const sortedData = data.sort((a, b) => calculateCollectorScore(b) - calculateCollectorScore(a));

                // Calculate summary stats
                let totalScore = 0;
                let bestScore = 0;
                let bestCardPlayer = '';

                sortedData.forEach((item, index) => {
                    const score = calculateCollectorScore(item);
                    totalScore += score;
                    
                    if (score > bestScore) {
                        bestScore = score;
                        const player = item.cards.players;
                        bestCardPlayer = `${player.first_name} ${player.last_name}`;
                    }
                });

                const avgScore = Math.round(totalScore / data.length);

                // Update summary cards
                document.getElementById('totalCollectorScore').textContent = totalScore.toLocaleString();
                document.getElementById('avgCollectorScore').textContent = avgScore.toLocaleString();
                document.getElementById('bestCardScore').textContent = bestScore.toLocaleString();
                document.getElementById('bestCardName').textContent = bestCardPlayer;

                // Render table rows
                sortedData.forEach((item, index) => {
                    const card = item.cards;
                    const player = card.players;
                    const set = card.card_sets;
                    const manufacturer = set.manufacturers;
                    
                    const score = calculateCollectorScore(item);
                    const breakdown = calculateCollectorScoreWithBreakdown(item);
                    
                    // Store breakdown data
                    collectorScoresData.push(breakdown);

                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    row.style.transition = 'background 0.2s';
                    row.onmouseover = () => row.style.background = 'rgba(255,255,255,0.05)';
                    row.onmouseout = () => row.style.background = 'transparent';

                    const displayRarity = item.card_number_override || card.card_number || 'N/A';
                    const gradingDisplay = item.grading_company ? `${item.grading_company} ${item.grade}` : 'Raw';

                    // Rank display with medals
                    let rankDisplay = `#${index + 1}`;
                    if (index === 0) rankDisplay = 'ü•á';
                    else if (index === 1) rankDisplay = 'ü•à';
                    else if (index === 2) rankDisplay = 'ü•â';

                    row.innerHTML = `
                        <td style="padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold;">${rankDisplay}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: bold; color: var(--cupboard-blue);">${player.first_name} ${player.last_name}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                ${item.is_rookie || card.is_rookie ? '‚≠ê Rookie  ' : ''}
                                ${item.is_autograph || card.is_autograph ? '‚úçÔ∏è Auto' : ''}
                            </div>
                        </td>
                        <td style="padding: 1rem;">
                            <div>${set.year} ${manufacturer.name}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${set.set_name}</div>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <div style="font-weight: bold; color: var(--cupboard-gold);">${displayRarity}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">${breakdown.rarityPoints} pts</div>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <div style="font-weight: bold;">${gradingDisplay}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">${breakdown.gradeMultiplier}x</div>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--cupboard-gold);">${score.toLocaleString()}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">pts</div>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <button onclick='showScoreBreakdownModal(${index})'
                                    style="padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--cupboard-blue), var(--cupboard-purple)); border: none; border-radius: 6px; color: white; cursor: pointer; font-family: 'Outfit', sans-serif; transition: transform 0.2s;">
                                üìä View
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading collector scores:', error);
                loading.style.display = 'none';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: #ff4500;">
                            Error loading scores: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Show Score Breakdown Modal
        function showScoreBreakdownModal(index) {
            const breakdown = collectorScoresData[index];
            if (!breakdown) {
                console.error('Breakdown data not found');
                return;
            }
            
            const baseTotal = breakdown.rarityPoints + breakdown.rookieBonus + breakdown.autoBonus + breakdown.comboBonus;
            
            const modal = document.getElementById('scoreBreakdownModal');
            const body = document.getElementById('scoreBreakdownBody');
            
            body.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.2)); border: 2px solid var(--cupboard-gold); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem;">Total Collector Score</div>
                    <div style="font-size: 3rem; color: var(--cupboard-gold); font-weight: bold;">‚≠ê ${breakdown.totalScore.toLocaleString()} pts</div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="background: rgba(30, 144, 255, 0.1); border: 2px solid var(--cupboard-blue); border-radius: 8px; padding: 1rem;">
                        <h3 style="color: var(--cupboard-blue); margin-bottom: 1rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">üéØ Base Points</h3>
                        
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span><strong>Rarity:</strong> ${breakdown.rarityName}</span>
                            <span style="color: var(--cupboard-gold);">${breakdown.rarityPoints} pts</span>
                        </div>
                        
                        ${breakdown.rookieBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span><strong>‚≠ê Rookie Bonus:</strong></span>
                            <span style="color: var(--cupboard-gold);">+${breakdown.rookieBonus} pts</span>
                        </div>` : ''}
                        
                        ${breakdown.autoBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span><strong>‚úçÔ∏è Autograph Bonus:</strong>${breakdown.autoGradeName && breakdown.autoGradeName.includes('Auto 10') ? ' <span style="background: linear-gradient(135deg, var(--cupboard-purple), #9333ea); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; font-weight: bold;">AUTO 10</span>' : ''}</span>
                            <span style="color: var(--cupboard-gold);">+${breakdown.autoBonus} pts</span>
                        </div>` : ''}
                        
                        ${breakdown.comboBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span><strong>üî• Rookie+Auto Combo:</strong></span>
                            <span style="color: var(--cupboard-gold);">+${breakdown.comboBonus} pts</span>
                        </div>` : ''}
                        
                        <div style="border-top: 2px solid var(--cupboard-blue); margin-top: 0.5rem; padding-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255, 215, 0, 0.1); border-radius: 6px;">
                                <span style="font-weight: bold;">Subtotal:</span>
                                <span style="color: var(--cupboard-gold); font-weight: bold; font-size: 1.2rem;">${baseTotal} pts</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(138, 43, 226, 0.1); border: 2px solid var(--cupboard-purple); border-radius: 8px; padding: 1rem;">
                        <h3 style="color: var(--cupboard-purple); margin-bottom: 1rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">üìà Multipliers</h3>
                        
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                            <div>
                                <strong>üèÜ Grade:</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${breakdown.gradeName}</div>
                            </div>
                            <span style="color: var(--cupboard-purple); font-size: 1.3rem; font-weight: bold;">√ó${breakdown.gradeMultiplier}</span>
                        </div>
                        
                        ${breakdown.autoGradeName && breakdown.autoGradeName !== 'No Auto Grade' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                            <div>
                                <strong>‚úçÔ∏è Auto Grade:</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${breakdown.autoGradeName}</div>
                            </div>
                            <span style="color: var(--cupboard-purple); font-size: 1.3rem; font-weight: bold;">√ó${breakdown.autoGradeMultiplier}</span>
                        </div>` : ''}
                        
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                            <div>
                                <strong>üì¶ Set:</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${breakdown.setTier}</div>
                            </div>
                            <span style="color: var(--cupboard-purple); font-size: 1.3rem; font-weight: bold;">√ó${breakdown.setMultiplier}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <div>
                                <strong>üë§ Player:</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${breakdown.playerTier}</div>
                            </div>
                            <span style="color: var(--cupboard-purple); font-size: 1.3rem; font-weight: bold;">√ó${breakdown.playerMultiplier}</span>
                        </div>
                    </div>

                    <div style="background: rgba(255, 215, 0, 0.05); border: 2px solid var(--cupboard-gold); border-radius: 8px; padding: 1rem;">
                        <h3 style="color: var(--cupboard-gold); margin-bottom: 0.5rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px;">üßÆ Calculation</h3>
                        <div style="text-align: center; font-family: monospace; font-size: 1rem; color: rgba(255,255,255,0.8); line-height: 1.8;">
                            (${baseTotal}) √ó ${breakdown.gradeMultiplier}${breakdown.autoGradeMultiplier > 1.0 ? ` √ó ${breakdown.autoGradeMultiplier}` : ''} √ó ${breakdown.setMultiplier} √ó ${breakdown.playerMultiplier}
                        </div>
                        <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--cupboard-gold);">
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Final Score</div>
                            <div style="font-size: 2.5rem; color: var(--cupboard-gold); font-weight: bold;">
                                ${breakdown.totalScore.toLocaleString()} pts
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        // Close Score Breakdown Modal
        function closeScoreBreakdownModal() {
            document.getElementById('scoreBreakdownModal').classList.remove('active');
        }

        // ================================
        // SALES HISTORY FUNCTIONS
        // ================================

        let allSalesData = [];
        let selectedSaleCard = null;

        // Load Sales History
        async function loadSalesHistory() {
            const loading = document.getElementById('salesLoading');
            const salesList = document.getElementById('salesList');
            const emptyState = document.getElementById('salesEmptyState');
            
            loading.style.display = 'flex';
            salesList.innerHTML = '';
            emptyState.style.display = 'none';

            try {
                // Fetch sales history
                const { data, error } = await supabase
                    .from('sales_history')
                    .select('*')
                    .eq('auth_user_id', currentUser.id)
                    .order('sale_date', { ascending: false });

                if (error) throw error;

                loading.style.display = 'none';
                allSalesData = data || [];

                if (allSalesData.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                // Calculate and display stats
                displaySalesStats(allSalesData);
                
                // Display sales list
                displaySalesList(allSalesData);

            } catch (error) {
                console.error('Error loading sales history:', error);
                loading.style.display = 'none';
                salesList.innerHTML = `<div class="alert alert-error">Error loading sales: ${error.message}</div>`;
            }
        }

        // Display Sales Stats
        function displaySalesStats(sales) {
            const container = document.getElementById('salesStatsContainer');
            
            // Calculate stats
            const totalSales = sales.length;
            const totalRevenue = sales.reduce((sum, sale) => sum + (parseFloat(sale.sale_price) || 0), 0);
            const totalProfit = sales.reduce((sum, sale) => sum + (parseFloat(sale.net_profit) || 0), 0);
            const avgROI = sales.length > 0 ? sales.reduce((sum, sale) => sum + (parseFloat(sale.roi_percentage) || 0), 0) / sales.length : 0;
            const profitableSales = sales.filter(s => (parseFloat(s.net_profit) || 0) > 0).length;
            const winRate = totalSales > 0 ? (profitableSales / totalSales * 100) : 0;

            // Find best sale
            let bestSale = null;
            let highestProfit = -Infinity;
            sales.forEach(sale => {
                const profit = parseFloat(sale.net_profit) || 0;
                if (profit > highestProfit) {
                    highestProfit = profit;
                    bestSale = sale;
                }
            });

            container.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(30, 144, 255, 0.1)); border: 2px solid var(--cupboard-blue); border-radius: 12px; padding: 1.5rem;">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Total Sales</div>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-blue);">${totalSales}</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 255, 136, 0.1)); border: 2px solid var(--cupboard-green); border-radius: 12px; padding: 1.5rem;">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Total Revenue</div>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-green);">$${totalRevenue.toFixed(2)}</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1)); border: 2px solid var(--cupboard-gold); border-radius: 12px; padding: 1.5rem;">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Total Profit</div>
                    <div style="font-size: 2rem; font-weight: bold; color: ${totalProfit >= 0 ? 'var(--cupboard-green)' : '#ff6b6b'};">${totalProfit >= 0 ? '+' : ''}$${totalProfit.toFixed(2)}</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(138, 43, 226, 0.1)); border: 2px solid var(--cupboard-purple); border-radius: 12px; padding: 1.5rem;">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Avg ROI</div>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-purple);">${avgROI >= 0 ? '+' : ''}${avgROI.toFixed(1)}%</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.1)); border: 2px solid rgba(255, 107, 107, 0.5); border-radius: 12px; padding: 1.5rem;">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Win Rate</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #ff6b6b;">${winRate.toFixed(0)}%</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">${profitableSales}/${totalSales} profitable</div>
                </div>
                ${bestSale ? `
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(212, 175, 55, 0.1)); border: 2px solid var(--cupboard-gold); border-radius: 12px; padding: 1.5rem;">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Best Sale</div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.25rem;">${bestSale.player_name}</div>
                    <div style="font-size: 0.85rem; color: var(--cupboard-green);">+$${highestProfit.toFixed(2)} profit</div>
                </div>
                ` : ''}
            `;
        }

        // Display Sales List
        function displaySalesList(sales) {
            const salesList = document.getElementById('salesList');
            
            if (sales.length === 0) {
                salesList.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No sales match your filters</div>';
                return;
            }

            salesList.innerHTML = sales.map(sale => {
                const netProfit = parseFloat(sale.net_profit) || 0;
                const roi = parseFloat(sale.roi_percentage) || 0;
                const saleDate = new Date(sale.sale_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                const profitColor = netProfit > 0 ? 'var(--cupboard-green)' : netProfit < 0 ? '#ff6b6b' : 'rgba(255,255,255,0.5)';
                const profitSign = netProfit > 0 ? '+' : '';

                return `
                    <div style="background: rgba(30, 144, 255, 0.05); border: 2px solid rgba(30, 144, 255, 0.2); border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.background='rgba(30, 144, 255, 0.1)'; this.style.borderColor='var(--cupboard-blue)'" 
                         onmouseout="this.style.background='rgba(30, 144, 255, 0.05)'; this.style.borderColor='rgba(30, 144, 255, 0.2)'"
                         onclick="showSaleDetail('${sale.sale_id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">${saleDate}</div>
                                    ${sale.sale_platform ? `<div style="background: rgba(30, 144, 255, 0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; color: var(--cupboard-blue);">${sale.sale_platform}</div>` : ''}
                                </div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem;">${sale.player_name}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                                    ${sale.card_year} ${sale.card_set}
                                    ${sale.card_number ? ` ‚Ä¢ #${sale.card_number}` : ''}
                                    ${sale.card_grade ? ` ‚Ä¢ ${sale.card_grade}` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 0.25rem;">Sold For</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--cupboard-green); margin-bottom: 0.5rem;">$${parseFloat(sale.sale_price).toFixed(2)}</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: ${profitColor};">
                                    ${profitSign}$${Math.abs(netProfit).toFixed(2)} (${profitSign}${roi.toFixed(1)}%)
                                </div>
                                ${sale.hold_days ? `<div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">Held ${sale.hold_days} days</div>` : ''}
                            </div>
                        </div>
                        ${sale.buyer_username ? `<div style="margin-top: 0.75rem; font-size: 0.85rem; color: rgba(255,255,255,0.6);">üë§ Buyer: ${sale.buyer_username}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Filter Sales
        function filterSales() {
            const searchTerm = document.getElementById('salesSearch').value.toLowerCase();
            const platformFilter = document.getElementById('salesPlatformFilter').value;
            const profitFilter = document.getElementById('salesProfitFilter').value;

            let filtered = [...allSalesData];

            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(sale => 
                    (sale.player_name || '').toLowerCase().includes(searchTerm) ||
                    (sale.card_set || '').toLowerCase().includes(searchTerm) ||
                    (sale.card_number || '').toLowerCase().includes(searchTerm)
                );
            }

            // Platform filter
            if (platformFilter) {
                filtered = filtered.filter(sale => sale.sale_platform === platformFilter);
            }

            // Profit/Loss filter
            if (profitFilter) {
                filtered = filtered.filter(sale => {
                    const profit = parseFloat(sale.net_profit) || 0;
                    if (profitFilter === 'profit') return profit > 0;
                    if (profitFilter === 'loss') return profit < 0;
                    if (profitFilter === 'breakeven') return profit === 0;
                    return true;
                });
            }

            displaySalesList(filtered);
        }

        // Show Record Sale Modal
        async function showRecordSaleModal() {
            const modal = document.getElementById('recordSaleModal');
            const cardSelect = document.getElementById('saleCardSelect');
            const alert = document.getElementById('recordSaleAlert');
            
            alert.innerHTML = '';
            
            // Populate card dropdown from collection
            try {
                const { data, error } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        ),
                        card_images (*)
                    `)
                    .eq('auth_user_id', currentUser.id)
                    .order('added_at', { ascending: false });

                if (error) throw error;

                cardSelect.innerHTML = '<option value="">Choose a card...</option>' + 
                    data.map(item => {
                        const player = item.cards.players;
                        const set = item.cards.card_sets;
                        const manufacturer = set.manufacturers;
                        const displayNumber = item.card_number_override || item.cards.card_number;
                        const gradeText = item.grading_company ? ` ${item.grading_company} ${item.grade}` : '';
                        
                        return `<option value="${item.collection_id}" 
                                        data-purchase-price="${item.purchase_price || 0}"
                                        data-purchase-date="${item.purchase_date || ''}"
                                        data-player-name="${player.first_name} ${player.last_name}"
                                        data-card-year="${set.year}"
                                        data-card-set="${manufacturer.name} ${set.set_name}"
                                        data-card-number="${displayNumber || ''}"
                                        data-card-grade="${item.grading_company && item.grade ? item.grading_company + ' ' + item.grade : ''}"
                                        data-card-image="${item.card_images?.find(img => img.is_primary)?.image_url || ''}">
                                ${player.first_name} ${player.last_name} - ${set.year} ${manufacturer.name} ${set.set_name}${gradeText}
                        </option>`;
                    }).join('');

                // Set today's date as default
                document.getElementById('saleDate').valueAsDate = new Date();
                
                modal.classList.add('active');

            } catch (error) {
                console.error('Error loading cards:', error);
                alert.innerHTML = '<div class="alert alert-error">Error loading cards: ' + error.message + '</div>';
            }
        }

        // Close Record Sale Modal
        function closeRecordSaleModal() {
            document.getElementById('recordSaleModal').classList.remove('active');
            document.getElementById('recordSaleForm').reset();
            document.getElementById('profitCalculator').style.display = 'none';
            selectedSaleCard = null;
        }

        // Calculate Profit (real-time)
        function calculateProfit() {
            const cardSelect = document.getElementById('saleCardSelect');
            const selectedOption = cardSelect.options[cardSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                document.getElementById('profitCalculator').style.display = 'none';
                return;
            }

            const purchasePrice = parseFloat(selectedOption.dataset.purchasePrice) || 0;
            const purchaseDate = selectedOption.dataset.purchaseDate;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
            const fees = parseFloat(document.getElementById('feesCommission').value) || 0;
            const saleDate = document.getElementById('saleDate').value;

            if (salePrice === 0) {
                document.getElementById('profitCalculator').style.display = 'none';
                return;
            }

            const netProfit = salePrice - purchasePrice - shipping - fees;
            const roi = purchasePrice > 0 ? (netProfit / purchasePrice * 100) : 0;

            // Calculate hold days
            let holdDays = 0;
            if (purchaseDate && saleDate) {
                const pDate = new Date(purchaseDate);
                const sDate = new Date(saleDate);
                holdDays = Math.floor((sDate - pDate) / (1000 * 60 * 60 * 24));
            }

            // Update calculator display
            document.getElementById('calcPurchasePrice').textContent = '$' + purchasePrice.toFixed(2);
            document.getElementById('calcSalePrice').textContent = '$' + salePrice.toFixed(2);
            document.getElementById('calcFees').textContent = '-$' + fees.toFixed(2);
            document.getElementById('calcShipping').textContent = '-$' + shipping.toFixed(2);
            document.getElementById('calcNetProfit').textContent = (netProfit >= 0 ? '+' : '') + '$' + netProfit.toFixed(2);
            document.getElementById('calcNetProfit').style.color = netProfit >= 0 ? 'var(--cupboard-green)' : '#ff6b6b';
            document.getElementById('calcROI').textContent = (roi >= 0 ? '+' : '') + roi.toFixed(1) + '%';
            document.getElementById('calcROI').style.color = roi >= 0 ? 'var(--cupboard-green)' : '#ff6b6b';
            document.getElementById('calcHoldDays').textContent = holdDays + ' days';

            document.getElementById('profitCalculator').style.display = 'block';
        }

        // Handle card selection change
        document.addEventListener('DOMContentLoaded', function() {
            const cardSelect = document.getElementById('saleCardSelect');
            if (cardSelect) {
                cardSelect.addEventListener('change', calculateProfit);
            }
        });

        // Submit Sale Record
        document.getElementById('recordSaleForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const alert = document.getElementById('recordSaleAlert');
            alert.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const cardSelect = document.getElementById('saleCardSelect');
                const selectedOption = cardSelect.options[cardSelect.selectedIndex];
                
                if (!selectedOption.value) {
                    throw new Error('Please select a card');
                }

                const collectionId = selectedOption.value;
                const purchasePrice = parseFloat(selectedOption.dataset.purchasePrice) || 0;
                const purchaseDate = selectedOption.dataset.purchaseDate || null;
                const playerName = selectedOption.dataset.playerName;
                const cardYear = parseInt(selectedOption.dataset.cardYear);
                const cardSet = selectedOption.dataset.cardSet;
                const cardNumber = selectedOption.dataset.cardNumber;
                const cardGrade = selectedOption.dataset.cardGrade;
                const cardImage = selectedOption.dataset.cardImage;

                const salePrice = parseFloat(document.getElementById('salePrice').value);
                const saleDate = document.getElementById('saleDate').value;
                const platform = document.getElementById('salePlatform').value;
                const buyerUsername = document.getElementById('buyerUsername').value;
                const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
                const fees = parseFloat(document.getElementById('feesCommission').value) || 0;
                const notes = document.getElementById('saleNotes').value;

                // Calculate profit and ROI
                const netProfit = salePrice - purchasePrice - shipping - fees;
                const roi = purchasePrice > 0 ? (netProfit / purchasePrice * 100) : 0;

                // Calculate hold days
                let holdDays = null;
                if (purchaseDate && saleDate) {
                    const pDate = new Date(purchaseDate);
                    const sDate = new Date(saleDate);
                    holdDays = Math.floor((sDate - pDate) / (1000 * 60 * 60 * 24));
                }

                // Insert sale record
                const { error } = await supabase
                    .from('sales_history')
                    .insert([{
                        collection_id: collectionId,
                        auth_user_id: currentUser.id,
                        sale_date: saleDate,
                        sale_price: salePrice,
                        sale_platform: platform,
                        buyer_username: buyerUsername,
                        shipping_cost: shipping,
                        fees_commission: fees,
                        purchase_price: purchasePrice,
                        purchase_date: purchaseDate,
                        player_name: playerName,
                        card_year: cardYear,
                        card_set: cardSet,
                        card_number: cardNumber,
                        card_grade: cardGrade,
                        card_image_url: cardImage,
                        net_profit: netProfit,
                        roi_percentage: roi,
                        hold_days: holdDays,
                        notes: notes
                    }]);

                if (error) throw error;

                // Check if user wants to remove card from collection
                const removeFromCollection = document.getElementById('removeFromCollection').checked;
                
                if (removeFromCollection) {
                    // Mark the card as sold (archive it) instead of deleting
                    const { error: soldError } = await supabase
                        .from('my_collection')
                        .update({ is_sold: true })
                        .eq('collection_id', collectionId);
                    
                    if (soldError) {
                        console.error('Error archiving card:', soldError);
                        alert.innerHTML = '<div class="alert alert-success">‚úÖ Sale recorded! (Note: Could not archive card)</div>';
                    } else {
                        alert.innerHTML = '<div class="alert alert-success">‚úÖ Sale recorded and card archived!</div>';
                    }
                } else {
                    alert.innerHTML = '<div class="alert alert-success">‚úÖ Sale recorded successfully!</div>';
                }
                
                // Check for newly unlocked achievements
                checkAchievements();
                
                setTimeout(() => {
                    closeRecordSaleModal();
                    loadSalesHistory(); // Reload the sales list
                    // Also reload collection if user is on that tab
                    if (document.getElementById('collectionTab').classList.contains('active')) {
                        loadCollection();
                    }
                }, 1500);

            } catch (error) {
                console.error('Error recording sale:', error);
                alert.innerHTML = '<div class="alert alert-error">‚ùå Error: ' + error.message + '</div>';
            }
        });

        // Show Sale Detail Modal
        async function showSaleDetail(saleId) {
            const modal = document.getElementById('saleDetailModal');
            const body = document.getElementById('saleDetailBody');
            
            // Find sale in data
            const sale = allSalesData.find(s => s.sale_id === saleId);
            if (!sale) return;

            const netProfit = parseFloat(sale.net_profit) || 0;
            const roi = parseFloat(sale.roi_percentage) || 0;
            const saleDate = new Date(sale.sale_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const purchaseDate = sale.purchase_date ? new Date(sale.purchase_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'Unknown';
            
            const profitColor = netProfit > 0 ? 'var(--cupboard-green)' : netProfit < 0 ? '#ff6b6b' : 'rgba(255,255,255,0.5)';
            const profitSign = netProfit > 0 ? '+' : '';

            body.innerHTML = `
                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    ${sale.card_image_url ? `
                        <div style="flex: 0 0 250px;">
                            <img src="${sale.card_image_url}" alt="${sale.player_name}" 
                                 style="width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        </div>
                    ` : ''}
                    <div style="flex: 1; min-width: 250px;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem;">${sale.player_name}</div>
                        <div style="font-size: 1.1rem; color: rgba(255,255,255,0.8); margin-bottom: 1.5rem;">
                            ${sale.card_year} ${sale.card_set}
                            ${sale.card_number ? ` ‚Ä¢ #${sale.card_number}` : ''}
                            ${sale.card_grade ? ` ‚Ä¢ ${sale.card_grade}` : ''}
                        </div>

                        <!-- Purchase Info -->
                        <div style="background: rgba(30, 144, 255, 0.1); border: 2px solid var(--cupboard-blue); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-weight: bold; color: var(--cupboard-blue); margin-bottom: 0.75rem;">üì• PURCHASE INFO</div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.95rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Date:</span>
                                    <span>${purchaseDate}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Price:</span>
                                    <span style="font-weight: bold;">$${(parseFloat(sale.purchase_price) || 0).toFixed(2)}</span>
                                </div>
                                ${sale.hold_days ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Hold Time:</span>
                                    <span>${sale.hold_days} days</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Sale Info -->
                        <div style="background: rgba(0, 255, 136, 0.1); border: 2px solid var(--cupboard-green); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-weight: bold; color: var(--cupboard-green); margin-bottom: 0.75rem;">üí∞ SALE INFO</div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.95rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Date:</span>
                                    <span>${saleDate}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Price:</span>
                                    <span style="font-weight: bold; color: var(--cupboard-green); font-size: 1.2rem;">$${parseFloat(sale.sale_price).toFixed(2)}</span>
                                </div>
                                ${sale.sale_platform ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Platform:</span>
                                    <span>${sale.sale_platform}</span>
                                </div>
                                ` : ''}
                                ${sale.buyer_username ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Buyer:</span>
                                    <span>${sale.buyer_username}</span>
                                </div>
                                ` : ''}
                                ${(parseFloat(sale.fees_commission) || 0) > 0 ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Fees:</span>
                                    <span style="color: #ff6b6b;">-$${parseFloat(sale.fees_commission).toFixed(2)}</span>
                                </div>
                                ` : ''}
                                ${(parseFloat(sale.shipping_cost) || 0) > 0 ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Shipping:</span>
                                    <span style="color: #ff6b6b;">-$${parseFloat(sale.shipping_cost).toFixed(2)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Profit Breakdown -->
                        <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1)); border: 2px solid var(--cupboard-gold); border-radius: 8px; padding: 1rem;">
                            <div style="font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.75rem;">üìä PROFIT BREAKDOWN</div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.95rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Revenue:</span>
                                    <span>$${parseFloat(sale.sale_price).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Cost:</span>
                                    <span>-$${(parseFloat(sale.purchase_price) || 0).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Fees:</span>
                                    <span>-$${(parseFloat(sale.fees_commission) || 0).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.6);">Shipping:</span>
                                    <span>-$${(parseFloat(sale.shipping_cost) || 0).toFixed(2)}</span>
                                </div>
                                <div style="border-top: 2px solid rgba(255,255,255,0.2); margin: 0.5rem 0; padding-top: 0.5rem;"></div>
                                <div style="display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: bold;">
                                    <span>NET PROFIT:</span>
                                    <span style="color: ${profitColor};">${profitSign}$${Math.abs(netProfit).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                    <span style="color: rgba(255,255,255,0.6);">ROI:</span>
                                    <span style="color: ${profitColor}; font-weight: bold;">${profitSign}${roi.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>

                        ${sale.notes ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem; color: rgba(255,255,255,0.7);">üìù NOTES:</div>
                            <div style="color: rgba(255,255,255,0.8); white-space: pre-wrap;">${sale.notes}</div>
                        </div>
                        ` : ''}

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn" onclick="undoSale('${sale.sale_id}', '${sale.collection_id}')" style="background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 140, 0, 0.2)); border: 2px solid #ffa500; flex: 1;">
                                ‚Ü©Ô∏è Undo Sale & Restore Card
                            </button>
                            <button class="btn" onclick="deleteSale('${sale.sale_id}')" style="background: rgba(255, 107, 107, 0.2); border: 2px solid #ff6b6b; flex: 1;">
                                üóëÔ∏è Delete Sale Only
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        // Close Sale Detail Modal
        function closeSaleDetailModal() {
            document.getElementById('saleDetailModal').classList.remove('active');
        }

        // Undo Sale - Delete sale record and restore card from archive
        async function undoSale(saleId, collectionId) {
            if (!confirm('‚ö†Ô∏è Undo this sale and restore the card from archive?\n\nThis will:\n‚úÖ Delete the sale record\n‚úÖ Restore the card to your active collection')) {
                return;
            }

            try {
                // Find the sale record
                const sale = allSalesData.find(s => s.sale_id === saleId);
                if (!sale) {
                    throw new Error('Sale record not found');
                }

                // Check if the card exists (archived or not)
                const { data: existingCard, error: checkError } = await supabase
                    .from('my_collection')
                    .select('*')
                    .eq('collection_id', collectionId)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }

                // Restore the card if it exists
                if (existingCard && existingCard.is_sold) {
                    const { error: restoreError } = await supabase
                        .from('my_collection')
                        .update({ is_sold: false })
                        .eq('collection_id', collectionId);
                    
                    if (restoreError) throw restoreError;
                }

                // Delete the sale record
                const { error: deleteError } = await supabase
                    .from('sales_history')
                    .delete()
                    .eq('sale_id', saleId);

                if (deleteError) throw deleteError;

                closeSaleDetailModal();
                loadSalesHistory();
                
                if (existingCard) {
                    alert('‚úÖ Sale undone! Card restored to your collection.');
                } else {
                    alert('‚ö†Ô∏è Sale deleted, but card was not found in archive.\n\nTo restore the card, add it again:\n' + 
                          sale.player_name + ' - ' + sale.card_year + ' ' + sale.card_set);
                }

                // Update archive button count
                await updateArchiveButtonCount();

                // Reload collection if user is viewing it
                if (document.getElementById('collectionTab').classList.contains('active')) {
                    loadCollection();
                }

            } catch (error) {
                console.error('Error undoing sale:', error);
                alert('Error undoing sale: ' + error.message);
            }
        }

        // Delete Sale
        async function deleteSale(saleId) {
            if (!confirm('Are you sure you want to delete this sale record? This cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('sales_history')
                    .delete()
                    .eq('sale_id', saleId);

                if (error) throw error;

                closeSaleDetailModal();
                loadSalesHistory();

            } catch (error) {
                console.error('Error deleting sale:', error);
                alert('Error deleting sale: ' + error.message);
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            const loading = document.getElementById('dashboardLoading');
            loading.style.display = 'flex';

            // Load user info in header
            loadHeaderUserInfo();

            try {
                const { data, error } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        )
                    `)
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                loading.style.display = 'none';

                if (!data || data.length === 0) {
                    document.getElementById('dashTotalValue').textContent = '$0';
                    document.getElementById('dashCollectorScore').textContent = '0';
                    document.getElementById('dashTotalCards').textContent = '0';
                    document.getElementById('dashAvgValue').textContent = '$0';
                    return;
                }

                // Calculate stats
                let totalValue = 0;
                let totalScore = 0;
                let gradedCount = 0;
                let rookieCount = 0;
                let autoCount = 0;
                let baseCount = 0;
                
                const playerCounts = {};
                const setCounts = {};
                const gradingCounts = {};
                const cardsByValue = [];

                data.forEach(item => {
                    // Value
                    const value = item.purchase_price || 0;
                    totalValue += value;
                    
                    // Score
                    totalScore += calculateCollectorScore(item);
                    
                    // Grading (only count cards with valid card grades > 0)
                    if (item.grading_company && item.grade && item.grade > 0) {
                        gradedCount++;
                        const gradeKey = `${item.grading_company} ${Math.floor(item.grade)}`;
                        gradingCounts[gradeKey] = (gradingCounts[gradeKey] || 0) + 1;
                    }
                    
                    // Card types
                    const isRookie = item.is_rookie || item.cards?.is_rookie;
                    const isAuto = item.is_autograph || item.cards?.is_autograph;
                    
                    if (isRookie) rookieCount++;
                    if (isAuto) autoCount++;
                    if (!isRookie && !isAuto) baseCount++;
                    
                    // Players
                    const player = item.cards?.players;
                    if (player) {
                        const playerName = `${player.first_name} ${player.last_name}`;
                        playerCounts[playerName] = (playerCounts[playerName] || 0) + 1;
                    }
                    
                    // Sets
                    const set = item.cards?.card_sets;
                    const manufacturer = set?.manufacturers;
                    if (set && manufacturer) {
                        const setName = `${set.year} ${manufacturer.name} ${set.set_name}`;
                        setCounts[setName] = (setCounts[setName] || 0) + 1;
                    }
                    
                    // For top cards
                    cardsByValue.push({
                        player: player ? `${player.first_name} ${player.last_name}` : 'Unknown',
                        value: value,
                        year: set?.year,
                        set: set?.set_name
                    });
                });

                // Update key stats
                document.getElementById('dashTotalValue').textContent = '$' + totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('dashCollectorScore').textContent = totalScore.toLocaleString();
                document.getElementById('dashTotalCards').textContent = data.length;
                document.getElementById('dashAvgValue').textContent = '$' + (totalValue / data.length).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('dashGradedPercent').textContent = Math.round((gradedCount / data.length) * 100) + '% graded';

                // Get user's rank
                const { data: profileData } = await supabase
                    .from('user_profiles')
                    .select('username, auth_user_id')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                if (profileData) {
                    const { data: leaderboardData } = await supabase
                        .from('user_profiles')
                        .select('username, auth_user_id')
                        .eq('share_stats', true);
                    
                    // Calculate scores for all users and sort
                    const userScores = [];
                    
                    for (const user of leaderboardData || []) {
                        const { data: userCards } = await supabase
                            .from('my_collection')
                            .select(`*, cards (*, players (*), card_sets (*, manufacturers (*)))`)
                            .eq('auth_user_id', user.auth_user_id)
                            .eq('is_sold', false);
                        
                        if (userCards) {
                            const userScore = userCards.reduce((sum, card) => sum + calculateCollectorScore(card), 0);
                            userScores.push({
                                auth_user_id: user.auth_user_id,
                                score: userScore
                            });
                        }
                    }
                    
                    // Sort by score descending
                    userScores.sort((a, b) => b.score - a.score);
                    
                    // Find current user's rank
                    const rank = userScores.findIndex(u => u.auth_user_id === currentUser.id) + 1;
                    
                    if (rank > 0) {
                        document.getElementById('dashScoreRank').textContent = `Rank #${rank} globally`;
                    } else {
                        document.getElementById('dashScoreRank').textContent = `Not ranked`;
                    }
                }

                // Top 5 Players
                const topPlayers = Object.entries(playerCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                document.getElementById('dashTopPlayers').innerHTML = topPlayers.map(([ player, count], index) => `
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(30, 144, 255, ${0.15 - index * 0.02}); border-radius: 6px;">
                        <span style="font-weight: bold;">${index + 1}. ${player}</span>
                        <span style="color: var(--cupboard-blue);">${count} card${count > 1 ? 's' : ''}</span>
                    </div>
                `).join('');

                // Top 5 Sets
                const topSets = Object.entries(setCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                document.getElementById('dashTopSets').innerHTML = topSets.map(([set, count], index) => `
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(138, 43, 226, ${0.15 - index * 0.02}); border-radius: 6px;">
                        <span style="font-weight: bold;">${index + 1}. ${set}</span>
                        <span style="color: var(--cupboard-purple);">${count} card${count > 1 ? 's' : ''}</span>
                    </div>
                `).join('');

                // Grading Breakdown - Sort by grade number (highest first), then by count
                const sortedGrades = Object.entries(gradingCounts)
                    .sort((a, b) => {
                        // Extract numeric grade from strings like "PSA 10", "BGS 9.5"
                        const gradeA = parseFloat(a[0].split(' ').pop());
                        const gradeB = parseFloat(b[0].split(' ').pop());
                        
                        // Sort by grade number (descending), then by count (descending) if grades are equal
                        if (gradeB !== gradeA) {
                            return gradeB - gradeA;
                        }
                        return b[1] - a[1];
                    });
                
                const totalGraded = gradedCount;
                document.getElementById('dashGradingBreakdown').innerHTML = sortedGrades.map(([grade, count]) => {
                    const percent = Math.round((count / totalGraded) * 100);
                    return `
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span>${grade}</span>
                                <span style="color: var(--cupboard-gold);">${count} (${percent}%)</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 8px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, var(--cupboard-gold), var(--cupboard-blue)); width: ${percent}%; height: 100%; border-radius: 10px;"></div>
                            </div>
                        </div>
                    `;
                }).join('') + `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 6px; text-align: center;">
                        <span style="color: rgba(255,255,255,0.6);">Raw/Ungraded: </span>
                        <span style="color: var(--cupboard-gold); font-weight: bold;">${data.length - gradedCount}</span>
                    </div>
                `;

                // Card Types
                document.getElementById('dashCardTypes').innerHTML = `
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(255, 215, 0, 0.15); border-radius: 6px;">
                        <span>‚≠ê Rookie Cards</span>
                        <span style="color: var(--cupboard-gold); font-weight: bold;">${rookieCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(138, 43, 226, 0.15); border-radius: 6px;">
                        <span>‚úçÔ∏è Autographs</span>
                        <span style="color: var(--cupboard-purple); font-weight: bold;">${autoCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(30, 144, 255, 0.15); border-radius: 6px;">
                        <span>üìÑ Base/Other</span>
                        <span style="color: var(--cupboard-blue); font-weight: bold;">${baseCount}</span>
                    </div>
                `;

                // Top 5 Most Valuable Cards
                const topCards = cardsByValue
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 5);
                
                document.getElementById('dashTopCards').innerHTML = topCards.map((card, index) => `
                    <div style="background: linear-gradient(135deg, rgba(0, 255, 127, ${0.15 - index * 0.02}), rgba(34, 139, 34, ${0.1 - index * 0.02})); border: 1px solid rgba(0, 255, 127, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.8rem; color: #00FF7F; font-weight: bold; margin-bottom: 0.5rem;">$${card.value.toLocaleString()}</div>
                        <div style="font-weight: bold; color: var(--cupboard-blue); margin-bottom: 0.25rem;">${card.player}</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${card.year} ${card.set}</div>
                    </div>
                `).join('');

                // Generate Collection Growth Timeline
                generateGrowthTimeline(data);

                // Check for newly unlocked achievements
                checkAchievements();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                loading.style.display = 'none';
            }
        }

        // Show timeline tooltip
        function showTimelineTooltip(event, element) {
            const tooltip = document.getElementById('timelineTooltip');
            if (!tooltip) return;
            
            const date = element.getAttribute('data-date');
            const value = element.getAttribute('data-value');
            const count = element.getAttribute('data-count');
            const portfolio = element.getAttribute('data-portfolio');
            const score = element.getAttribute('data-score');
            
            // Get current view to show only relevant data
            const currentView = window.currentTimelineView || 'value';
            
            let contentHTML = '';
            
            if (currentView === 'value') {
                // Portfolio Value view
                contentHTML = `
                    <div style="display: flex; justify-content: space-between; gap: 1.5rem;">
                        <span style="color: rgba(255,255,255,0.7);">üí∞ Portfolio Value:</span>
                        <span style="color: #00FF7F; font-weight: bold;">${portfolio}</span>
                    </div>
                `;
            } else if (currentView === 'cards') {
                // Card Count view
                contentHTML = `
                    <div style="display: flex; justify-content: space-between; gap: 1.5rem;">
                        <span style="color: rgba(255,255,255,0.7);">üì¶ Total Cards:</span>
                        <span style="color: var(--cupboard-blue); font-weight: bold;">${count}</span>
                    </div>
                `;
            } else if (currentView === 'score') {
                // Collector Score view
                contentHTML = `
                    <div style="display: flex; justify-content: space-between; gap: 1.5rem;">
                        <span style="color: rgba(255,255,255,0.7);">‚≠ê Collector Score:</span>
                        <span style="color: var(--cupboard-gold); font-weight: bold;">${score}</span>
                    </div>
                `;
            }
            
            tooltip.innerHTML = `
                <div style="font-weight: bold; color: var(--cupboard-gold); margin-bottom: 0.5rem; font-size: 0.9rem;">${date}</div>
                <div style="font-size: 0.85rem;">
                    ${contentHTML}
                </div>
            `;
            
            // Position tooltip near the mouse
            const rect = element.getBoundingClientRect();
            const chartRect = document.getElementById('timelineChart').getBoundingClientRect();
            
            tooltip.style.display = 'block';
            tooltip.style.left = (rect.left - chartRect.left + 15) + 'px';
            tooltip.style.top = (rect.top - chartRect.top - tooltip.offsetHeight - 10) + 'px';
        }

        // Hide timeline tooltip
        function hideTimelineTooltip() {
            const tooltip = document.getElementById('timelineTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        // Refresh Dashboard Timeline (for live updates)
        async function refreshDashboardTimeline() {
            // Only refresh if we're currently on the dashboard tab
            const dashboardTab = document.getElementById('dashboardTab');
            if (!dashboardTab || !dashboardTab.classList.contains('active')) {
                console.log('Dashboard not active, skipping timeline refresh');
                return;
            }

            console.log('Refreshing dashboard timeline...');
            
            try {
                // Fetch fresh data
                const { data, error } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        )
                    `)
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                if (!data || data.length === 0) {
                    console.log('No cards to display in timeline');
                    return;
                }

                // Store the current view before regenerating
                const currentView = window.currentTimelineView || 'value';
                
                console.log('Regenerating timeline with', data.length, 'cards');
                
                // Regenerate timeline with fresh data
                generateGrowthTimeline(data);
                
                // Switch back to the view that was active
                if (currentView !== 'value') {
                    console.log('Switching back to view:', currentView);
                    setTimeout(() => {
                        switchTimelineView(currentView);
                    }, 100);
                }
                
                // Also update the key stats cards
                let totalValue = 0;
                let totalScore = 0;
                let gradedCount = 0;

                data.forEach(item => {
                    totalValue += (item.purchase_price || 0);
                    totalScore += calculateCollectorScore(item);
                    if (item.grading_company) gradedCount++;
                });

                // Update dashboard stats
                document.getElementById('dashTotalValue').textContent = '$' + totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('dashCollectorScore').textContent = totalScore.toLocaleString();
                document.getElementById('dashTotalCards').textContent = data.length;
                document.getElementById('dashAvgValue').textContent = '$' + (totalValue / data.length).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('dashGradedPercent').textContent = Math.round((gradedCount / data.length) * 100) + '% graded';

                console.log('Dashboard timeline refreshed successfully!');

            } catch (error) {
                console.error('Error refreshing dashboard timeline:', error);
            }
        }

        // Generate Growth Timeline
        function generateGrowthTimeline(cards) {
            const timeline = document.getElementById('growthTimeline');
            
            if (!cards || cards.length === 0) {
                timeline.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 3rem;">No data available yet. Add cards to see your growth!</div>';
                return;
            }

            // Sort cards by date added
            const sortedCards = [...cards].sort((a, b) => new Date(a.added_at) - new Date(b.added_at));
            
            // Group by day (changed from month for better granularity)
            const dailyData = {};
            sortedCards.forEach(card => {
                const date = new Date(card.added_at);
                const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                if (!dailyData[dayKey]) {
                    dailyData[dayKey] = {
                        count: 0,
                        value: 0,
                        score: 0,
                        date: date
                    };
                }
                
                dailyData[dayKey].count++;
                dailyData[dayKey].value += (card.purchase_price || 0);
                dailyData[dayKey].score += calculateCollectorScore(card);
            });

            // Convert to cumulative data points
            const days = Object.keys(dailyData).sort();
            const dataPoints = [];
            let cumulativeCount = 0;
            let cumulativeValue = 0;
            let cumulativeScore = 0;

            days.forEach(day => {
                cumulativeCount += dailyData[day].count;
                cumulativeValue += dailyData[day].value;
                cumulativeScore += dailyData[day].score;
                
                dataPoints.push({
                    day: day,
                    date: dailyData[day].date,
                    count: cumulativeCount,
                    value: cumulativeValue,
                    score: cumulativeScore
                });
            });

            // Generate timeline HTML
            const maxValue = Math.max(...dataPoints.map(d => d.value));
            const maxCount = Math.max(...dataPoints.map(d => d.count));
            const maxScore = Math.max(...dataPoints.map(d => d.score));

            timeline.innerHTML = `
                <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                    <button id="timelineValue" onclick="switchTimelineView('value')" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, rgba(0, 255, 127, 0.3), rgba(34, 139, 34, 0.3)); border: 2px solid #00FF7F; border-radius: 8px; color: #fff; cursor: pointer; font-family: 'Outfit', sans-serif; font-weight: bold; transition: all 0.3s;">
                        üí∞ Portfolio Value
                    </button>
                    <button id="timelineCards" onclick="switchTimelineView('cards')" style="flex: 1; padding: 0.75rem; background: rgba(30, 144, 255, 0.1); border: 2px solid rgba(30, 144, 255, 0.3); border-radius: 8px; color: #fff; cursor: pointer; font-family: 'Outfit', sans-serif; transition: all 0.3s;">
                        üì¶ Card Count
                    </button>
                    <button id="timelineScore" onclick="switchTimelineView('score')" style="flex: 1; padding: 0.75rem; background: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: #fff; cursor: pointer; font-family: 'Outfit', sans-serif; transition: all 0.3s;">
                        ‚≠ê Collector Score
                    </button>
                </div>
                <div id="timelineChart" style="position: relative; height: 250px; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <!-- Chart will be drawn here -->
                </div>
            `;

            // Store data globally for view switching
            window.timelineData = dataPoints;
            window.currentTimelineView = 'value';
            
            // Draw initial chart
            drawTimelineChart('value', dataPoints, maxValue);
        }

        // Switch timeline view
        function switchTimelineView(view) {
            // Store current view
            window.currentTimelineView = view;
            
            const buttons = ['timelineValue', 'timelineCards', 'timelineScore'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btnId === 'timeline' + view.charAt(0).toUpperCase() + view.slice(1) || 
                    (view === 'value' && btnId === 'timelineValue') ||
                    (view === 'cards' && btnId === 'timelineCards') ||
                    (view === 'score' && btnId === 'timelineScore')) {
                    if (view === 'value') {
                        btn.style.background = 'linear-gradient(135deg, rgba(0, 255, 127, 0.3), rgba(34, 139, 34, 0.3))';
                        btn.style.borderColor = '#00FF7F';
                    } else if (view === 'cards') {
                        btn.style.background = 'linear-gradient(135deg, rgba(30, 144, 255, 0.3), rgba(65, 105, 225, 0.3))';
                        btn.style.borderColor = 'var(--cupboard-blue)';
                    } else {
                        btn.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(212, 175, 55, 0.3))';
                        btn.style.borderColor = 'var(--cupboard-gold)';
                    }
                } else {
                    btn.style.background = 'rgba(255,255,255,0.05)';
                    btn.style.borderColor = 'rgba(255,255,255,0.1)';
                }
            });

            // Map view names to actual data field names
            const fieldMap = {
                'value': 'value',
                'cards': 'count',
                'score': 'score'
            };
            
            const dataField = fieldMap[view];
            const maxVal = Math.max(...window.timelineData.map(d => d[dataField]));
            drawTimelineChart(view, window.timelineData, maxVal);
        }

        // Draw timeline chart
        function drawTimelineChart(view, dataPoints, maxValue) {
            const chart = document.getElementById('timelineChart');
            const width = chart.clientWidth - 32;
            const height = 220;

            const viewConfig = {
                value: { color: '#00FF7F', label: 'Portfolio Value', format: (v) => '$' + v.toLocaleString(), field: 'value' },
                cards: { color: 'var(--cupboard-blue)', label: 'Total Cards', format: (v) => v.toString(), field: 'count' },
                score: { color: 'var(--cupboard-gold)', label: 'Collector Score', format: (v) => v.toLocaleString() + ' pts', field: 'score' }
            };

            const config = viewConfig[view];
            const dataField = config.field; // Get the actual data field name
            
            // Generate SVG path
            const points = dataPoints.map((d, i) => {
                const x = (i / (dataPoints.length - 1)) * width;
                const y = height - ((d[dataField] / maxValue) * height);
                return `${x},${y}`;
            });

            const pathD = points.length > 0 ? `M ${points.join(' L ')}` : '';
            const areaD = points.length > 0 ? `M 0,${height} L ${points.join(' L ')} L ${width},${height} Z` : '';

            chart.innerHTML = `
                <svg width="${width}" height="${height}" style="position: absolute; left: 16px; top: 16px;">
                    <!-- Grid lines -->
                    ${[0, 0.25, 0.5, 0.75, 1].map(pct => `
                        <line x1="0" y1="${height * pct}" x2="${width}" y2="${height * pct}" 
                              stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
                    `).join('')}
                    
                    <!-- Area fill -->
                    <path d="${areaD}" fill="${config.color}" fill-opacity="0.1"/>
                    
                    <!-- Line -->
                    <path d="${pathD}" fill="none" stroke="${config.color}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    
                    <!-- Data points -->
                    ${dataPoints.map((d, i) => {
                        const x = (i / (dataPoints.length - 1)) * width;
                        const y = height - ((d[dataField] / maxValue) * height);
                        return `
                            <circle 
                                cx="${x}" 
                                cy="${y}" 
                                r="5" 
                                fill="${config.color}" 
                                stroke="rgba(0,0,0,0.5)" 
                                stroke-width="2"
                                class="timeline-dot"
                                data-date="${new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}"
                                data-value="${config.format(d[dataField])}"
                                data-count="${d.count}"
                                data-portfolio="${'$' + d.value.toLocaleString()}"
                                data-score="${d.score.toLocaleString() + ' pts'}"
                                onmouseover="showTimelineTooltip(event, this)"
                                onmouseout="hideTimelineTooltip()"
                                style="cursor: pointer; transition: r 0.2s;"
                                onmouseover="this.setAttribute('r', '8'); showTimelineTooltip(event, this)"
                                onmouseout="this.setAttribute('r', '5'); hideTimelineTooltip()">
                            </circle>
                        `;
                    }).join('')}
                </svg>
                
                <!-- Tooltip -->
                <div id="timelineTooltip" style="position: absolute; display: none; background: rgba(0, 0, 0, 0.95); border: 2px solid ${config.color}; border-radius: 8px; padding: 0.75rem; pointer-events: none; z-index: 1000; min-width: 180px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <!-- Content filled by JS -->
                </div>
                
                <!-- Current value display -->
                <div style="position: absolute; top: 1rem; right: 1rem; text-align: right;">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Current</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: ${config.color};">
                        ${config.format(dataPoints[dataPoints.length - 1][dataField])}
                    </div>
                </div>
                
                <!-- Month labels -->
                <div style="position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-between; padding: 0 16px; font-size: 0.75rem; color: rgba(255,255,255,0.4);">
                    <span>${new Date(dataPoints[0].date).toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}</span>
                    <span>${new Date(dataPoints[dataPoints.length - 1].date).toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}</span>
                </div>
            `;
        }

        // Load folders into add card form dropdown
        async function loadFoldersIntoAddForm() {
            try {
                const { data, error } = await supabase
                    .from('folders')
                    .select('*')
                    .eq('auth_user_id', currentUser.id)
                    .order('folder_name');

                if (error) throw error;

                const cardFolderSelect = document.getElementById('cardFolder');
                
                if (!data || data.length === 0) {
                    cardFolderSelect.innerHTML = '<option value="">No Folder</option>';
                    return;
                }

                // Populate dropdown
                cardFolderSelect.innerHTML = `
                    <option value="">No Folder</option>
                    ${data.map(folder => `<option value="${folder.folder_id}">${folder.folder_name}</option>`).join('')}
                `;

            } catch (error) {
                console.error('Error loading folders into form:', error);
            }
        }

        // FOLDER MANAGEMENT FUNCTIONS
        
        // Show folder manager modal
        function showFolderManager() {
            document.getElementById('folderManagerModal').classList.add('active');
            loadFolders();
        }
        
        // Close folder manager
        function closeFolderManager() {
            document.getElementById('folderManagerModal').classList.remove('active');
            document.getElementById('newFolderName').value = '';
            document.getElementById('folderAlert').innerHTML = '';
        }
        
        // Load all folders
        async function loadFolders() {
            try {
                const { data, error } = await supabase
                    .from('folders')
                    .select('*')
                    .eq('auth_user_id', currentUser.id)
                    .order('folder_name');

                if (error) throw error;

                const folderList = document.getElementById('folderList');
                const folderFilter = document.getElementById('folderFilter');
                
                if (!data || data.length === 0) {
                    folderList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem;">No folders yet. Create one above!</div>';
                    
                    // Reset filter to default options
                    folderFilter.innerHTML = `
                        <option value="all">All Cards</option>
                        <option value="none">üìÇ No Folder</option>
                    `;
                    return;
                }

                // Update folder list in modal
                folderList.innerHTML = data.map(folder => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(138, 43, 226, 0.1); border: 2px solid var(--cupboard-purple); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üìÅ</span>
                            <span style="font-weight: bold; color: var(--cupboard-purple);">${folder.folder_name}</span>
                        </div>
                        <button onclick="deleteFolder('${folder.folder_id}')" style="padding: 0.5rem 1rem; background: rgba(255, 68, 68, 0.2); border: 2px solid #ff4444; border-radius: 6px; color: #ff4444; cursor: pointer; font-family: 'Outfit', sans-serif; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(255, 68, 68, 0.2)'">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `).join('');

                // Update folder filter dropdown
                folderFilter.innerHTML = `
                    <option value="all">All Cards</option>
                    <option value="none">üìÇ No Folder</option>
                    ${data.map(folder => `<option value="${folder.folder_id}">${folder.folder_name}</option>`).join('')}
                `;

            } catch (error) {
                console.error('Error loading folders:', error);
                document.getElementById('folderAlert').innerHTML = `<div class="alert alert-error">‚ùå Error loading folders</div>`;
            }
        }
        
        // Create new folder
        async function createFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();
            const alertDiv = document.getElementById('folderAlert');
            
            if (!folderName) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Please enter a folder name</div>';
                return;
            }

            try {
                const { error } = await supabase
                    .from('folders')
                    .insert({
                        auth_user_id: currentUser.id,
                        folder_name: folderName
                    });

                if (error) throw error;

                alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Folder created successfully!</div>';
                document.getElementById('newFolderName').value = '';
                
                // Reload folders
                setTimeout(() => {
                    loadFolders();
                    alertDiv.innerHTML = '';
                }, 1500);

            } catch (error) {
                console.error('Error creating folder:', error);
                alertDiv.innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Delete folder
        async function deleteFolder(folderId) {
            if (!confirm('Delete this folder? Cards in this folder will not be deleted, just uncategorized.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('folders')
                    .delete()
                    .eq('folder_id', folderId);

                if (error) throw error;

                document.getElementById('folderAlert').innerHTML = '<div class="alert alert-success">‚úÖ Folder deleted!</div>';
                
                setTimeout(() => {
                    loadFolders();
                    loadCollection(); // Refresh collection view
                    document.getElementById('folderAlert').innerHTML = '';
                }, 1500);

            } catch (error) {
                console.error('Error deleting folder:', error);
                document.getElementById('folderAlert').innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto-refresh timer - checks every minute for new day
        let lastCheckDate = new Date().toDateString();
        
        function checkForNewDay() {
            const currentDate = new Date().toDateString();
            
            if (currentDate !== lastCheckDate) {
                console.log('New day detected! Refreshing dashboard...');
                lastCheckDate = currentDate;
                
                // Only refresh if dashboard tab is active
                const dashboardTab = document.getElementById('dashboardTab');
                if (dashboardTab && dashboardTab.classList.contains('active')) {
                    console.log('Dashboard active, refreshing timeline...');
                    refreshDashboardTimeline();
                } else {
                    console.log('Dashboard not active, will refresh on next visit');
                }
            }
        }
        
        // Check every minute (60000ms)
        setInterval(checkForNewDay, 60000);
        console.log('Auto-refresh timer started - checking for new day every minute');

        // Global Search Function
        let globalSearchTimeout;
        let globalSearchResults = []; // Store filtered results
        
        async function globalSearchCards(searchTerm) {
            clearTimeout(globalSearchTimeout);
            
            const resultsDiv = document.getElementById('searchResults');
            
            if (!searchTerm || searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            globalSearchTimeout = setTimeout(async () => {
                try {
                    const { data, error } = await supabase
                        .from('my_collection')
                        .select(`
                            *,
                            cards (
                                *,
                                players (*),
                                card_sets (
                                    *,
                                    manufacturers (*)
                                )
                            ),
                            card_images (*)
                        `)
                        .eq('auth_user_id', currentUser.id);

                    if (error) throw error;

                    const searchLower = searchTerm.toLowerCase();
                    const filtered = data.filter(item => {
                        const player = item.cards?.players;
                        const playerName = player ? `${player.first_name} ${player.last_name}`.toLowerCase() : '';
                        const set = item.cards?.card_sets;
                        const setName = set ? `${set.year} ${set.manufacturers?.name} ${set.set_name}`.toLowerCase() : '';
                        const cardNum = (item.card_number_override || item.cards?.card_number || '').toLowerCase();
                        
                        return playerName.includes(searchLower) || 
                               setName.includes(searchLower) || 
                               cardNum.includes(searchLower);
                    });
                    
                    // Store for access when clicking
                    globalSearchResults = filtered.slice(0, 8);

                    if (filtered.length === 0) {
                        resultsDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: rgba(255,255,255,0.5);">No cards found</div>';
                        resultsDiv.style.display = 'block';
                        return;
                    }

                    resultsDiv.innerHTML = filtered.slice(0, 8).map((item, idx) => {
                        const player = item.cards?.players;
                        const playerName = player ? `${player.first_name} ${player.last_name}` : 'Unknown';
                        const set = item.cards?.card_sets;
                        const setName = set ? `${set.year} ${set.manufacturers?.name} ${set.set_name}` : '';
                        const cardNum = item.card_number_override || item.cards?.card_number || '';
                        const score = calculateCollectorScore(item);
                        
                        return `
                            <div onclick="showCardFromSearchByIndex(${idx}); document.getElementById('searchResults').style.display='none'; document.getElementById('globalSearch').value='';" 
                                 style="padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s;"
                                 onmouseover="this.style.background='rgba(30, 144, 255, 0.2)'"
                                 onmouseout="this.style.background='transparent'">
                                <div style="font-weight: bold; color: var(--cupboard-blue);">${playerName}</div>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.25rem;">${setName} ${cardNum}</div>
                                <div style="font-size: 0.8rem; color: var(--cupboard-gold); margin-top: 0.25rem;">‚≠ê ${score.toLocaleString()} pts</div>
                            </div>
                        `;
                    }).join('') + (filtered.length > 8 ? `<div style="padding: 0.75rem 1rem; text-align: center; color: rgba(255,255,255,0.5); font-size: 0.85rem;">+${filtered.length - 8} more results</div>` : '');
                    
                    resultsDiv.style.display = 'block';

                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        }

        // Show card from search by index
        function showCardFromSearchByIndex(index) {
            console.log('Loading card from search results, index:', index);
            
            const item = globalSearchResults[index];
            if (!item) {
                console.error('No card found at index:', index);
                return;
            }
            
            console.log('Card data:', item);
            showCardDetails(item);
        }

        // Old function - keeping for backward compatibility but simplified
        async function showCardFromSearch(cardId) {
            console.log('Loading card from search, ID:', cardId);
            
            try {
                const { data, error } = await supabase
                    .from('my_collection')
                    .select(`
                        *,
                        cards (
                            *,
                            players (*),
                            card_sets (
                                *,
                                manufacturers (*)
                            )
                        ),
                        card_images (*)
                    `)
                    .eq('id', cardId)
                    .single();

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                if (!data) {
                    console.error('No data returned for card ID:', cardId);
                    throw new Error('Card not found');
                }
                
                console.log('Card data loaded successfully:', data);
                
                // Directly show the card modal
                showCardDetails(data);

            } catch (error) {
                console.error('Error loading card:', error);
                console.error('Error details:', error.message, error.code);
            }
        }

        // Refresh Current View
        async function refreshCurrentView() {
            const btn = document.getElementById('refreshBtn');
            
            // Add spinning animation
            btn.style.transform = 'rotate(360deg)';
            btn.style.transition = 'transform 0.6s ease-in-out';
            
            // Reset rotation after animation
            setTimeout(() => {
                btn.style.transform = 'rotate(0deg)';
                btn.style.transition = 'transform 0s';
            }, 600);

            // Determine which tab is active and refresh it
            if (document.getElementById('dashboardTab').classList.contains('active')) {
                await loadDashboard();
            } else if (document.getElementById('collectionTab').classList.contains('active')) {
                await updateArchiveButtonCount();
                await loadCollection();
            } else if (document.getElementById('scoresTab').classList.contains('active')) {
                await loadCollectorScores();
            } else if (document.getElementById('salesTab').classList.contains('active')) {
                await loadSalesHistory();
            } else if (document.getElementById('leaderboardTab').classList.contains('active')) {
                await loadLeaderboard();
            }

            // Show success feedback
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 1000);
        }

        // Toggle User Menu
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenu');
            const btn = document.getElementById('userMenuBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const results = document.getElementById('searchResults');
            const search = document.getElementById('globalSearch');
            if (results && search && !results.contains(e.target) && !search.contains(e.target)) {
                results.style.display = 'none';
            }
        });

        // Load user info into header
        async function loadHeaderUserInfo() {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('username, display_name')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                if (data) {
                    const displayName = data.display_name || data.username || 'User';
                    document.getElementById('headerUsername').textContent = `üë§ ${displayName}`;
                    document.getElementById('menuUsername').textContent = displayName;
                }
                
                document.getElementById('menuEmail').textContent = currentUser.email;

            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Account Settings Functions
        async function loadAccountSettings() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                if (error) throw error;

                if (data) {
                    document.getElementById('settingsUsername').value = data.username || '';
                    document.getElementById('settingsDisplayName').value = data.display_name || '';
                    document.getElementById('settingsEmail').value = currentUser.email || '';
                    document.getElementById('settingsShareStats').checked = data.share_stats || false;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save Profile Settings
        document.getElementById('settingsProfileForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const alertDiv = document.getElementById('settingsProfileAlert');
            alertDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const username = document.getElementById('settingsUsername').value.trim();
                const displayName = document.getElementById('settingsDisplayName').value.trim();

                // Validate username format
                if (!username || username.length < 3) {
                    throw new Error('Username must be at least 3 characters long');
                }

                if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                    throw new Error('Username can only contain letters, numbers, underscores, and hyphens. Use Display Name for spaces and special characters.');
                }

                // Check for profanity in username
                if (containsProfanity(username)) {
                    throw new Error('Username contains inappropriate language. Please choose a different username.');
                }

                // Check for profanity in display name
                if (displayName && containsProfanity(displayName)) {
                    throw new Error('Display name contains inappropriate language. Please choose a different display name.');
                }

                // Check if username is already taken (by someone else)
                const { data: usernameCheck, error: usernameError } = await supabase
                    .from('user_profiles')
                    .select('auth_user_id')
                    .eq('username', username)
                    .neq('auth_user_id', currentUser.id)
                    .maybeSingle();

                // Only throw error if we found a match (not if query had an error finding nothing)
                if (usernameCheck) {
                    throw new Error('Username is already taken. Please choose a different one.');
                }

                // Check if display name is already taken (by someone else)
                if (displayName) {
                    const { data: displayNameCheck, error: displayNameError } = await supabase
                        .from('user_profiles')
                        .select('auth_user_id')
                        .eq('display_name', displayName)
                        .neq('auth_user_id', currentUser.id)
                        .maybeSingle();

                    // Only throw error if we found a match
                    if (displayNameCheck) {
                        throw new Error('Display name is already taken. Please choose a different one.');
                    }
                }

                // Update profile
                const { error } = await supabase
                    .from('user_profiles')
                    .update({
                        username: username,
                        display_name: displayName || null
                    })
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Profile updated successfully!</div>';
                
                // Update header display name
                loadHeaderUserInfo();
                
                setTimeout(() => {
                    alertDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error updating profile:', error);
                alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${error.message}</div>`;
            }
        });

        // Save Privacy Settings
        // Enable Stats Sharing (Quick Join Leaderboard)
        async function enableStatsSharing() {
            try {
                const confirmed = confirm(
                    'üèÜ JOIN THE LEADERBOARD\n\n' +
                    'This will make your collection stats visible to other users on the leaderboard.\n\n' +
                    '‚úÖ What will be shown:\n' +
                    '‚Ä¢ Your username\n' +
                    '‚Ä¢ Total collection score\n' +
                    '‚Ä¢ Number of cards\n' +
                    '‚Ä¢ Your visible badges\n\n' +
                    'üîí What stays private:\n' +
                    '‚Ä¢ Your specific cards (unless they click to view)\n' +
                    '‚Ä¢ Your email and personal info\n\n' +
                    'You can disable this anytime in Account Settings.\n\n' +
                    'Ready to join the leaderboard?'
                );

                if (!confirmed) return;

                // Show loading
                const banner = document.getElementById('joinLeaderboardBanner');
                if (banner) {
                    banner.innerHTML = '<div class="loading"><div class="spinner"></div><p>Joining leaderboard...</p></div>';
                }

                const { error } = await supabase
                    .from('user_profiles')
                    .update({ share_stats: true })
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                // Show success message
                showToast('üéâ Welcome to the leaderboard! Your stats are now visible to other collectors!', 'success');

                // Reload leaderboard to show user
                await loadLeaderboard();

            } catch (error) {
                console.error('Error enabling stats sharing:', error);
                alert('‚ùå Error joining leaderboard: ' + error.message);
                // Reload to reset UI
                await loadLeaderboard();
            }
        }

        async function savePrivacySettings() {
            const shareStats = document.getElementById('settingsShareStats').checked;

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ share_stats: shareStats })
                    .eq('auth_user_id', currentUser.id);

                if (error) throw error;

                alert('‚úÖ Privacy settings updated!');
                loadLeaderboard(); // Refresh leaderboard

            } catch (error) {
                console.error('Error updating privacy settings:', error);
                alert('‚ùå Error updating settings: ' + error.message);
            }
        }

        // Confirm Delete Account
        function confirmDeleteAccount() {
            const confirmed = confirm(
                '‚ö†Ô∏è WARNING: This will permanently delete your account and ALL your data including:\n\n' +
                '‚Ä¢ All your cards\n' +
                '‚Ä¢ All your sales records\n' +
                '‚Ä¢ Your profile information\n' +
                '‚Ä¢ All uploaded images\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Type "DELETE" in the next prompt to confirm.'
            );

            if (!confirmed) return;

            const confirmText = prompt('Type DELETE to confirm account deletion:');
            
            if (confirmText === 'DELETE') {
                deleteAccount();
            } else {
                alert('Account deletion cancelled.');
            }
        }

        // Delete Account
        async function deleteAccount() {
            try {
                // Delete all user data
                await supabase.from('my_collection').delete().eq('auth_user_id', currentUser.id);
                await supabase.from('recent_sales').delete().eq('auth_user_id', currentUser.id);
                await supabase.from('user_profiles').delete().eq('auth_user_id', currentUser.id);
                
                // Sign out
                await supabase.auth.signOut();
                
                alert('‚úÖ Account deleted successfully. You will now be logged out.');
                location.reload();
                
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('‚ùå Error deleting account. Please contact support.');
            }
        }
    </script>
</body>
</html>